(function(){"use strict";const U=(t,e)=>{const r=[];for(let n=0;n<e.length;n++){let l=0;for(let i=0;i<e[0].length;i++)l+=e[n][i]*t[i];r.push(l)}return r},W=t=>new Array(t).fill().map((e,r)=>new Array(t).fill().map((n,l)=>r===l?1:0)),E=t=>{const e=t.length,r=[];for(let n=0;n<e;n++)r.push([...t[n],...W(e)[n]]);for(let n=0;n<e;n++){const l=r[n][n];for(let i=n+1;i<e;i++){const s=r[i][n]/l;for(let o=n;o<2*e;o++)r[i][o]-=s*r[n][o]}}for(let n=e-1;n>=0;n--){const l=r[n][n];for(let i=n-1;i>=0;i--){const s=r[i][n]/l;for(let o=0;o<2*e;o++)r[i][o]-=s*r[n][o]}for(let i=e;i<2*e;i++)r[n][i]/=l}return r.map(n=>n.slice(e))},D=(t,e,r)=>{let n=0;for(let l=0;l<t.length;l++)n+=t[l]*e[l]*(l===t.length-1&&r||1);return n},G=(t,e)=>D(t,t,e),J=(t,e,r)=>{t=t.slice();const n=2*D(t,e,r);for(let l=0;l<t.length;l++)t[l]-=n*(r||l!==t.length-1?e[l]:0);return t},K=(t,e)=>{if(t=t.slice(),e===0){for(let n=0;n<t.length;n++)t[n]/=t[t.length-1];return t}const r=(e===-1&&Z(t[t.length-1])||1)/Y(S(G(t,e)));for(let n=0;n<t.length;n++)t[n]*=r;return t},Q=(t,e,r)=>{let n=t.map(o=>isNaN(o)?1:+o),l=e.slice(),i;for(let o=0;o<n.length&&(i=E(l),i.some(f=>f.some(d=>isNaN(d)||S(d)>1e8)));o++){console.warn("Non invertible matrix, retrying by shifting mirrors"),l.push(l.shift()),n.push(n.shift());if(o===n.length-1)return console.warn("Non invertible matrix, returning default value"),[0,0,1]}const s=U(n,i);return s[s.length-1]*=r||1,K(s,r)},C=(t,e,r,n)=>{const l=N/t,i=N/e,s=N/r;return F(N/X(-x(l)*x(s)+H(l)*H(s)*((x(i)-x(n*l)*x(s))/(H(n*l)*H(s)))))},{abs:S,cos:x,sin:H,tan:fe,cosh:he,sinh:ce,acos:X,acosh:ge,atan:ue,min:pe,max:me,round:F,sqrt:Y,sign:Z,ceil:de,floor:ye,log:be,exp:Ae,PI:N}=Math,O=new ArrayBuffer(8),v=new Float64Array(O),R=new Int32Array(O);function z(t){return~~t===t?~~t:(v[0]=t,R[0]^R[1])}const q=10**4,ee=t=>{let e="";for(let r=0;r<t.length;r++)e+=z(F(t[r]*q)/q).toString(),r<t.length-1&&(e+="|");return e};function*te(t,e){if(e<0||t.length<e)return;const r=Array.from(Array(e).keys());for(;;){yield r.map(l=>t[l]);let n=e-1;for(;n>=0&&r[n]>=t.length-e+n;)n--;if(n<0)return;for(let l=r[n]+1;n<e;n++,l++)r[n]=l}}const L=(t,e=2)=>Array.from(te(t,e)),u=t=>String.fromCharCode(97+t),ne=(t,e,r,n,l)=>{const i=[];for(let s=0;s<t;s++)i.push(u(s).repeat(2));for(let s=1;s<t;s++)for(let o=0;o<s;o++)e[s][o]<1/0&&i.push((u(o)+u(s)).repeat(e[s][o]));if(r&&!r.every(s=>s.every(o=>o===1))&&l>0){if(t===4&&(r[0][1]>1||r[2][3]>1)&&e[0][1]>3&&e[2][3]>3)r[0][1]>1&&i.push("abcdcb".repeat(C(e[0][1],e[1][2],e[0][2],r[0][1]))),r[2][3]>1&&i.push("abcdcb".repeat(C(e[2][3],e[1][2],e[1][3],r[2][3])));else for(let s=1;s<t;s++)for(let o=0;o<s;o++)if(r[o][s]>1){if(o+2<t){const f=C(e[o][s],e[o+1][s+1],e[o][s+1],r[o][s]);i.push((u(o)+u(s)+u(o+2)+u(s)).repeat(f))}if(o-1>=0){const f=C(e[o][s],e[o-1][s-1],e[o-1][s],r[o][s]);i.push((u(o)+u(s)+u(o)+u(o-1)).repeat(f))}}}return i},re=(t,e,r,n,l)=>{const i=ne(t,e,r,n,l),s=[...Array(t).keys()].map(f=>u(f)).join(""),o=n.map((f,d)=>f?"":u(S(d))).join("");return{gens:s,subgens:o,rels:i}},le=(t,e)=>{if(e.left===e.right)return!1;for(;e.left!==e.right;){const r=t.normal[e.left_coset][e.rel[e.left]];if(r===void 0)break;e.left++,e.left_coset=r}for(;e.left!==e.right;){const r=t.reverse[e.right_target][e.rel[e.right]];if(r===void 0)break;e.right--,e.right_target=r}return e.left===e.right?(t.normal[e.left_coset][e.rel[e.right]]=e.right_target,t.reverse[e.right_target][e.rel[e.right]]=e.left_coset,!0):!1},se=t=>{const{gens:e,subgens:r,rels:n,cosets:l,rows:i,words:s,limit:o}=t,f=e.length,d=n.map(a=>[...a].map(y=>e.indexOf(y))),k=r.split("").map(a=>e.indexOf(a));if(l.normal.length===0){l.normal.push(new Array(f).fill()),l.reverse.push(new Array(f).fill());for(let a=0;a<k.length;a++)l.normal[0][k[a]]=0,l.reverse[0][k[a]]=0}for(i.length===0&&i.push(...d.map(a=>({rel:a,left:0,right:a.length-1,left_coset:0,right_target:0})));i.length&&l.normal.length<o;){for(;;){let h=!1;for(let c=i.length-1;c>=0;c--)le(l,i[c])&&(h=!0,i.splice(c,1));if(!h)break}const a=l.normal.length;let y=!1;for(let h=0;h<l.normal.length;h++){const c=l.normal[h];for(let m=0;m<c.length;m++){let g=c[m];if(g===void 0){g=l.normal.length,l.normal.push(new Array(f).fill()),l.reverse.push(new Array(f).fill()),l.normal[h][m]=g,l.reverse[g][m]=h,i.push(...d.map(b=>({rel:b,left:0,right:b.length-1,left_coset:a,right_target:a}))),y=!0;break}}if(y)break}}i.length||(t.done=!0),s.length===0&&(s[0]="");let j=!0,p=l.normal.length;for(;ie(l.normal.length,s)&&j&&--p;){j=!1;for(let a=0;a<s.length;a++){if(s[a]===void 0)continue;const y=l.normal[a];for(let h=0;h<y.length;h++){const c=y[h];c===void 0||s[c]!==void 0||(s[c]=s[a]+u(h),j=!0)}}}return j||console.warn("Hole in the cosets"),p===0&&console.warn("Max iterations reached"),{cosets:l,rows:i,words:s}},ie=(t,e)=>{for(let r=0;r<t;r++)if(e[r]===void 0)return!0;return!1};let _=null,V=null,P=null,B=null,M=null,$=0;const oe=(t,e,r,n,l,i)=>{const s=()=>({cosets:{normal:[],reverse:[]},rows:[],words:[],done:!1,lastDrawn:0});V=new Array(t).fill().map((o,f)=>Q(new Array(t).fill().map((d,k)=>k===f?1:0),l,i)),_={...re(t,e,r,new Array(t).fill(1),i),...s()},P=new Map,B=new Set,M=new Set,$=0},ae=(t,e)=>{const{rootVertex:r,mirrorsPlanes:n,curvature:l}=t;let i=r;for(let s=0;s<e.length;s++)i=J(i,n[e.charCodeAt(s)-97],l);return i};onmessage=({data:{order:t,curvature:e,mirrorsPlanes:r,coxeter:n,stellation:l,mirrors:i,rootVertex:s,dimensions:o,uuid:f}})=>{t===0&&oe(o,n,l,i,r,e);const d=t===0?1:(t+1)*10,k=L(new Array(V.length).fill().map((p,a)=>a)),j=L(new Array(V.length).fill().map((p,a)=>a),3);try{let p=[],a=[],y=[];if(!_.done){_.limit=d,se(_);for(let h=_.lastDrawn;h<_.words.length;h++){const c=_.words[h];if(c===void 0)continue;const m=[];for(let g=0;g<V.length;g++){const b=V[g],w=ae({rootVertex:b,mirrorsPlanes:r,curvature:e},c),A=ee(w);if(P.has(A))m.push(P.get(A));else{p.push({vertex:w,word:c,i:h});const I=$+p.length-1;P.set(A,I),m.push(I)}}_.lastDrawn=h+1;for(let g=0;g<k.length;g++){const[b,w]=k[g],[A,I]=[m[b],m[w]],T=b<w?`${A}-${I}`:`${I}-${A}`;B.has(T)||(a.push({start:A,end:I,word:c}),B.add(T))}for(let g=0;g<j.length;g++){const b=j[g].map(A=>m[A]),w=b.sort().join("-");M.has(w)||(y.push({vertices:b,word:c}),M.add(w))}}}$+=p.length,postMessage({vertices:p,edges:a,faces:y,order:t,uuid:f})}catch(p){postMessage({error:p.message,uuid:f})}}})();
