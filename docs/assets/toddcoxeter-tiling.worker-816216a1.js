(function(){"use strict";const k=t=>t!==""&&t!=="x",B=(t,e,n)=>{let l=0;for(let s=0;s<t.length;s++)l+=t[s]*e[s]*(s===t.length-1&&n||1);return l},F=(t,e,n)=>{t=t.slice();const l=2*B(t,e,n);for(let s=0;s<t.length;s++)t[s]-=l*(n||s!==t.length-1?e[s]:0);return t},R=(t,e,n,l)=>{const s=M/t,i=M/e,c=M/n;return L(M/H(-S(s)*S(c)+v(s)*v(c)*((S(i)-S(l*s)*S(c))/(v(l*s)*v(c)))))},{abs:ee,cos:S,sin:v,tan:te,cosh:ne,sinh:le,acos:H,acosh:se,atan:re,atan2:fe,min:oe,max:ae,round:L,sqrt:ce,sign:ie,ceil:ge,floor:he,log:ue,exp:de,hypot:pe,pow:be,PI:M}=Math;function*U(t,e){if(e<0||t.length<e)return;const n=Array.from(Array(e).keys());for(;;){yield n.map(s=>t[s]);let l=e-1;for(;l>=0&&n[l]>=t.length-e+l;)l--;if(l<0)return;for(let s=n[l]+1;l<e;l++,s++)n[l]=s}}const W=(t,e=2)=>Array.from(U(t,e)),b=t=>String.fromCharCode(97+t),J=t=>t.charCodeAt(0)-97,V=(t,e,n,l,s,i=[])=>{const c=[];for(let o=0;o<t;o++)k(l[o])&&!i.includes(o)&&c.push(b(o).repeat(2));for(let o=1;o<t;o++)for(let f=0;f<o;f++)!i.includes(o)&&!i.includes(f)&&e[o][f]>1&&k(l[o])&&k(l[f])&&c.push((b(f)+b(o)).repeat(e[o][f]));if(n&&!n.every(o=>o.every(f=>f===1))&&s>0){if(t===4&&(n[0][1]>1||n[2][3]>1)&&e[0][1]>3&&e[2][3]>3)n[0][1]>1&&c.push("abcdcb".repeat(R(e[0][1],e[1][2],e[0][2],n[0][1]))),n[2][3]>1&&c.push("abcdcb".repeat(R(e[2][3],e[1][2],e[1][3],n[2][3])));else for(let o=1;o<t;o++)for(let f=0;f<o;f++)if(n[f][o]>1){if(f+2<t){const m=R(e[f+1][o+1],e[f][o],e[f][o+1],n[f][o]);c.push((b(f)+b(o)+b(f+2)+b(o)).repeat(m))}if(f-1>=0){const m=R(e[f-1][o-1],e[f][o],e[f-1][o],n[f][o]);c.push((b(f)+b(o)+b(f)+b(f-1)).repeat(m))}}}return c},K=(t,e=null,n=1,l=!1)=>{if(e===null&&(e=t,t=0),n===0)throw new Error("Step cannot be zero.");if(e<t&&n>0||e>t&&n<0){if(l)return[];n=-n}return new Array(Math.ceil((e-t)/n)).fill().map((s,i)=>t+i*n)},I=(t,e=[])=>t.map((n,l)=>!e.includes(l)&&k(n)?b(l):"").join(""),N=(t,e=[])=>t.map((n,l)=>e.includes(l)||n||!k(n)?"":b(l)).join(""),Q=(t,e,n,l,s)=>{const i=V(t,e,n,l,s),c=I(l),o=N(l);return{gens:c,subgens:o,rels:i}},X=(t,e,n,l,s)=>{const i=V(t,e,n,l,s),c=I(l),o=[];for(let f=0;f<l.length;f++)if(l[f]){let m=b(f);for(let d=0;d<t;d++)e[f][d]===2&&!l[d]&&(m+=b(d));o.push({gens:c,subgens:m,rels:i,target:b(f)})}return o},Y=(t,e,n,l,s)=>{const i=V(t,e,n,l,s),c=I(l),o=[],f=W(K(t),t-2);for(let m=0;m<f.length;m++){const d=f[m],A=V(t,e,n,l,s,d);let j=I(l,d);const h=N(l,d),u=G({gens:j,subgens:h,rels:A,cosets:{normal:[],reverse:[]},rows:[],words:[],limit:1e3}).words;if(u.length>2){let r="";for(let a=0;a<t;a++)d.includes(a)||(r+=b(a));for(let a=0;a<t;a++)if(!l[a]){let g=!0;for(let p=0;p<t;p++)if(!d.includes(p)&&e[p][a]!==2){g=!1;break}g&&(r+=b(a))}o.push({gens:c,subgens:r,rels:i,face:u,double:l.filter((a,g)=>!d.includes(g)&&k(a)).every(a=>!!a)})}}return o},Z=(t,e)=>{if(e.left===e.right)return!1;for(;e.left!==e.right;){const n=t.normal[e.left_coset][e.rel[e.left]];if(n===void 0)break;e.left++,e.left_coset=n}for(;e.left!==e.right;){const n=t.reverse[e.right_target][e.rel[e.right]];if(n===void 0)break;e.right--,e.right_target=n}return e.left===e.right?(t.normal[e.left_coset][e.rel[e.right]]=e.right_target,t.reverse[e.right_target][e.rel[e.right]]=e.left_coset,!0):!1},G=t=>{const{gens:e,subgens:n,rels:l,cosets:s,rows:i,words:c,limit:o}=t,f=e.length,m=l.map(h=>[...h].map(u=>e.indexOf(u))),d=n.split("").map(h=>e.indexOf(h));if(s.normal.length===0){s.normal.push(new Array(f).fill()),s.reverse.push(new Array(f).fill());for(let h=0;h<d.length;h++)s.normal[0][d[h]]=0,s.reverse[0][d[h]]=0}for(i.length===0&&i.push(...m.map(h=>({rel:h,left:0,right:h.length-1,left_coset:0,right_target:0})));i.length&&s.normal.length<o;){for(;;){let r=!1;for(let a=i.length-1;a>=0;a--)Z(s,i[a])&&(r=!0,i.splice(a,1));if(!r)break}const h=s.normal.length;let u=!1;for(let r=0;r<s.normal.length;r++){const a=s.normal[r];for(let g=0;g<a.length;g++){let p=a[g];if(p===void 0){p=s.normal.length,s.normal.push(new Array(f).fill()),s.reverse.push(new Array(f).fill()),s.normal[r][g]=p,s.reverse[p][g]=r,i.push(...m.map(w=>({rel:w,left:0,right:w.length-1,left_coset:h,right_target:h}))),u=!0;break}}if(u)break}}i.length||(t.done=!0),c.length===0&&(c[0]="");let A=!0,j=s.normal.length;for(;$(s.normal.length,c)&&A&&--j;){A=!1;for(let h=0;h<c.length;h++){if(c[h]===void 0)continue;const u=s.normal[h];for(let r=0;r<u.length;r++){const a=u[r];a===void 0||c[a]!==void 0||(c[a]=c[h]+e[r],A=!0)}}}return A||console.warn("Hole in the cosets"),j===0&&console.warn("Max iterations reached"),{cosets:s,rows:i,words:c}},$=(t,e)=>{for(let n=0;n<t;n++)if(e[n]===void 0)return!0;return!1};let _=null,O=null,E=null;const x=(t,e,n,l,s)=>{const i=()=>({cosets:{normal:[],reverse:[]},rows:[],words:[],done:!1,lastDrawn:0});_={...Q(t,e,n,l,s),...i()},O=X(t,e,n,l,s).map(c=>({...c,...i()})),E=Y(t,e,n,l,s).map(c=>({...c,...i(),toRetry:new Set}))},z=(t,e)=>{const{rootVertex:n,mirrorsPlanes:l,curvature:s}=t;let i=n;for(let c=0;c<e.length;c++)i=F(i,l[e.charCodeAt(c)-97],s);return i},P=(t,e)=>{for(let n=0;n<t.length;n++){const l=J(t[n]),s=_.cosets.normal[e][l];if(s===void 0)return;e=s}return e};onmessage=({data:{order:t,curvature:e,mirrorsPlanes:n,coxeter:l,stellation:s,mirrors:i,rootVertex:c,dimensions:o,uuid:f}})=>{t===0&&x(o,l,s,i,e);const m=(t+1)*(e>0?500:100);try{let d=[],A=[],j=[],h=[];if(!_.done){_.limit=m,G(_);for(let u=_.lastDrawn;u<_.words.length;u++){const r=_.words[u];if(r===void 0){d.push({vertex:new Array(o).fill(NaN),word:""});continue}const a=z({rootVertex:c,mirrorsPlanes:n,curvature:e},r);d.push({vertex:a,word:r,i:u}),_.lastDrawn=u+1}}for(let u=0;u<O.length;u++){const r=O[u];r.done||(r.limit=m*(e>0?1:e<0?1.5:3),G(r));const a=P(r.target,0);for(let g=r.lastDrawn;g<r.words.length;g++){const p=r.words[g];if(p===void 0)continue;const w=P(p,0),y=P(p,a);if(w===void 0||y===void 0){r.lastDrawn=g;break}A.push({start:w,end:y,word:p}),r.lastDrawn=g+1}}for(let u=0;u<E.length;u++){const r=E[u];r.done||(r.limit=m*(e>0?1:e<0?1.5:2.5),G(r));const a=[];for(let g=0;g<r.face.length;g++)a.push(P(r.face[g],0));for(const g of r.toRetry){const p=r.words[g],w=[];for(let y=0;y<a.length;y++){const C=a[T(y,a.length,r.double)];if(C===void 0)continue;const D=P(p,C);D!==void 0&&w.push(D)}w.length===a.length?(j.push({vertices:w,word:p,len:a.length}),r.toRetry.delete(g)):h.push({vertices:w,word:p,len:a.length})}for(let g=r.lastDrawn;g<r.words.length;g++){let p=!1;const w=r.words[g],y=[];for(let C=0;C<a.length;C++){const D=a[T(C,a.length,r.double)];if(D===void 0){p=!0;continue}const q=P(w,D);if(q===void 0){p=!0;continue}y.push(q)}p?(h.push({vertices:y,word:w,len:a.length}),r.toRetry.add(g)):j.push({vertices:y,word:w,len:a.length}),r.lastDrawn=g+1}}postMessage({vertices:d,edges:A,faces:j,partials:h,order:t,uuid:f})}catch(d){postMessage({error:d.message,uuid:f})}};const T=(t,e,n=!1)=>{if(n){const l=t>0?1-t%2:0;return t>=e/2+l?2*(e-t)-1+l:2*t-l}return t>=e/2?2*(e-t)-1:2*t}})();
