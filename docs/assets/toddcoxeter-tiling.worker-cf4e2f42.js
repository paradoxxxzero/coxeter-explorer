(function(){"use strict";const $=(t,e,a)=>{let h=0;for(let s=0;s<t.length;s++)h+=t[s]*e[s]*(s===t.length-1&&a||1);return h},q=(t,e,a)=>{t=t.slice();const h=2*$(t,e,a);for(let s=0;s<t.length;s++)t[s]-=h*(a||s!==t.length-1?e[s]:0);return t},S=(t,e,a,h)=>{const s=E/t,u=E/e,r=E/a;return L(E/H(-D(s)*D(r)+V(s)*V(r)*((D(u)-D(h*s)*D(r))/(V(h*s)*V(r)))))},{abs:B,cos:D,sin:V,tan:ee,cosh:te,sinh:ne,acos:H,acosh:se,atan:re,min:le,max:ae,round:L,sqrt:oe,sign:fe,ceil:ie,floor:ce,log:he,exp:ge,PI:E}=Math;function*T(t,e){if(e<0||t.length<e)return;const a=Array.from(Array(e).keys());for(;;){yield a.map(s=>t[s]);let h=e-1;for(;h>=0&&a[h]>=t.length-e+h;)h--;if(h<0)return;for(let s=a[h]+1;h<e;h++,s++)a[h]=s}}const U=(t,e=2)=>Array.from(T(t,e)),k=t=>String.fromCharCode(97+t),G=t=>t.charCodeAt(0)-97,N=(t,e,a,h,s)=>{const u=[];for(let r=0;r<t;r++)u.push(k(r).repeat(2));for(let r=1;r<t;r++)for(let d=0;d<r;d++)e[r][d]<1/0&&u.push((k(d)+k(r)).repeat(e[r][d]));if(a&&!a.every(r=>r.every(d=>d===1))&&s>0){if(t===4&&(a[0][1]>1||a[2][3]>1)&&e[0][1]>3&&e[2][3]>3)a[0][1]>1&&u.push("abcdcb".repeat(S(e[0][1],e[1][2],e[0][2],a[0][1]))),a[2][3]>1&&u.push("abcdcb".repeat(S(e[2][3],e[1][2],e[1][3],a[2][3])));else for(let r=1;r<t;r++)for(let d=0;d<r;d++)if(a[d][r]>1){if(d+2<t){const y=S(e[d+1][r+1],e[d][r],e[d][r+1],a[d][r]);u.push((k(d)+k(r)+k(d+2)+k(r)).repeat(y))}if(d-1>=0){const y=S(e[d-1][r-1],e[d][r],e[d-1][r],a[d][r]);u.push((k(d)+k(r)+k(d)+k(d-1)).repeat(y))}}}return u},J=(t,e,a,h,s)=>{const u=N(t,e,a,h,s),r=[...Array(t).keys()].map(y=>k(y)).join(""),d=h.map((y,j)=>y?"":k(B(j))).join("");return{gens:r,subgens:d,rels:u}},K=(t,e,a,h,s)=>{const u=N(t,e,a,h,s),r=[...Array(t).keys()].map(y=>k(y)).join(""),d=[];for(let y=0;y<h.length;y++)if(h[y]){let j=k(y);for(let w=0;w<t;w++)e[y][w]===2&&(h[w]||(j+=k(w)));d.push({gens:r,subgens:j,rels:u,pair:[0,k(y)]})}return d},Q=(t,e,a,h,s)=>{const u=N(t,e,a,h,s),r=[...Array(t).keys()].map(j=>k(j)).join(""),d=[],y=U([...Array(t).keys()]);for(let j=0;j<y.length;j++){const w=y[j],f=e[w[0]][w[1]],A=[];if(h[w[0]]&&h[w[1]]&&isFinite(f))for(let o=0;o<f;o++){const p=w.map(g=>k(g)).join("").repeat(o);A.push(p),A.push(k(w[1])+p)}else if((h[w[0]]||h[w[1]])&&isFinite(f)&&f>2)for(let o=0;o<f;o++){const p=w.map(g=>k(g)).join("").repeat(o);A.push(p)}else continue;let c=k(w[0])+k(w[1]);for(let o=0;o<t;o++)e[w[0]][o]===2&&e[w[1]][o]===2&&(h[o]||(c+=k(o)));d.push({gens:r,subgens:c,rels:u,face:A})}return d},X=(t,e)=>{if(e.left===e.right)return!1;for(;e.left!==e.right;){const a=t.normal[e.left_coset][e.rel[e.left]];if(a===void 0)break;e.left++,e.left_coset=a}for(;e.left!==e.right;){const a=t.reverse[e.right_target][e.rel[e.right]];if(a===void 0)break;e.right--,e.right_target=a}return e.left===e.right?(t.normal[e.left_coset][e.rel[e.right]]=e.right_target,t.reverse[e.right_target][e.rel[e.right]]=e.left_coset,!0):!1},O=t=>{const{gens:e,subgens:a,rels:h,cosets:s,rows:u,words:r,limit:d}=t,y=e.length,j=h.map(c=>[...c].map(o=>e.indexOf(o))),w=a.split("").map(c=>e.indexOf(c));if(s.normal.length===0){s.normal.push(new Array(y).fill()),s.reverse.push(new Array(y).fill());for(let c=0;c<w.length;c++)s.normal[0][w[c]]=0,s.reverse[0][w[c]]=0}for(u.length===0&&u.push(...j.map(c=>({rel:c,left:0,right:c.length-1,left_coset:0,right_target:0})));u.length&&s.normal.length<d;){for(;;){let p=!1;for(let g=u.length-1;g>=0;g--)X(s,u[g])&&(p=!0,u.splice(g,1));if(!p)break}const c=s.normal.length;let o=!1;for(let p=0;p<s.normal.length;p++){const g=s.normal[p];for(let b=0;b<g.length;b++){let i=g[b];if(i===void 0){i=s.normal.length,s.normal.push(new Array(y).fill()),s.reverse.push(new Array(y).fill()),s.normal[p][b]=i,s.reverse[i][b]=p,u.push(...j.map(l=>({rel:l,left:0,right:l.length-1,left_coset:c,right_target:c}))),o=!0;break}}if(o)break}}u.length||(t.done=!0),r.length===0&&(r[0]="");let f=!0,A=s.normal.length;for(;Y(s.normal.length,r)&&f&&--A;){f=!1;for(let c=0;c<r.length;c++){if(r[c]===void 0)continue;const o=s.normal[c];for(let p=0;p<o.length;p++){const g=o[p];g===void 0||r[g]!==void 0||(r[g]=r[c]+k(p),f=!0)}}}return f||console.warn("Hole in the cosets"),A===0&&console.warn("Max iterations reached"),{cosets:s,rows:u,words:r}},Y=(t,e)=>{for(let a=0;a<t;a++)if(e[a]===void 0)return!0;return!1};let P=null,W=null,x=null,C=null,I=null;const Z=(t,e,a,h,s)=>{const u=()=>({cosets:{normal:[],reverse:[]},rows:[],words:[],done:!1,lastDrawn:0});P={...J(t,e,a,h,s),...u()},W=K(t,e,a,h,s).map(r=>({...r,...u()})),x=Q(t,e,a,h,s).map(r=>({...r,...u()})),C=new Map,I=[new Map,new Map]},z=(t,e)=>{const{rootVertex:a,mirrorsPlanes:h,curvature:s}=t;let u=a;for(let r=0;r<e.length;r++)u=q(u,h[e.charCodeAt(r)-97],s);return u},R=(t,e=0)=>{for(let a=0;a<t.length;a++){const h=G(t[a]),s=P.cosets.normal[e][h];if(s===void 0)return;e=s}return e};onmessage=({data:{order:t,curvature:e,mirrorsPlanes:a,coxeter:h,stellation:s,mirrors:u,rootVertex:r,dimensions:d,uuid:y}})=>{t===0&&Z(d,h,s,u,e);const j=(t+1)*(e>0?500:100);try{let w=[],f=[],A=[];if(!P.done){P.limit=j,O(P);for(let c=P.lastDrawn;c<P.words.length;c++){const o=P.words[c];if(o===void 0){w.push({vertex:new Array(d).fill(NaN),word:""});continue}const p=z({rootVertex:r,mirrorsPlanes:a,curvature:e},o);w.push({vertex:p,word:o,i:c}),P.lastDrawn=c+1}}for(let c=0;c<W.length;c++){const o=W[c];o.done||(o.limit=j*(e>0?1:e<0?1.5:3),O(o));const p=o.pair[0],g=R(o.pair[1]);for(let b=o.lastDrawn;b<o.words.length;b++){const i=o.words[b];if(i===void 0)continue;const l=R(i,p),n=R(i,g);if(l===void 0||n===void 0){o.lastDrawn=b;break}f.push({start:l,end:n,word:i}),o.lastDrawn=b+1}}for(let c=0;c<x.length;c++){const o=x[c];o.done||(o.limit=j,O(o));let p=!1;const g=[];for(let b=0;b<o.face.length;b++){const i=o.face[b],l=R(i);if(l===void 0){p=!0;break}g.push(l)}if(p)break;for(let b=o.lastDrawn;b<o.words.length;b++){const i=o.words[b];if(i===void 0)continue;const l=[];for(let n=0;n<g.length;n++){const m=R(i,g[n]);if(m===void 0){p=!0;break}l.push(m)}if(p){o.lastDrawn=b;break}A.push({vertices:l,word:i}),o.lastDrawn=b+1}}if(u.some(c=>c==="s")){const c=u.map((l,n)=>l==="s"?k(n):"").join(""),o=c.length>0?new RegExp(`[^${c}]`,"g"):null;for(let l=0;l<w.length;l++){const n=w[l];n.word.replace(o,"").length%2===1&&(n.vertex=NaN,C.set(n.i,[]))}const p=[],g=new Map;for(let l=0;l<f.length;l++)if(C.has(f[l].start)){g.has(f[l].start)||g.set(f[l].start,[]);const n=C.get(f[l].start);n.push(f[l].end),n.word||(n.word=f[l].word),g.get(f[l].start).push(f[l].end)}else if(C.has(f[l].end)){g.has(f[l].end)||g.set(f[l].end,[]);const n=C.get(f[l].end);n.push(f[l].start),n.word||(n.word=f[l].word),g.get(f[l].end).push(f[l].start)}else p.push(f[l]);const b=Array.from(g.keys());for(let l=0;l<g.size;l++){const n=b[l],m=g.get(n),v=C.get(n);for(let _=0;_<m.length;_++)for(let M=0;M<v.length;M++)m[_]<=v[M]||p.push({start:m[_],end:v[M],word:v.word})}f=p;const i=[];for(let l=0;l<A.length;l++){const n=A[l],m=[];for(let v=0;v<n.vertices.length;v++)C.has(n.vertices[v])||m.push(n.vertices[v]);i.push({...n,vertices:m})}for(let l=0;l<g.size;l++){const n=b[l],m=C.get(n);i.push({vertices:m,word:m.word})}A=i}if(u.some(c=>c==="ß")){const c=u.map((i,l)=>i==="ß"?k(l):"").join(""),o=c.length>0?new RegExp(`[^${c}]`,"g"):null;for(let i=0;i<w.length;i++){const l=w[i];I[l.word.replace(o,"").length%2].set(l.i,[])}const p=[],g=[new Map,new Map];for(let i=0;i<2;i++){for(let n=0;n<f.length;n++)if(I[i].has(f[n].start)){g[i].has(f[n].start)||g[i].set(f[n].start,[]);const m=I[i].get(f[n].start);m.push(f[n].end),m.word||(m.word=f[n].word),g[i].get(f[n].start).push(f[n].end)}else if(I[i].has(f[n].end)){g[i].has(f[n].end)||g[i].set(f[n].end,[]);const m=I[i].get(f[n].end);m.push(f[n].start),m.word||(m.word=f[n].word),g[i].get(f[n].end).push(f[n].start)}else p.push(f[n]);const l=Array.from(g[i].keys());for(let n=0;n<g[i].size;n++){const m=l[n],v=g[i].get(m),_=I[i].get(m);for(let M=0;M<v.length;M++)for(let F=0;F<_.length;F++)v[M]<=_[F]||p.push({start:v[M],end:_[F],word:_.word})}}f=p;const b=[];for(let i=0;i<2;i++){const l=Array.from(g[i].keys());for(let n=0;n<A.length;n++){const m=A[n],v=[];for(let _=0;_<m.vertices.length;_++)I[i].has(m.vertices[_])||v.push(m.vertices[_]);b.push({...m,vertices:v})}for(let n=0;n<g[i].size;n++){const m=l[n],v=I[i].get(m);b.push({vertices:v,word:v.word})}}A=b}postMessage({vertices:w,edges:f,faces:A,order:t,uuid:y})}catch(w){postMessage({error:w.message,uuid:y})}}})();
