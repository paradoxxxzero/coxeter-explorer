(function(){"use strict";const E=e=>e!==""&&e!=="x",Q=(e,n,t)=>{let s=0;for(let r=0;r<e.length;r++)s+=e[r]*n[r]*(r===e.length-1&&t||1);return s},U=(e,n,t)=>{e=e.slice();const s=2*Q(e,n,t);for(let r=0;r<e.length;r++)e[r]-=s*(t||r!==e.length-1?n[r]:0);return e},M=(e,n,t,s)=>{const r=C/e,l=C/n,o=C/t;return _(C/V(-b(r)*b(o)+k(r)*k(o)*((b(l)-b(s*r)*b(o))/(k(s*r)*k(o)))))},{abs:de,cos:b,sin:k,tan:me,cosh:be,sinh:ye,acos:V,acosh:Me,atan:ke,atan2:Ce,min:xe,max:Se,round:_,sqrt:je,sign:ve,ceil:Be,floor:Te,log:Re,exp:$,hypot:Ae,pow:Ee,PI:C}=Math,I=new ArrayBuffer(8),X=new Float64Array(I),F=new Int32Array(I);function Y(e){return~~e===e?~~e:(X[0]=e,F[0]^F[1])}const H=10**4,Z=e=>{let n="";for(let t=0;t<e.length;t++)n+=Y(_(e[t]*H)/H).toString(),t<e.length-1&&(n+="|");return n},f=e=>String.fromCharCode(97+e),ee=(e,n,t,s,r)=>{const l=[];for(let o=0;o<e;o++)E(s[o])&&l.push(f(o).repeat(2));for(let o=1;o<e;o++)for(let c=0;c<o;c++)n[o][c]>1&&E(s[o])&&E(s[c])&&l.push((f(c)+f(o)).repeat(n[o][c]));if(t&&!t.every(o=>o.every(c=>c===1))&&r>0){if(e===4&&(t[0][1]>1||t[2][3]>1)&&n[0][1]>3&&n[2][3]>3)t[0][1]>1&&l.push("abcdcb".repeat(M(n[0][1],n[1][2],n[0][2],t[0][1]))),t[2][3]>1&&l.push("abcdcb".repeat(M(n[2][3],n[1][2],n[1][3],t[2][3])));else for(let o=1;o<e;o++)for(let c=0;c<o;c++)if(t[c][o]>1){if(c+2<e){const i=M(n[c+1][o+1],n[c][o],n[c][o+1],t[c][o]);l.push((f(c)+f(o)+f(c+2)+f(o)).repeat(i))}if(c-1>=0){const i=M(n[c-1][o-1],n[c][o],n[c-1][o],t[c][o]);l.push((f(c)+f(o)+f(c)+f(c-1)).repeat(i))}}}return l},te=(e,n,t,s,r)=>Object.fromEntries(ee(e,n,null,s,r).map(l=>[l,""])),P=(e,n)=>{const t=e.length-n.length;return t!==0?Math.sign(t):e<=n?-1:1},q=e=>e.split("").reverse().join(""),ne=(e,n)=>{const t=e.length-n.length;return t!==0?Math.sign(t):P(q(e),q(n))},se=(e,n)=>{const t=new Map,s=Object.keys(e).sort(n);for(let r=0;r<s.length;r++){const l=s[r],[o,c]=[l,e[l]].sort(n);t.has(c)?t.set(c,[o,t.get(c)].sort()[0]):t.set(c,o)}return t},y=(e,n)=>{if(n.length===0||e.size===0)return n;const t=e._re_cache||new RegExp([...e.keys()].join("|"),"g");let s=n;do n=s,s=n.replace(t,r=>e.get(r));while(s!==n);return n},re=(e,n)=>{const t=new Map(e);for(e=[...e.entries()];e.length>0;){N();const[s,r]=e.pop();t.delete(s);const l=y(t,s),o=y(t,r);let c=!0;if(l===o)c=!1;else{const[i,u]=[l,o].sort(n);u!==s&&i!==r&&(t.set(u,i),e.push([u,i]),c=!1)}c&&t.set(s,r)}return t},oe=function(e,n){if(n.length===0)return null;const t=Math.max(0,e.length-n.length);for(let s=t;s<e.length;s++)if(e[s]===n[0]&&e.slice(s+1)===n.slice(1,e.length-s))return{prefix:e.slice(0,s),suffix:n.slice(e.length-s)}},ce=function(e,n){if(n.length===0)return null;for(let t=0;t<e.length-n.length+1;t++)if(e.slice(t,t+n.length)===n)return{prefix:e.slice(0,t),suffix:e.slice(t+n.length)}},le=(e,n,t,s)=>{const r=oe(e,t);if(r)return{s1:r.prefix+s,s2:n+r.suffix};const l=ce(e,t);if(l)return{s1:n,s2:l.prefix+s+l.suffix}},ie=(e,n)=>{const t=new Map(e),s=[...e.entries()];for(let r=0;r<s.length;r++){N();const[l,o]=s[r];for(let c=0;c<s.length;c++){if(r===c)continue;const[i,u]=s[c],a=le(l,o,i,u);if(a){const h=y(e,a.s1),T=y(e,a.s2);if(h!==T){const[R,A]=[h,T].sort(n);t.set(A,R)}}}}return t},fe=(e,n)=>ie(re(e,n),n),he=(e,n)=>{if(e.size!==n.size)return!1;const t=e.keys();for(;;){const{done:s,value:r}=t.next();if(s)return!0;if(e.get(r)!==n.get(r))return!1}},ue=(e,n)=>{for(e=se(e,n);;){const t=fe(e,n);if(he(t,e))return t._re_cache=new RegExp([...t.keys()].join("|"),"g"),t;e=t}};let L,K;const N=()=>{if(performance.now()-L>K)throw new Error("Timeout")},ae=(e,n)=>{const t=[50,100,$(n)*4,$(n)*10].map(s=>[s,s]).flat();for(let s=0;s<t.length;s++){K=t[s];try{return L=performance.now(),ue(e,s%2?P:ne)}catch(r){if(r.message!=="Timeout")throw r}}throw new Error("Timeout")},x=(e,n)=>y(e,n);let S=new Map,W=new Set,p=[],j=[],z=[],O=0,w=new Map,d=[],v=null,m=!1,g=null;const D=(e,n,t)=>{O=0,p=[],j=[],z=[],S.clear(),W.clear(),w.clear(),w.set("",G("",e)),d=[""],v=t,g=n;const s=v.map((r,l)=>r==="s"?f(l):"").join("");m=s.length>0?new RegExp(`[^${s}]`,"g"):null},ge=(e,n)=>{const{rootVertex:t,mirrorsPlanes:s,curvature:r}=e;let l=t;for(let o=n.length-1;o>=0;o--)l=U(l,s[n.charCodeAt(o)-97],r);return l};function G(e,n){const t=Z(n);if(S.has(t))return S.get(t);{const s=O+p.length;return S.set(t,s),p.push({vertex:n,word:e}),s}}function J(e,n){const t=w.get(e),s=w.get(n);if(t===s)return;const r=t>s?`${s}-${t}`:`${t}-${s}`;if(!W.has(r))return W.add(r),j.push({start:t,end:s,word:e,newWord:n}),!0}const B=(e,n,t)=>{if(n===t)return;if(w.has(t)){J(n,t);return}const s=ge(e,t),r=G(t,s);return w.set(t,r),J(n,t),t},pe=e=>{const{dimensions:n}=e;let t;t=[];for(let s=0;s<d.length;s++){const r=d[s];for(let l=0;l<n;l++){const o=f(l),c=x(g,r+o);if(m&&c.replace(m,"").length%2)for(let i=0;i<v.length;i++){const u=f(i),a=x(g,c+u);if(a.replace(m,"").length%2)for(let h=0;h<v.length;h++){const T=f(h),R=x(g,a+T);if(R.replace(m,"").length%2)continue;const A=B(e,r,R);A&&t.push(A)}else{const h=B(e,r,a);h&&t.push(h)}}else{const i=B(e,r,c);i&&t.push(i)}}}return t},we=e=>{const{dimensions:n}=e;let t=[""],s;const r=1e4;let l=d;do{s=[];for(let o=0;o<l.length;o++){const c=l[o];for(let i=0;i<n-1;i++){const u=f(i),a=x(g,c+u),h=B(e,c,a);h&&s.push(h)}}t=t.concat(s),l=s}while(s.length&&t.length<=r);if(t.length>r)throw new Error("Could not tile fundamental chamber");return t};onmessage=({data:{order:e,curvature:n,coxeter:t,stellation:s,mirrors:r,mirrorsPlanes:l,rootVertex:o,dimensions:c,uuid:i}})=>{try{let u=!1;if(e===0){const a=te(c,t,s,r,n);try{g=ae(a,c)}catch(h){console.warn(h),g=new Map(Object.entries(a))}if(D(o,g,r),m||g.size<=c)u=!0;else try{d=we({curvature:n,mirrorsPlanes:l,rootVertex:o,dimensions:c})}catch(h){u=!0,D(o,g,r),console.warn(h)}}(e>0||u)&&(d=pe({curvature:n,mirrorsPlanes:l,rootVertex:o,dimensions:c})),postMessage({vertices:p,edges:j,faces:z,order:e,uuid:i}),O+=p.length,p=[],j=[],z=[]}catch(u){postMessage({error:u.message,uuid:i})}}})();
