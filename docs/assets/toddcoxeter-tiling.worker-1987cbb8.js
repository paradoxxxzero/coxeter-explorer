(function(){"use strict";const Z=(e,t=null,n=1,l=!1)=>{if(t===null&&(t=e,e=0),n===0)throw new Error("Step cannot be zero.");if(t<e&&n>0||t>e&&n<0){if(l)return[];n=-n}return new Array(Math.ceil((t-e)/n)).fill().map((f,r)=>e+r*n)},C=(e,t)=>e.length!==t.length?!1:e.every((n,l)=>Array.isArray(n)?C(n,t[l]):n===t[l]),B=(e,t)=>{let n=0;for(let l=0;l<e.length;l++)n+=e[l]*t[l];return n},k=(e,t)=>{const n=[];for(let l=0;l<e.length;l++)n[l]=e[l]-t[l];return n},q=(e,t)=>{const n=[];for(let l=0;l<e.length;l++)n[l]=e[l]*t;return n},v=(e,t)=>{const n=new Array(e.length);for(let l=0;l<e.length;l++){let f=0;for(let r=0;r<e[0].length;r++)f+=e[l][r]*t[r];n[l]=f}return n},G=(e,t)=>e.filter((n,l)=>!t.includes(l)),H=(e,t)=>G(e,t).map(n=>G(n,t)),x=(e,t,n)=>k(e,q(v(ne(n),t),2*B(v(te(n),e),t))),ee=(e,t)=>t.some((n,l)=>n.some((f,r)=>l===r&&f===0))?q(e,1/e[e.length-1]):q(e,-1/fe(L(B(v(t,e),e)))),te=e=>e.map((t,n)=>t.map((l,f)=>n===f&&l===0?1:l)),ne=e=>e.map(t=>t.map(n=>L(n))),E=(e,t,n,l)=>{const f=P/e,r=P/t,s=P/n;return re(P/le(-D(f)*D(s)+R(f)*R(s)*((D(r)-D(l*f)*D(s))/(R(l*f)*R(s)))))},{abs:L,cos:D,sin:R,tan:we,cosh:ye,sinh:Ae,acos:le,acosh:me,atan:Me,atan2:Ne,min:Ue,max:je,round:re,sqrt:fe,cbrt:Ie,sign:Se,ceil:De,floor:Te,log:Xe,exp:Ve,hypot:Ce,pow:ve,PI:P}=Math,w=e=>String.fromCharCode(97+e),se=e=>e.charCodeAt(0)-97,F=(e,t,n,l=[])=>{const f=[];for(let r=0;r<e;r++)l.includes(r)||f.push(w(r).repeat(2));for(let r=1;r<e;r++)for(let s=0;s<r;s++)!l.includes(r)&&!l.includes(s)&&t[r][s]>1&&f.push((w(s)+w(r)).repeat(t[r][s]));if(!l.length&&n&&!n.every(r=>r.every(s=>s===1))){if(e===4&&n[0][1]>1!=n[2][3]>1&&t[0][1]>3&&t[2][3]>3)n[0][1]>1&&f.push("abcdcb".repeat(E(t[0][1],t[1][2],t[0][2],n[0][1]))),n[2][3]>1&&f.push("abcdcb".repeat(E(t[2][3],t[1][2],t[1][3],n[2][3])));else for(let r=1;r<e;r++)for(let s=0;s<r;s++)if(n[s][r]>1){if(s+2<e){const c=E(t[s+1][r+1],t[s][r],t[s][r+1],n[s][r]);f.push((w(s)+w(r)+w(s+2)+w(r)).repeat(c))}if(s-1>=0){const c=E(t[s-1][r-1],t[s][r],t[s-1][r],n[s][r]);f.push((w(s)+w(r)+w(s)+w(s-1)).repeat(c))}}}return f},ce=e=>e!==""&&e!=="x",oe=e=>isNaN(e)?1:+e,J=(e,t=[])=>e.map((n,l)=>t.includes(l)?"":w(l)).join(""),K=(e,t=[])=>e.map((n,l)=>t.includes(l)||n?"":w(l)).join(""),ae=(e,t)=>{if(t===0)return!0;const n=new Set;for(let l=0;l<e.length;l++){const f=e[l];if(!(!f||n.has(f))&&(n.add(f),n.size===t))return!0}return!1},$=(e,t,n,l,f=null,r=null,s=new Map)=>{f=f||l.map((c,a)=>ce(c)?null:a).filter(c=>c!==null),r=r||{new:!0,dimensions:e,gens:J(l,f),subgens:K(l,f),rels:F(e,t,n,f),[`${e}-face`]:[""],coxeter:t,stellation:n,mirrors:l,skips:f,children:[]};for(let c=0;c<e;c++){if(f.includes(c))continue;const a=[...f,c],M=Z(e).filter(_=>!a.includes(_)),i=a.sort().join("-");let N=!1;s.has(i)||(N=!0,s.set(i,ge(e,t,n,l,a)));const h=s.get(i);if(ae(h[h.length-1],e-a.length)){let _="";for(let d=0;d<e;d++)(!a.includes(d)||!l[d]&&!M.some(g=>t[g][d]!==2))&&(_+=w(d));let A={new:N,dimensions:e-a.length,subgens:_,[`${e-a.length}-face`]:h,coxeter:H(t,a),stellation:H(n,a),mirrors:G(l,a),skips:a,double:l.filter((d,g)=>!a.includes(g)).every(d=>!!d),children:[]};e-a.length>0&&(A=$(e,t,n,l,a,A,s)),r.children.push(A)}}if(r.children.length===0){console.info("No leaf found, digging deeper",f);for(let c=0;c<e;c++){if(f.includes(c))continue;const a=[...f,c];r.children.push($(e,t,n,l,a,{children:[]},s))}}return r},ie=(e,t)=>{if(t.left===t.right)return!1;for(;t.left!==t.right;){const n=e.normal[t.left_coset][t.rel[t.left]];if(n===4294967295)break;t.left++,t.left_coset=n}for(;t.left!==t.right;){const n=e.reverse[t.right_target][t.rel[t.right]];if(n===4294967295)break;t.right--,t.right_target=n}return t.left===t.right?(e.normal[t.left_coset][t.rel[t.right]]=t.right_target,e.reverse[t.right_target][t.rel[t.right]]=t.left_coset,!0):!1},ge=(e,t,n,l,f)=>{const r=F(e,t,n,f),s=J(l,f),c=K(l,f);return z({gens:s,subgens:c,rels:r}).words};function Q(e){e.cosets||(e.cosets={normal:[],reverse:[]}),e.rows||(e.rows=[]),e.limit||(e.limit=1e3),e.done||(e.done=!1);const{gens:t,subgens:n,rels:l,cosets:f,rows:r,limit:s}=e,c=t.length,a=l.map(i=>[...i].map(N=>t.indexOf(N))),M=n.split("").map(i=>t.indexOf(i));if(f.normal.length===0){f.normal.push(new Uint32Array(c).fill(4294967295)),f.reverse.push(new Uint32Array(c).fill(4294967295));for(let i=0;i<M.length;i++)f.normal[0][M[i]]=0,f.reverse[0][M[i]]=0}for(r.length===0&&r.push(...a.map(i=>({rel:i,left:0,right:i.length-1,left_coset:0,right_target:0})));r.length&&f.normal.length<s;){for(;;){let h=!1;for(let _=r.length-1;_>=0;_--)ie(f,r[_])&&(h=!0,r[_]=r[r.length-1],r.pop());if(!h)break}const i=f.normal.length;let N=!1;for(let h=0;h<f.normal.length;h++){const _=f.normal[h];for(let A=0;A<_.length;A++){let d=_[A];if(d===4294967295){d=f.normal.length,f.normal.push(new Uint32Array(c).fill(4294967295)),f.reverse.push(new Uint32Array(c).fill(4294967295)),f.normal[h][A]=d,f.reverse[d][A]=h,r.push(...a.map(g=>({rel:g,left:0,right:g.length-1,left_coset:i,right_target:i}))),N=!0;break}}if(N)break}}e.done=!r.length}const he=(e,t)=>{for(let n=0;n<e;n++)if(t[n]===void 0)return!0;return!1};function ue(e){e.words||(e.words=[]);const{gens:t,cosets:{normal:n},words:l}=e;l.length===0&&(l[0]="");let f=!0,r=n.length;for(;he(n.length,l)&&f&&--r;){f=!1;for(let s=0;s<l.length;s++){if(l[s]===void 0)continue;const c=n[s];for(let a=0;a<c.length;a++){const M=c[a];M===4294967295||l[M]!==void 0||(l[M]=l[s]+t[a],f=!0)}}}f||console.warn("Hole in the cosets"),r===0&&console.warn("Max iterations reached")}const z=e=>(Q(e),ue(e),e),de=(e,t,n,l=1e3)=>{const f={gens:e,subgens:t,rels:n,limit:l};return Q(f),f.done?f.cosets.normal.length:NaN};typeof window<"u"&&(window.bench=()=>{const e=performance.now(),t=de("abcdefgh","abdefgh",["aa","bb","cc","dd","ee","ff","gg","hh","ababab","acac","bcbcbc","adad","bdbd","cdcdcd","aeae","bebe","cecece","dede","afaf","bfbf","cfcf","dfdf","efefef","agag","bgbg","cgcg","dgdg","egeg","fgfgfg","ahah","bhbh","chch","dhdh","eheh","fhfh","ghghgh"],5e3);console.info(t,performance.now()-e)});let O=null,y=null,T=null,X=null,S=null;const be=(e,t,n,l)=>{if(S&&e===S.dimensions&&C(t,S.coxeter)&&C(n,S.stellation)&&C(l,S.mirrors)){y.lastDrawn=0,y.done=!1,T.forEach(c=>{c.lastDrawn=0,c.done=!1}),X.forEach(c=>{c.lastDrawn=0,c.done=!1}),O=[];return}S={dimensions:e,coxeter:t,stellation:n,mirrors:l},O=[];const f=()=>({lastDrawn:0}),r=$(e,t,n,l);y=null,T=[],X=[];const s=c=>{c.new&&(c["2-face"]?X.push({gens:r.gens,rels:r.rels,subgens:c.subgens,face:c["2-face"],double:c.double,...f(),toRetry:new Set}):c["1-face"]?T.push({gens:r.gens,rels:r.rels,subgens:c.subgens,edge:c["1-face"],...f()}):c["0-face"]&&(y={gens:r.gens,rels:r.rels,subgens:c.subgens,vertex:c["0-face"],...f()})),c.children&&c.children.forEach(s)};s(r)},I=(e,t)=>{for(let n=0;n<e.length;n++){const l=se(e[n]),f=y.cosets.normal[t][l];if(f===4294967295)return;t=f}return t};onmessage=({data:{order:e,curvature:t,metric:n,coxeter:l,stellation:f,mirrors:r,rootVertices:s,rootNormals:c,dimensions:a,uuid:M}})=>{e===0&&be(a,l,f,r);let i=ee(v(s,r.map(h=>oe(h))),n);const N=(e+1)*(t>0?500:100);try{let h=[],_=[],A=[],d=[];if(!y.done){y.limit=N,z(y);for(let g=y.lastDrawn;g<y.words.length;g++){const o=y.words[g];let u;if(o==="")u=i;else{const b=I(o.slice(0,-1),0),p=c[o.charCodeAt(o.length-1)-97];u=x(O[b],p,n)}O.push(u),h.push({vertex:u,word:o,i:g}),y.lastDrawn=g+1}}for(let g=0;g<T.length;g++){const o=T[g];o.done||(o.limit=N*(t>0?1:t<0?1.5:3),z(o));const u=I(o.edge[0],0),b=I(o.edge[1],0);for(let p=o.lastDrawn;p<o.words.length;p++){const m=o.words[p];if(m===void 0)continue;const U=I(m,u),j=I(m,b);if(U===void 0||j===void 0){o.lastDrawn=p;break}_.push({start:U,end:j,word:m}),o.lastDrawn=p+1}}for(let g=0;g<X.length;g++){const o=X[g];o.face.length===1&&(o.words=o.face,o.face=y.words,o.double=r.every(b=>!!b),o.done=!0),o.done||(o.limit=N*(t>0?1:t<0?1.5:2.5),z(o));const u=[];for(let b=0;b<o.face.length;b++)u.push(I(o.face[b],0));for(const b of o.toRetry){const p=o.words[b],m=[];for(let U=0;U<u.length;U++){const j=u[W(U,u.length,o.double)];if(j===void 0)continue;const V=I(p,j);V!==void 0&&m.push(V)}m.length===u.length?(A.push({vertices:m,word:p,len:u.length}),o.toRetry.delete(b)):d.push({vertices:m,word:p,len:u.length})}for(let b=o.lastDrawn;b<o.words.length;b++){let p=!1;const m=o.words[b],U=[];for(let j=0;j<u.length;j++){const V=u[W(j,u.length,o.double)];if(V===void 0){p=!0;continue}const Y=I(m,V);if(Y===void 0){p=!0;continue}U.push(Y)}p?(d.push({vertices:U,word:m,len:u.length}),o.toRetry.add(b)):A.push({vertices:U,word:m,len:u.length}),o.lastDrawn=b+1}}postMessage({vertices:h,edges:_,faces:A,partials:d,order:e,uuid:M})}catch(h){postMessage({error:h.message,uuid:M})}};const W=(e,t,n=!1)=>{if(n){const l=e>0?1-e%2:0;return e>=t/2+l?2*(t-e)-1+l:2*e-l}return e>=t/2?2*(t-e)-1:2*e}})();
