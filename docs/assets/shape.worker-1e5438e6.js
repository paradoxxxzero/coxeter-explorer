(function(){"use strict";const T=e=>e!==""&&e!=="x",xe=e=>e==="m"||e==="b"||e==="c"||e==="d",ye=e=>e==="c"||e==="d",q=e=>e==="s"||e==="b"||e==="d",I=(e,t=null,n=1,s=!1)=>{if(t===null&&(t=e,e=0),n===0)throw new Error("Step cannot be zero.");if(t<e&&n>0||t>e&&n<0){if(s)return[];n=-n}return new Array(Math.ceil((t-e)/n)).fill().map((u,d)=>e+d*n)},$=(e,t)=>e.length!==t.length?!1:e.every((n,s)=>Array.isArray(n)?$(n,t[s]):n===t[s]),R=(e,t)=>{let n=0;for(let s=0;s<e.length;s++)n+=e[s]*t[s];return n},D=(e,t)=>{const n=[];for(let s=0;s<e.length;s++)n[s]=e[s]+t[s];return n},ke=(e,t)=>{const n=[];for(let s=0;s<e.length;s++)n[s]=e[s]-t[s];return n},m=(e,t)=>{const n=[];for(let s=0;s<e.length;s++)n[s]=e[s]*t;return n},ze=e=>{const t=[];for(let n=0;n<e[0].length;n++){t.push([]);for(let s=0;s<e.length;s++)t[n].push(e[s][n])}return t},H=(e,t)=>{const n=new Array(e.length);for(let s=0;s<e.length;s++){let u=0;for(let d=0;d<e[0].length;d++)u+=e[s][d]*t[d];n[s]=u}return n},Se=e=>{const t=new Array(e.length);for(let n=0;n<e.length;n++)t[n]=new Array(e.length).fill(0),t[n][n]=e[n];return t},P=e=>{const t=new Array(e).fill(1);return Se(t)},X=(e,t)=>e.filter((n,s)=>!t.includes(s)),oe=(e,t)=>X(e,t).map(n=>X(n,t)),re=(e,t,n)=>ke(e,m(H(Ce(n),t),2*R(H(Ve(n),e),t))),ie=(e,t)=>t.some((n,s)=>n.some((u,d)=>s===d&&u===0))?m(e,1/e[e.length-1]):m(e,-1/Ae(ce(R(H(t,e),e)))),Ve=e=>e.map((t,n)=>t.map((s,u)=>n===u&&s===0?1:s)),Ce=e=>e.map(t=>t.map(n=>ce(n))),L=(e,t,n,s)=>{const u=G/e,d=G/t,g=G/n;return le(G/Me(-U(u)*U(g)+Q(u)*Q(g)*((U(d)-U(s*u)*U(g))/(Q(s*u)*Q(g)))))},{abs:ce,cos:U,sin:Q,tan:Qe,cosh:Ge,sinh:Je,acos:Me,acosh:Ke,atan:Xe,atan2:Ye,min:Ze,max:pe,round:le,sqrt:Ae,cbrt:et,sign:tt,ceil:nt,floor:st,log:ot,exp:rt,hypot:it,pow:We,PI:G}=Math,Oe=(...e)=>e.reduce((t,n)=>t+n,0)/e.length,fe=new ArrayBuffer(8),qe=new Float64Array(fe),ue=new Int32Array(fe);function Ee(e){return~~e===e?~~e:(qe[0]=e,ue[0]^ue[1])}const ge=10**4,Y=e=>{let t="";for(let n=0;n<e.length;n++)t+=Ee(le(e[n]*ge)/ge).toString(),n<e.length-1&&(t+="|");return t},M=e=>String.fromCharCode(97+e),de=e=>e.charCodeAt(0)-97,Z=(e,t="",n=[])=>{const s=[];for(let u=0;u<e.length;u++){const[d,g]=e[u],a=e.filter((c,w)=>w!==u);if(n.length){const c=n[n.length-1];if(g.some(w=>w===c)){const w=g[1]===c,i=w?d.toUpperCase():d,f=w?[...g].reverse():g;if(f[1]===n[0])return[t+i];a.length&&s.push(...Z(a,t+i,n.concat(f.slice(1))))}}else s.push(...Z(a,d,g))}return s},B=(e,t,n,s,u,d=[])=>{let g="";const a=s.map((r,o)=>d.includes(o)||r?"":M(o)).join(""),c={},w=[];for(let r=0;r<e;r++)if(!d.includes(r)){if(!q(s[r])){const o=M(r);g+=o,c[o]=[r],w.push(o.repeat(2))}for(let o=r+1;o<e;o++){if(d.includes(o))continue;const l=t[r][o];if(q(s[r])&&q(s[o])){const h=M((r+1)*e+o);g+=h,c[h]=[r,o],w.push(h.repeat(l))}else if(q(s[r])&&!q(s[o])){const h=M((r+1)*e+o);g+=h,c[h]=[r,o,r],w.push(h.repeat(2)),w.push((h+M(o)).repeat(l%2===0?l/2:l))}else if(!q(s[r])&&q(s[o])){const h=M((r+1)*e+o);g+=h,c[h]=[o,r,o],w.push(h.repeat(2)),w.push((h+M(r)).repeat(l%2===0?l/2:l))}else l>1&&w.push((M(r)+M(o)).repeat(l))}}const i=Object.entries(c).filter(([r,o])=>o.length===3),f=Object.entries(c).filter(([r,o])=>o.length===2);if(f.length>1){const r=Z(f);w.push(...r.map(o=>o.split("").reverse().join("")))}if(i.length>1)for(let r=0;r<i.length;r++){const[o,l]=i[r];for(let h=r+1;h<i.length;h++){const[v,b]=i[h];if(l[1]===b[1]){const j=f.find(([x,S])=>S[0]===l[0]&&S[1]===b[0]);if(j){const x=j[0];w.push(o.toUpperCase()+x.toUpperCase()+v+x)}}else if(l[0]===b[0]){const j=t[l[1]][b[1]];j>1&&w.push((o+v).repeat(j))}}}if(!s.some(r=>q(r))&&!n.every(r=>r.every(o=>o===1))&&u.curvature>0){if(e===4&&n[0][1]>1!=n[2][3]>1&&t[0][1]>3&&t[2][3]>3)[0,1,2,3].some(r=>d.includes(r))||(n[0][1]>1&&w.push("abcdcb".repeat(L(t[0][1],t[1][2],t[0][2],n[0][1]))),n[2][3]>1&&w.push("abcdcb".repeat(L(t[2][3],t[1][2],t[1][3],n[2][3]))));else for(let r=1;r<e;r++)for(let o=0;o<r;o++)if(n[o][r]>1){if(o+2<e){const l=L(t[o+1][r+1],t[o][r],t[o][r+1],n[o][r]);l&&!d.includes(o)&&!d.includes(r)&&!d.includes(o+2)&&w.push((M(o)+M(r)+M(o+2)+M(r)).repeat(l))}if(o-1>=0){const l=L(t[o-1][r-1],t[o][r],t[o-1][r],n[o][r]);l&&!d.includes(o)&&!d.includes(r)&&!d.includes(o-1)&&w.push((M(o)+M(r)+M(o)+M(o-1)).repeat(l))}}}return{gens:g,subgens:a,rels:w,transforms:c}},me=e=>{const t=e.toUpperCase();return e===t?e.toLowerCase():t},O=(e,t)=>{let n=t,s=0;for(;e.quotientMap[n];)s++,n=e.quotientMap[n];return s>1&&(e.quotientMap[t]=n),n},he=(e,t,n)=>{const s=t,u=[[t,n]];for(;u.length>0;)if([t,n]=u.pop(),t>n&&([t,n]=[n,t]),t=O(e,t),n=O(e,n),t!==n){e.quotientMap[n]=t,e.seen.has(n)&&!e.seen.has(t)&&e.seen.add(t);const d=e.cosets.get(t),g=e.cosets.get(n);e.cosets.delete(n);for(const[a,c]of g)d.has(a)?u.push([d.get(a),c]):d.set(a,c)}return O(e,s)},ae=(e,t,n,s)=>{t=O(e,t);const u=e.cosets.get(t);u.has(n)?he(e,u.get(n),s):u.set(n,s)},J=(e,t,n,s)=>{t=O(e,t);let u;const d=e.cosets.get(t);return d.has(n)?(u=O(e,d.get(n)),s!==void 0&&u!==s&&he(e,s,u)):(s?u=s:(u=e.nextVertex++,e.cosets.set(u,new Map),e.unvisited.push(u)),ae(e,t,n,u),ae(e,u,me(n),t)),u},ve=function(e,t,n){let s=n;for(let u=t.length-1;u>0;u--)s=J(e,s,t[u]);J(e,s,t[0],n)},Ie=function(e){if(!e.words){const t=O(e,1);e.words=new Map,e.words.set(t,""),e.currentWords=new Map,e.currentWords.set(t,""),e.lastCoset=t,e.remaining=[t],e.rootVertex&&e.rootNormals&&e.metric&&(e.vertices=new Map,e.vertices.set(t,e.rootVertex))}for(;e.remaining.length>0;){const t=e.remaining[0],n=O(e,t),s=e.cosets.get(n),u=e.words.get(n);if(s.size<e.gens.length*2)return;const d=[];for(let g=0;g<e.gens.length;g++){const a=e.gens[g],c=O(e,s.get(a));if(!e.words.has(c)){if(e.cosets.get(c).size<e.gens.length*2)return;d.push([a,c])}}e.remaining.shift();for(let g=0;g<d.length;g++){const[a,c]=d[g],w=a+u;if(e.words.set(c,w),e.currentWords.set(c,w),e.lastCoset=c,e.remaining.push(c),e.vertices){let i=e.vertices.get(n);for(let f=0;f<e.transforms[a].length;f++){const r=e.transforms[a][f];i=re(i,e.rootNormals[r],e.metric)}e.vertices.set(c,i)}}}},_=(e,t)=>{let n=O(e,1);for(let s=t.length-1;s>=0;s--){const u=e.cosets.get(n);if(u.size<e.gens.length*2||(n=O(e,u.get(t[s])),e.cosets.get(n).size<e.gens.length*2))return}return n},we=e=>{if(!e.cosets){e.unvisited=[1],e.cosets=new Map([[1,new Map]]),e.nextVertex=2,e.seen=new Set,e.quotientMap={};for(let t=0;t<e.subgens.length;t++)ve(e,e.subgens[t],1)}e.limit=e.limit||1e3,e.done=!1;for(let t=0;t<e.limit;t++){let n=null;for(;e.unvisited.length>0;){const s=O(e,e.unvisited.shift());if(!e.seen.has(s)){e.seen.add(s),n=s;break}}if(n===null){e.done=!0;break}for(let s=0;s<e.gens.length;s++)J(e,n,e.gens[s].toUpperCase()),J(e,n,e.gens[s]);for(let s=0;s<e.rels.length;s++)ve(e,e.rels[s],n)}},Pe=e=>(we(e),e.cosets.size),be=e=>(we(e),Ie(e),e),_e=(e,t,n)=>{if(t===0)return!0;if(e.length<=t)return!1;const s=new Set;for(let u=0;u<e.length;u++){const d=e[u];if(d)for(let g=0;g<d.length;g++){const a=d[g];for(let c=0;c<n[a].length;c++){const w=M(n[a][c]);s.has(w)||s.add(w)}if(s.size>=t)return!0}}return!1},p=(e,t,n,s,u)=>{const d=I(n.length).filter(i=>!u.includes(i));let g="";const a=Object.entries(s),c=a.filter(([i,f])=>f.length===1),w=a.filter(([i,f])=>f.length===3);for(let i=0;i<a.length;i++){const[f,r]=a[i];if(r.length===1){const o=r[0];if(!u.includes(o)&&!w.some(([l,h])=>h[1]===o)){g+=f;continue}if(!T(e[o]))continue;!e[o]&&!d.some(l=>n[l][o]!==2)&&(g+=f)}else if(r.length===2){const o=r[0],l=r[1],h=n[o][l];if(t.gens.includes(f)&&(t.dimensions===1?h===2:h>2)){g+=f;continue}if(!T(e[o])||!T(e[l]))continue}else if(r.length===3&&u.length&&typeof u[u.length-1]=="string"&&u[u.length-1].includes("s")){const o=r[0],l=r[1],h=n[o][l],v=u[u.length-1].split("s").filter(b=>b);for(let b=0;b<v.length;b++){const j=v[b],x=s[Object.keys(s)[j]];if(x.length===3&&r[1]===x[1]){const S=n[x[0]][x[1]];if((t.dimensions===1?![2,4].includes(h)||[2,4].includes(S):h!==2)&&(g+=f),c.find(([k,V])=>x.every(z=>z!==V[0]))){const k=c.find(([V,z])=>z[0]===x[1]);k&&(g+=k[0])}}}}}return g},ee=(e,t,n,s,u,d=null,g=null,a=null,c=new Map)=>{const w=!g;s.every(i=>!i)&&(s=s.map(()=>1)),d=d||s.map((i,f)=>T(i)?null:f).filter(i=>i!==null),g=g||{new:!0,key:"",dimensions:e,coxeter:t,stellation:n,mirrors:s,skips:d,...B(e,t,n,s,u,d),quotient:"",facet:[""],children:[]},a=a||g.transforms;for(let i=0;i<e;i++){if(d.includes(i)||d.includes("s"))continue;const f=[...d,i],r=f.sort().join("-");let o=!1;if(!c.has(r)){o=!0;const v={key:r,dimensions:e-f.length,coxeter:oe(t,f),stellation:oe(n,f),mirrors:X(s,f),skips:f,...B(e,t,n,s,u,f)};if(v.gens===null)continue;be(v),c.set(r,v)}const l=c.get(r),h=Array.from(l.words.values());if(_e(h,l.dimensions,l.transforms)){let v=p(s,l,t,a,f),b={new:o,...l,quotient:v,facet:h,children:[]};l.dimensions>0&&(b=ee(e,t,n,s,u,f,b,a,c)),g.children.push(b)}}if(g.children.length===0&&e-d.length>1){console.debug("No leaf found, digging deeper",d);for(let i=0;i<e;i++){if(d.includes(i))continue;const f=[...d,i],r=f.sort().join("-");let l={new:!1,...c.get(r),quotient:"",facet:[""],children:[]};l=ee(e,t,n,s,u,f,l,a,c),g.children.push(l)}}if(w&&s.some(i=>q(i))){let i=[];for(let f=1;f<e;f++){const r=[...d,...I(e-f).map(()=>"s")],o=e-r.length;if(f===1){const l=[],h=y=>{y.children.forEach(h),y.dimensions===1&&y.new&&l.push(y)};h(g);const v=Object.entries(g.transforms).filter(([y,k])=>k.length!==1||s[k[0]]).filter(([y,k])=>k.length!==3||t[k[0]][k[1]]!==2).map(([y])=>y);for(let y=0;y<l.length;y++){const k=l[y];v.includes(k.gens)&&v.splice(v.indexOf(k.gens),1)}const b=i;i=[];const j=P(o).map((y,k)=>y.map((V,z)=>k===z?1:k===z+1||k===z-1?4:2)),x=P(o).map(y=>y.map(()=>1)),S=I(o).map(()=>"s");for(let y=0;y<v.length;y++){const k=v[y];r[r.length-1]=g.gens.indexOf(k)+"s";const V={key:r.join("-"),dimensions:o,coxeter:j,stellation:x,mirrors:S,skips:r,...B(o,j,x,S,u,r)};V.gens=k;const z={new:!0,...V,quotient:p(s,V,t,a,r),facet:["",k],children:y===0?b:[]};i.push(z)}}else if(f===2){const l=P(o).map((y,k)=>y.map((V,z)=>k===z?1:k===z+1||k===z-1?3:2)),h=P(o).map(y=>y.map(()=>1)),v=I(o).map(()=>"s"),b=[],j=Object.entries(g.transforms).filter(([y,k])=>k.length>=2).filter(([y,k])=>k.length!==3||t[k[0]][k[1]]!==2),x=Object.entries(g.transforms).filter(([y,k])=>k.length===1);for(let y=0;y<j.length;y++){const[k,V]=j[y];for(let z=y+1;z<j.length;z++){const[C,E]=j[z];V[V.length-1]===E[E.length-1]&&b.push(["",k,C]),V.length!==E.length&&(V.length===2&&V[0]===E[2]||V.length===3&&V[2]===E[0])&&b.push(["",k.toUpperCase(),C.toUpperCase()])}if(V.length===3)for(let z=0;z<x.length;z++){const[C,E]=x[z];V.every(se=>se!==E[0])&&b.push(["",k,C+k])}}const S=i;i=[],b.length||b.push([""]);for(let y=0;y<b.length;y++){const k=b[y];r[r.length-1]=k.length===1?"s":g.gens.indexOf(k[1].toLowerCase())+"s"+g.gens.indexOf(k[2].replace(k[1],"").toLowerCase());const V={key:r.join("-"),dimensions:o,coxeter:l,stellation:h,mirrors:v,skips:r,...B(o,l,h,v,u,r)},z={new:!0,...V,quotient:p(s,V,t,a,r),facet:k,children:y===0?S:[]};i.push(z)}}else{const l=P(o).map((x,S)=>x.map((y,k)=>S===k?1:2)),h=P(o).map(x=>x.map(()=>1)),v=I(o).map(()=>"s"),b=i;i=[];const j={new:!0,key:r.join("-"),dimensions:o,coxeter:l,stellation:h,mirrors:v,skips:r,...B(o,l,h,v,u,r),facet:[""],quotient:"",children:b};i.push(j)}}g.children.push(...i)}return g},F=["vertex","edge","face"],te=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+(t-e)*6*n:n<1/2?t:n<2/3?e+(t-e)*(2/3-n)*6:e),A=(e,t,n)=>{let s,u,d;if(t===0)s=u=d=n;else{const g=n<.5?n*(1+t):n+t-n*t,a=2*n-g;s=te(a,g,e+1/3),u=te(a,g,e),d=te(a,g,e-1/3)}return[s,u,d]},K=[[10/360,.56,.91],[0/360,.59,.88],[316/360,.72,.86],[267/360,.84,.81],[343/360,.81,.75],[350/360,.65,.77],[23/360,.92,.75],[41/360,.86,.83],[115/360,.54,.76],[170/360,.57,.73],[189/360,.71,.73],[199/360,.76,.69],[217/360,.92,.76],[232/360,.97,.85]],Ne={background:[0,0,0,1],glow:!1,shading:"ads",diffuse:"lambert",specular:!1,shininess:32,opacity:1,ambient:.2,roughness:.85,gouraud:!1,transparency:"oit",color:({word:e})=>A(e.length*.03%1,.75,.7)},Ue=Object.fromEntries(Object.entries({neon:{background:[0,0,0,1],glow:{exposure:1.75,strength:2,offset:{up:2,down:2},steps:3,pow:2},shading:!1,face:{opacity:.025},transparency:"blend",color:({word:e,dual:t})=>A((e.length*.17-(t?.43:0))%1,.5,.6)},disco:{background:[0,0,0,1],glow:{exposure:1.5,strength:2,offset:{up:2,down:2},steps:4,pow:2},face:{gouraud:!0,diffuse:"fresnel",opacity:.025},transparency:"blend",color:({word:e})=>A(...K[e.length%K.length])},cathedral:{background:[.6,.6,.6,1],glow:{exposure:1.5,strength:2,offset:{up:2,down:2},steps:4,pow:2},face:{gouraud:!0,opacity:.9},transparency:"oit",color:({word:e,type:t})=>t==="face"?A(e.length*.3%1,1,.6):[0,0,0]},synthwave:{background:[...A(.77,.6,.04),1],glow:{exposure:1.5,strength:3,offset:{up:3,down:3},steps:3,pow:2},shading:!1,face:{opacity:.015},afterImage:.7,transparency:"blend",color:({word:e})=>A((.5-e.length*.05%.5+.65)%1,.4,.6)},colorful:{background:[1,1,1,1],diffuse:"oren-nayar",specular:"cook-torrance",shininess:32,opacity:1,ambient:.2,gouraud:!1,face:{gouraud:!0,opacity:.1,diffuse:"fresnel",specular:!1},transparency:"oit",color:({word:e,dual:t})=>A(e.length*.03%1-(t?.25:0),1,.8)},shiny:{background:[0,0,0,1],diffuse:"lambert",specular:"blinn-phong",shininess:32,opacity:1,ambient:.2,gouraud:!1,face:{gouraud:!0,opacity:.1,diffuse:"fresnel",specular:!1},transparency:"oit",color:({word:e})=>A(-(e.length*.07)%1,1,.8)},shape:{background:[1,1,1,1],transparency:"oit",face:{gouraud:!0,opacity:.2,diffuse:"fresnel"},color:({faceSize:e,type:t,idx:n,size:s})=>t==="face"?A((e-2)*.21%1,1,.8):A(n/s,.75,.5)},subShape:{background:[1,1,1,1],transparency:"oit",face:{gouraud:!0,opacity:.2,diffuse:"fresnel"},color:({subShape:e,type:t})=>t!=="vertex"?A(e*.21%1,1,.8):[1,1,1]},reflection:{background:[1,1,1,1],diffuse:"cel",face:{opacity:.6,gouraud:!1},transparency:"blend",color:({word:e,type:t,dimensions:n,draw:s})=>{const u=e.length?de(e[e.length-1])/n:0;return A(u%1,1,t==="face"?.6:s.face?0:.8)}},harlequin:{background:[...A(240/360,.23,.09),1],face:{opacity:.6},transparency:"oit",color:({word:e,idx:t,type:n})=>{const s=e.split("").map(d=>de(d)).reduce((d,g)=>d+g,0),u=[...K[s%K.length]];return t%2&&(u[2]*=.5),A(...u)}},pure:{background:[0,0,0,1],color:({word:e})=>A(e.length*.03%1,.75,.7)},facets:{background:[0,0,0,1],color:({faceIndex:e,faceSize:t})=>A(e/t,.75,.7)},monochrome:{background:[.12,.12,.12,1],diffuse:"reverse",ambient:0,face:{opacity:.1},transparency:"oit",color:()=>[1,1,1]},plain:{extended:!0,background:[1,1,1,1],glow:!1,shading:!1,color:({word:e,type:t,draw:n})=>A(e.length*.06%1,1,t==="face"?.6:n.face?.05:.5)},plainblack:{extended:!0,background:[1,1,1,1],shading:!1,color:({word:e,type:t})=>t==="face"?new Array(3).fill(1-We(.9,e.length+1)):[0,0,0]},normals:{extended:!0,background:[1,1,1,1],shading:"normal",color:()=>[0,0,0]},uvs:{extended:!0,background:[1,1,1,1],shading:"uv",color:()=>[0,0,0]}}).map(([e,t])=>[e,{...Ne,...t,transparent:{}}])),Be=(e,t,n,s)=>{const u=[],d=[],g=e>4?9:e;for(let a=0;a<t.length;a++){const c=t[a];if(!c){u.push(null),d.push(null);continue}const w=[new Float32Array(c.size*3)];for(let r=0;r<a+1;r++)w.push(new Float32Array(c.size*g));let i=0;const f=c.objects.concat(c.partials);for(let r=0;r<f.length;r++){const o=f[r];if(o)for(let l=0;l<o.length;l++){const h=o[l];for(let b=0;b<h.vertices.length;b++){const j=h.vertices[b];for(let x=0;x<j.length;x++)w[b+1][i*g+x]=j[x]}const v=Ue[n].color({word:h.word,key:h.key,subShape:r%c.objects.length,faceIndex:h.faceIndex,faceSize:h.faceSize,dimensions:e,draw:s,idx:i,size:c.size,type:F[a],dual:!!h.dual});w[0][i*3+0]=v[0],w[0][i*3+1]=v[1],w[0][i*3+2]=v[2],i++}}u.push(w),d.push({start:c.start,size:c.size})}return{infos:d,data:u}},Fe=(e,t,n=!1,s=!1)=>{if(n){if(s)return e;const u=e>0?1-e%2:0;return e>=t/2+u?2*(t-e)-1+u:2*e-u}return e>=t/2?2*(t-e)-1:2*e},Te=(e,t,n,s)=>{const u=[],d=[];if(e===0)for(const[g,a]of t.currentWords)u.push({word:a,vertices:[t.vertices.get(g)]}),t.currentWords.delete(g);else if(e===1)for(const[g,a]of t.currentWords){const c={word:a,vertices:[]};for(let w=0;w<t.facet.length;w++){const i=_(s.root,a+t.facet[w]);i&&s.root.vertices.has(i)&&c.vertices.push(s.root.vertices.get(i))}c.vertices.length<e+1||(u.push(c),t.currentWords.delete(g))}else if(e===2)for(const[g,a]of t.currentWords){const c=t.mirrors.every(l=>!!l),w=t.mirrors.every(l=>q(l)),i=a.length%2?0:1,f=[];for(let l=0;l<t.facet.length;l++){const h=Fe(l,t.facet.length,c,w),v=_(s.root,a+t.facet[h]);v&&s.root.vertices.has(v)&&f.push(s.root.vertices.get(v))}if(f.length<e+1)continue;const r=f.length<t.facet.length;if(f.length===3){i&&([f[2],f[1]]=[f[1],f[2]]);const l={word:a,vertices:f,faceIndex:0,faceSize:3,partial:r};r?d.push(l):(u.push(l),t.currentWords.delete(g));continue}let o=new Array(n.dimensions).fill(0);for(let l=0;l<f.length;l++){const h=f[l];o=D(o,h)}o=m(o,1/f.length);for(let l=0;l<f.length;l++){const h={word:a,vertices:[f[(l+i)%f.length],f[(l+(1-i))%f.length],o],faceIndex:l,faceSize:f.length,partial:r};r?d.push(h):(u.push(h),t.currentWords.delete(g))}}return{objects:u,partials:d}},ne=(e,t=null)=>{if(!e.length)return t||[];if(!t)return t=e[0],ne(e.slice(1),t);const n=t[t.length-1],s=e.find(d=>d[0]===n||d[1]===n);if(!s)return t;const u=e.indexOf(s);return e.splice(u,1),s[0]===n?t.push(s[1]):t.push(s[0]),ne(e,t)},$e=(e,t,n,s)=>{const u=[],d=t.children.find(c=>c.key===n.replace("d","")),g=[],a=c=>{c.dimensions===e&&g.push(c.facet),c.children.forEach(a)};a(d),t.children.filter(c=>c.key.includes("s")).forEach(a);for(let c=0;c<g.length;c++){const w=g[c];if(w.length<2)continue;const i=[];for(let r=0;r<w.length;r++){const o=_(s,w[r]);o&&s.vertices.has(o)&&i.push(s.vertices.get(o))}let f=new Array(i[0].length).fill(0);for(let r=0;r<i.length;r++){const o=i[r];f=D(f,o)}f=m(f,1/i.length),u.push(R(f,f))}return Oe(...u)},Re=(e,t,n,s,u,d)=>{var w,i,f;const{space:g}=s.root,a=[],c=[];if(e===0){s.root.dualVertices=s.root.dualVertices||new Map;for(const[r,o]of t.currentWords){const l=[];for(let j=0;j<t.facet.length;j++){const x=_(s.root,o+t.facet[j]);x&&s.root.vertices.has(x)&&l.push(x)}const h=l.length<t.facet.length;let v=new Array(n.dimensions).fill(0);for(let j=0;j<l.length;j++){const x=s.root.vertices.get(l[j]);v=D(v,x)}if(v=ie(v,g.metric),g.curvature){let j=0;if(u>=0){let x=1;u>0&&u<n.dimensions-1&&(t.midradius||(t.midradius=$e(u,n,d,s.root)),x=t.midradius);const S=H(g.metric,v);for(let y=0;y<l.length;y++){const k=s.root.vertices.get(l[y]);j+=R(S,k)}j/=x*l.length,u===n.dimensions-1&&(j=1/j)}else j=1;v=m(v,g.curvature/j)}const b={word:o,vertices:[v],dual:!0,partial:h};s.root.dualVertices.set(`${d}#${o}`,{vertex:v,facet:l,partial:h}),h?c.push(b):(a.push(b),t.currentWords.delete(r))}}else if(e===1){if(!((w=s.root.dualVertices)!=null&&w.size))return{objects:a,partials:c};s.root.dualEdges=s.root.dualEdges||new Map;for(const[r,o]of t.currentWords){const l=[];for(let j=0;j<t.facet.length;j++){const x=_(s.root,o+t.facet[j]);x&&s.root.vertices.has(x)&&l.push(x)}let h=l.length<t.facet.length;const v=[],b=[];for(const[j,{vertex:x,facet:S,partial:y}]of s.root.dualVertices.entries())if(l.every(k=>S.includes(k))&&(v.push(x),b.push(j)),h=h||y,v.length===2)break;if(v.length===2){const j={word:o,vertices:v,dual:!0,partial:h};s.root.dualEdges.set(`${d}#${o}`,{edge:b,partial:h}),h?c.push(j):(a.push(j),t.currentWords.delete(r))}}}else if(e===2){if(!((i=s.root.dualVertices)!=null&&i.size)||!((f=s.root.dualEdges)!=null&&f.size))return{objects:a,partials:c};for(const[r,o]of t.currentWords){const l=[];for(let z=0;z<t.facet.length;z++){const C=_(s.root,o+t.facet[z]);C&&s.root.vertices.has(C)&&l.push(C)}if(l.length<t.facet.length)continue;const h={},v=[];for(const[z,{vertex:C,facet:E}]of s.root.dualVertices.entries())l.every(se=>E.includes(se))&&(h[z]=C,v.push(z));if(v.length<3)continue;let b=!1;const j=[];for(const{edge:z,partial:C}of s.root.dualEdges.values())v.includes(z[0])&&v.includes(z[1])&&(b=b||C,j.push([...z]));if(j.length<3)continue;const x=[],S=ne(j);if(S.length<4)continue;let y=!0;S[0]===S[S.length-1]&&(S.pop(),y=b||!1);for(let z=0;z<S.length;z++){const C=S[z];x.push(h[C])}if(x.length===3){const z={word:o,vertices:x,dual:!0};a.push(z),t.currentWords.delete(r);continue}const k=o.length%2?0:1;let V=new Array(n.dimensions).fill(0);for(let z=0;z<x.length;z++){const C=x[z];V=D(V,C)}V=m(V,1/x.length);for(let z=0;z<x.length;z++){const C={word:o,vertices:[x[(z+k)%x.length],x[(z+(1-k))%x.length],V],dual:!0,faceIndex:z,faceSize:x.length,partial:y};y?c.push(C):(a.push(C),t.currentWords.delete(r))}}}return{objects:a,partials:c}},De=(e,t,n)=>{const s=[],u=[],d=[];for(const[g,a]of e.currentWords){let c;if(a===""){const w=ze(n.rootVertices);e.fundamentalVertices=new Map,c=I(t.dimensions).map(i=>ie(w[i],n.metric)),e.hashes={vertex:new Set,edge:new Set,face:new Set},e.fundamentalVertices.set("",c)}else{c=[...e.fundamentalVertices.get(a.slice(1))];const w=e.gens.indexOf(a[0]);for(let i=0;i<c.length;i++)c[i]=re(c[i],n.rootNormals[w],n.metric)}for(let w=0;w<c.length;w++){const i=Y(c[w]);e.hashes.vertex.has(i)||(s.push({word:a,cosetId:g,vertices:[c[w]]}),e.hashes.vertex.add(i));for(let f=w+1;f<c.length;f++){const r=[c[w],c[f]].sort((o,l)=>{for(let h=0;h<o.length;h++){if(o[h]<l[h])return-1;if(o[h]>l[h])return 1}return 0}).map(o=>Y(o)).join("-");e.hashes.edge.has(r)||(u.push({word:a,cosetId:g,vertices:[c[w],c[f]]}),e.hashes.edge.add(r));for(let o=f+1;o<c.length;o++){const l=[c[w],c[f],c[o]].sort((h,v)=>{for(let b=0;b<h.length;b++){if(h[b]<v[b])return-1;if(h[b]>v[b])return 1}return 0}).map(h=>Y(h)).join("-");e.hashes.face.has(l)||(d.push({word:a,cosetId:g,vertices:[c[w],c[f],c[o]]}),e.hashes.face.add(l))}}e.fundamentalVertices.set(a,c)}e.currentWords.delete(g)}return[s,u,d]},He=(e,t,n,s,u,d,g,a,c)=>{g.root.lasts||(g.root.lasts=new Array(3).fill(0));const w=[];if(u){const i=De(g.root,e,n);for(let f=0;f<i.length;f++)s[F[f]]?(w.push({start:g.root.lasts[f],size:i[f].length,objects:[i[f]],partials:[]}),g.root.lasts[f]+=i[f].length):w.push(null)}else for(let i=0;i<3;i++){if(!g[i]||!d&&!s[F[i]]){w.push(null);continue}const f={start:g.root.lasts[i],size:0,objects:[],partials:[]};for(let r=0;r<g[i].detail.length;r++){const o=g[i].detail[r];if(!o.dual&&a.includes(o.key)){f.objects.push(null),f.partials.push(null);continue}const l=t.get(o.key);if(l.currentWords.size){const{objects:h,partials:v}=o.dual?Re(i,l,e,g,c,o.key):Te(i,l,e,g);if(!s[F[i]]||a.includes(o.key))continue;f.objects.push(h),f.size+=h.length+v.length,g.root.lasts[i]+=h.length,f.partials.push(v)}}w.push(f)}return w},je=(e,t,n,s,u,d,g,a,c=[])=>{c.done=!0;const w=i=>{const f=g?t.dimensions-i.dimensions-1:i.dimensions;i.children.forEach(w);const r=a[f],o=F[f],l=g?`d${i.key}`:i.key;if(i!=null&&i.new){c[f]||(c[f]={dimensions:f,processing:u[o]?0:void 0,count:0,detail:[],aggregated:[],done:!0});const h=s.eigens.values;if(n.has(l))n.get(l).keys.push(l);else{let j=r?e:5;o==="edge"&&s.curvature<=0&&(j*=1.5);const x={...t,keys:[l],subgens:i.quotient,facet:i.facet,subdimensions:f,mirrors:i.mirrors,limit:j,space:s,...i.dimensions===0&&!d?{rootVertex:s.rootVertex,rootNormals:s.rootNormals,metric:s.metric}:{}};n.set(l,x)}const v=n.get(l);i.dimensions===0&&(c.root=v),v.done||(r?(be(v),h.some(j=>j<=0)?v.count=1/0:v.count=v.cosets.size):h.some(j=>j<=0)?(v.count=1/0,v.done=!0):v.count=Pe(v)),c[f].detail.push({key:l,coxeter:i.coxeter,stellation:i.stellation,mirrors:i.mirrors,dual:g,count:v.count,done:v.done});const b=c[f].aggregated.find(({coxeter:j,stellation:x,mirrors:S})=>$(j,i.coxeter)&&$(x,i.stellation)&&$(S,i.mirrors));b?(b.done=b.done&&v.done,b.count+=v.count,b.key+=","+l):c[f].aggregated.push({key:l,coxeter:i.coxeter,stellation:i.stellation,mirrors:i.mirrors,count:v.count,done:v.done}),u[o]&&v.words&&(c[f].processing+=v.words.size),c[f].count+=v.count,c[f].done=c[f].done&&v.done,c[f].dual=g,c.done=c.done&&v.done}};return t.children.forEach(w),c.size=d?c.root.words.size:c.root.vertices.size,c};let N,W;onmessage=({data:{first:e,space:t,dimensions:n,coxeter:s,stellation:u,mirrors:d,ambiance:g,draw:a,batch:c,hidden:w,reciprocation:i}})=>{var f,r;try{e&&(N=new Map,W=ee(n,s,u,d,t));const o=d.every(y=>!y),l=d.some(y=>xe(y)),h=d.some(y=>ye(y)),v={[n-1]:l,0:!0,1:l||a.edge&&!o,2:l||a.face&&!o},b=je(c,W,N,t,a,o,l&&!h,v);if(h&&je(c,W,N,t,a,o,l,v,b),W.dimensions===2&&(W.currentWords=new Map([[1,""]]),W.facet=Array.from(b.root.words.values()),W.done=!0,N.set("",{...W,subgens:W.subgens,facet:W.facet,subdimensions:W.dimensions,mirrors:W.mirrors}),b[2]={dimensions:2,processing:1,count:0,detail:[{key:"",coxeter:W.coxeter,stellation:W.stellation,mirrors:W.mirrors,count:1,done:!0}],aggregated:[],done:!0}),b[0].done&&(!a.edge||(f=b[1])!=null&&f.done)&&(!a.face||(r=b[2])!=null&&r.done))for(let y of N.values())y.limit=200;const j=He(W,N,t,a,o,l,b,w,i),{infos:x,data:S}=Be(W.dimensions,j,g,a);postMessage({polytope:b,infos:x,data:S},{options:{transfer:[S.flat(1)]}})}catch(o){postMessage({error:o.message})}}})();
