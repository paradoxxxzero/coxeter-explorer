(function(){"use strict";const K=["vertex","edge","face"],E=(e,t=null,n=1,o=!1)=>{if(t===null&&(t=e,e=0),n===0)throw new Error("Step cannot be zero.");if(t<e&&n>0||t>e&&n<0){if(o)return[];n=-n}return new Array(Math.ceil((t-e)/n)).fill().map((g,l)=>e+l*n)},L=(e,t)=>e.length!==t.length?!1:e.every((n,o)=>Array.isArray(n)?L(n,t[o]):n===t[o]),re=e=>e!==""&&e!=="x",N=e=>e==="s"||e==="b",ie=(e,t)=>{let n=0;for(let o=0;o<e.length;o++)n+=e[o]*t[o];return n},pe=(e,t)=>{const n=[];for(let o=0;o<e.length;o++)n[o]=e[o]-t[o];return n},$=(e,t)=>{const n=[];for(let o=0;o<e.length;o++)n[o]=e[o]*t;return n},Se=e=>{const t=[];for(let n=0;n<e[0].length;n++){t.push([]);for(let o=0;o<e.length;o++)t[n].push(e[o][n])}return t},I=(e,t)=>{const n=new Array(e.length);for(let o=0;o<e.length;o++){let g=0;for(let l=0;l<e[0].length;l++)g+=e[o][l]*t[l];n[o]=g}return n},me=e=>{const t=new Array(e.length);for(let n=0;n<e.length;n++)t[n]=new Array(e.length).fill(0),t[n][n]=e[n];return t},U=e=>{const t=new Array(e).fill(1);return me(t)},ee=(e,t)=>e.filter((n,o)=>!t.includes(o)),le=(e,t)=>ee(e,t).map(n=>ee(n,t)),ce=(e,t,n)=>pe(e,$(I(qe(n),t),2*ie(I(Ae(n),e),t))),Me=(e,t)=>t.some((n,o)=>n.some((g,l)=>o===l&&g===0))?$(e,1/e[e.length-1]):$(e,-1/We(fe(ie(I(t,e),e)))),Ae=e=>e.map((t,n)=>t.map((o,g)=>n===g&&o===0?1:o)),qe=e=>e.map(t=>t.map(n=>fe(n))),Q=(e,t,n,o)=>{const g=G/e,l=G/t,a=G/n;return ue(G/Ve(-H(g)*H(a)+R(g)*R(a)*((H(l)-H(o*g)*H(a))/(R(o*g)*R(a)))))},{abs:fe,cos:H,sin:R,tan:Le,cosh:Qe,sinh:Re,acos:Ve,acosh:Ge,atan:Je,atan2:Xe,min:Ye,max:Ze,round:ue,sqrt:We,cbrt:$e,sign:Ie,ceil:et,floor:tt,log:nt,exp:ot,hypot:st,pow:Ce,PI:G}=Math,ge=new ArrayBuffer(8),Oe=new Float64Array(ge),de=new Int32Array(ge);function _e(e){return~~e===e?~~e:(Oe[0]=e,de[0]^de[1])}const he=10**4,te=e=>{let t="";for(let n=0;n<e.length;n++)t+=_e(ue(e[n]*he)/he).toString(),n<e.length-1&&(t+="|");return t},x=e=>String.fromCharCode(97+e),ae=e=>e.charCodeAt(0)-97,T=(e,t,n,o,g,l=[],a=null)=>{let y="";const w=o.map((r,i)=>l.includes(i)||r?"":x(i)).join(""),c={},f=[];if(o.filter(r=>N(r)).length===1){const r=o.findIndex(s=>N(s)),i=(r+1)%e;for(let s=0;s<e;s++)if(!l.includes(s)){const u=x(s);y+=u,f.push(u.repeat(2)),s===r?c[u]=[r,i,r]:c[u]=[s]}for(let s=0;s<e;s++)for(let u=s+1;u<e;u++)if(!l.includes(s)&&!l.includes(u)){let h=t[s][u];if(h<2)continue;s===r&&u===i||s===i&&u===r?h%2===0?f.push((x(s)+x(u)).repeat(h/2)):f.push((x(s)+x(u)).repeat(h)):(u-s>1&&(h=t[u-1][u]),f.push((x(s)+x(u)).repeat(h)))}}else if(o.filter(r=>N(r)).length===2){const r=o.map((s,u)=>N(s)?u:null).filter(s=>s!==null);let i=0;for(let s=0;s<e;s++){const u=x(i);r.some(h=>l.includes(h))||(s===r[0]?(c[u]=r,y+=u,i++,f.push(u.repeat(t[r[0]][r[1]]))):s!==r[1]&&!l.includes(s)&&(f.push(u.repeat(2)),y+=u,i++,c[u]=[s]))}if(l.length===e-1){const s=Object.entries(a).find(([u,h])=>h[0]===0&&!l.includes(h[1]));if(!s)return{gens:null};y=s[0],f.push(y.repeat(2))}else for(let s=0;s<e;s++)for(let u=s+1;u<e;u++)if(!l.includes(s)&&!l.includes(u)&&s===r[0]&&u===r[1]){let h=t[r[1]][E(e).find(z=>!r.includes(z))];if(h<2)continue;h%2===0&&(h/=2),f.push((x(0).toUpperCase()+x(1)+x(0)+x(1)).repeat(h))}}else if(o.some(r=>N(r)))if(l.length===e-1){const r=Object.entries(a).find(([i,s])=>s[0]===0&&!l.includes(s[1]));if(!r)return{gens:null};y=r[0],f.push(y.repeat(2))}else{let r=0;for(let i=0;i<e;i++)for(let s=i+1;s<e;s++){const u=x(r);if(!l.includes(i)&&!l.includes(s)){y+=u,f.push(u.repeat(t[i][s])),c[u]=[i,s];for(let h=0;h<s;h++){const z=[i,s].map(p=>Object.entries(c).find(([V,j])=>j[0]===h&&j[1]===p)).filter(p=>p);z.length===2&&f.push(z[0][0]+z[1][0].toUpperCase()+u)}}r++}}else{for(let r=0;r<e;r++)if(!l.includes(r)){const i=x(r);y+=i,f.push(i.repeat(2)),c[i]=[r]}for(let r=0;r<e;r++)for(let i=r+1;i<e;i++)if(!l.includes(r)&&!l.includes(i)){const s=t[r][i];s>1&&f.push((x(r)+x(i)).repeat(s))}}if(!o.some(r=>N(r))&&!n.every(r=>r.every(i=>i===1))&&g.curvature>0){if(e===4&&n[0][1]>1!=n[2][3]>1&&t[0][1]>3&&t[2][3]>3)[0,1,2,3].some(r=>l.includes(r))||(n[0][1]>1&&f.push("abcdcb".repeat(Q(t[0][1],t[1][2],t[0][2],n[0][1]))),n[2][3]>1&&f.push("abcdcb".repeat(Q(t[2][3],t[1][2],t[1][3],n[2][3]))));else for(let r=1;r<e;r++)for(let i=0;i<r;i++)if(n[i][r]>1){if(i+2<e){const s=Q(t[i+1][r+1],t[i][r],t[i][r+1],n[i][r]);s&&!l.includes(i)&&!l.includes(r)&&!l.includes(i+2)&&f.push((x(i)+x(r)+x(i+2)+x(r)).repeat(s))}if(i-1>=0){const s=Q(t[i-1][r-1],t[i][r],t[i-1][r],n[i][r]);s&&!l.includes(i)&&!l.includes(r)&&!l.includes(i-1)&&f.push((x(i)+x(r)+x(i)+x(i-1)).repeat(s))}}}return{gens:y,subgens:w,rels:f,transforms:a||c}},ne=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+(t-e)*6*n:n<1/2?t:n<2/3?e+(t-e)*(2/3-n)*6:e),M=(e,t,n)=>{let o,g,l;if(t===0)o=g=l=n;else{const a=n<.5?n*(1+t):n+t-n*t,y=2*n-a;o=ne(y,a,e+1/3),g=ne(y,a,e),l=ne(y,a,e-1/3)}return[o,g,l]},J=[[10/360,.56,.91],[0/360,.59,.88],[316/360,.72,.86],[267/360,.84,.81],[343/360,.81,.75],[350/360,.65,.77],[23/360,.92,.75],[41/360,.86,.83],[115/360,.54,.76],[170/360,.57,.73],[189/360,.71,.73],[199/360,.76,.69],[217/360,.92,.76],[232/360,.97,.85]],Ee={background:[0,0,0,1],glow:!1,shading:"ads",diffuse:"lambert",specular:!1,shininess:32,opacity:1,ambient:.2,roughness:.85,gouraud:!1,transparency:"oit",color:({word:e})=>M(e.length*.03%1,.75,.7)},Ne=Object.fromEntries(Object.entries({neon:{background:[0,0,0,1],glow:{exposure:1.75,strength:2,offset:{up:2,down:2},steps:3,pow:2},shading:!1,face:{opacity:.025},transparency:"blend",color:({word:e})=>M(e.length*.17%1,.5,.6)},disco:{background:[0,0,0,1],glow:{exposure:1.5,strength:2,offset:{up:2,down:2},steps:4,pow:2},face:{gouraud:!0,diffuse:"fresnel",opacity:.025},transparency:"blend",color:({word:e})=>M(...J[e.length%J.length])},cathedral:{background:[.6,.6,.6,1],glow:{exposure:1.5,strength:2,offset:{up:2,down:2},steps:4,pow:2},face:{gouraud:!0,opacity:.9},transparency:"oit",color:({word:e,type:t})=>t==="face"?M(e.length*.3%1,1,.6):[0,0,0]},synthwave:{background:[...M(.77,.6,.04),1],glow:{exposure:1.5,strength:3,offset:{up:3,down:3},steps:3,pow:2},shading:!1,face:{opacity:.015},afterImage:.7,transparency:"blend",color:({word:e})=>M((.5-e.length*.05%.5+.65)%1,.4,.6)},colorful:{background:[1,1,1,1],diffuse:"oren-nayar",specular:"cook-torrance",shininess:32,opacity:1,ambient:.2,gouraud:!1,face:{gouraud:!0,opacity:.1,diffuse:"fresnel",specular:!1},transparency:"oit",color:({word:e})=>M(e.length*.03%1,1,.8)},shiny:{background:[0,0,0,1],diffuse:"lambert",specular:"blinn-phong",shininess:32,opacity:1,ambient:.2,gouraud:!1,face:{gouraud:!0,opacity:.1,diffuse:"fresnel",specular:!1},transparency:"oit",color:({word:e})=>M(-(e.length*.07)%1,1,.8)},shape:{background:[1,1,1,1],transparency:"oit",face:{gouraud:!0,opacity:.2,diffuse:"fresnel"},color:({faceSize:e,type:t,idx:n,size:o})=>t==="face"?M((e-2)*.21%1,1,.8):M(n/o,.75,.5)},subShape:{background:[1,1,1,1],transparency:"oit",face:{gouraud:!0,opacity:.2,diffuse:"fresnel"},color:({subShape:e,type:t})=>t!=="vertex"?M(e*.21%1,1,.8):[1,1,1]},reflection:{background:[1,1,1,1],diffuse:"cel",face:{opacity:.6,gouraud:!1},transparency:"blend",color:({word:e,type:t,dimensions:n,draw:o})=>{const g=e.length?ae(e[e.length-1])/n:0;return M(g%1,1,t==="face"?.6:o.face?0:.8)}},harlequin:{background:[...M(240/360,.23,.09),1],face:{opacity:.6},transparency:"oit",color:({word:e,idx:t,type:n})=>{const o=e.split("").map(l=>ae(l)).reduce((l,a)=>l+a,0),g=[...J[o%J.length]];return t%2&&(g[2]*=.5),M(...g)}},pure:{background:[0,0,0,1],color:({word:e})=>M(e.length*.03%1,.75,.7)},facets:{background:[0,0,0,1],color:({faceIndex:e,faceSize:t})=>M(e/t,.75,.7)},monochrome:{background:[.12,.12,.12,1],diffuse:"reverse",ambient:0,face:{opacity:.1},transparency:"oit",color:()=>[1,1,1]},plain:{extended:!0,background:[1,1,1,1],glow:!1,shading:!1,color:({word:e,type:t,draw:n})=>M(e.length*.06%1,1,t==="face"?.6:n.face?.05:.5)},plainblack:{extended:!0,background:[1,1,1,1],shading:!1,color:({word:e,type:t})=>t==="face"?new Array(3).fill(1-Ce(.9,e.length+1)):[0,0,0]},normals:{extended:!0,background:[1,1,1,1],shading:"normal",color:()=>[0,0,0]},uvs:{extended:!0,background:[1,1,1,1],shading:"uv",color:()=>[0,0,0]}}).map(([e,t])=>[e,{...Ee,...t,transparent:{}}])),Fe=e=>{const t=e.toUpperCase();return e===t?e.toLowerCase():t},_=(e,t)=>{let n=t,o=0;for(;e.quotientMap[n];)o++,n=e.quotientMap[n];return o>1&&(e.quotientMap[t]=n),n},ye=(e,t,n)=>{const o=t,g=[[t,n]];for(;g.length>0;)if([t,n]=g.pop(),t>n&&([t,n]=[n,t]),t=_(e,t),n=_(e,n),t!==n){e.quotientMap[n]=t,e.seen.has(n)&&!e.seen.has(t)&&e.seen.add(t);const l=e.cosets.get(t),a=e.cosets.get(n);e.cosets.delete(n);for(const[y,w]of a)l.has(y)?g.push([l.get(y),w]):l.set(y,w)}return _(e,o)},we=(e,t,n,o)=>{t=_(e,t);const g=e.cosets.get(t);g.has(n)?ye(e,g.get(n),o):g.set(n,o)},X=(e,t,n,o)=>{t=_(e,t);let g;const l=e.cosets.get(t);return l.has(n)?(g=_(e,l.get(n)),o!==void 0&&g!==o&&ye(e,o,g)):(o?g=o:(g=e.nextVertex++,e.cosets.set(g,new Map),e.unvisited.push(g)),we(e,t,n,g),we(e,g,Fe(n),t)),g},be=function(e,t,n){let o=n;for(let g=t.length-1;g>0;g--)o=X(e,o,t[g]);X(e,o,t[0],n)},Be=function(e){if(!e.words){const t=_(e,1);e.words=new Map,e.words.set(t,""),e.currentWords=new Map,e.currentWords.set(t,""),e.lastCoset=t,e.remaining=[t],e.rootVertex&&e.rootNormals&&e.metric&&(e.vertices=new Map,e.vertices.set(t,e.rootVertex))}for(;e.remaining.length>0;){const t=e.remaining[0],n=_(e,t),o=e.cosets.get(n),g=e.words.get(n);if(o.size<e.gens.length*2)return;const l=[];for(let a=0;a<e.gens.length;a++){const y=e.gens[a],w=_(e,o.get(y));if(!e.words.has(w)){if(e.cosets.get(w).size<e.gens.length*2)return;l.push([y,w])}}e.remaining.shift();for(let a=0;a<l.length;a++){const[y,w]=l[a],c=y+g;if(e.words.set(w,c),e.currentWords.set(w,c),e.lastCoset=w,e.remaining.push(w),e.vertices){let f=e.vertices.get(n);for(let r=0;r<e.transforms[y].length;r++){const i=e.transforms[y][r];f=ce(f,e.rootNormals[i],e.metric)}e.vertices.set(w,f)}}}},je=(e,t)=>{let n=_(e,1);for(let o=t.length-1;o>=0;o--){const g=e.cosets.get(n);if(g.size<e.gens.length*2||(n=_(e,g.get(t[o])),e.cosets.get(n).size<e.gens.length*2))return}return n},ve=e=>{if(!e.cosets){e.unvisited=[1],e.cosets=new Map([[1,new Map]]),e.nextVertex=2,e.seen=new Set,e.quotientMap={};for(let t=0;t<e.subgens.length;t++)be(e,e.subgens[t],1)}e.limit=e.limit||1e3,e.done=!1;for(let t=0;t<e.limit;t++){let n=null;for(;e.unvisited.length>0;){const o=_(e,e.unvisited.shift());if(!e.seen.has(o)){e.seen.add(o),n=o;break}}if(n===null){e.done=!0;break}for(let o=0;o<e.gens.length;o++)X(e,n,e.gens[o].toUpperCase()),X(e,n,e.gens[o]);for(let o=0;o<e.rels.length;o++)be(e,e.rels[o],n)}},Pe=e=>(ve(e),e.cosets.size),xe=e=>(ve(e),Be(e),e),Ue=(e,t,n)=>{if(t===0)return!0;if(e.length<=t)return!1;const o=new Set;for(let g=0;g<e.length;g++){const l=e[g];if(l)for(let a=0;a<l.length;a++){const y=l[a];for(let w=0;w<n[y].length;w++){const c=x(n[y][w]);o.has(c)||o.add(c)}if(o.size>=t)return!0}}return!1},ke=(e,t,n,o,g,l)=>{const a=E(g).filter(c=>!l.includes(c));let y="";if(e.some(c=>N(c))&&t.gens.length)for(let c=0;c<t.gens.length;c++){const f=t.gens[c],r=n[o.transforms[f][0]][o.transforms[f][1]];((t.dimensions===1?r===2:r>2)||o.transforms[f].some(i=>!e[i]))&&(y+=f)}else for(let c=0;c<g;c++)(!l.includes(c)||re(e[c])&&!e[c]&&!a.some(f=>n[f][c]!==2))&&(y+=x(c));return y},oe=(e,t,n,o,g,l=null,a=null,y=new Map)=>{const w=!a;o.every(c=>!c)&&(o=o.map(()=>1)),l=l||o.map((c,f)=>re(c)?null:f).filter(c=>c!==null),a=a||{new:!0,key:"",dimensions:e,coxeter:t,stellation:n,mirrors:o,skips:l,...T(e,t,n,o,g,l),quotient:"",facet:[""],children:[]};for(let c=0;c<e;c++){if(l.includes(c)||l.includes("s"))continue;const f=[...l,c];E(e).filter(h=>!f.includes(h));const r=f.sort().join("-");let i=!1;if(!y.has(r)){i=!0;const h={key:r,dimensions:e-f.length,coxeter:le(t,f),stellation:le(n,f),mirrors:ee(o,f),skips:f,...T(e,t,n,o,g,f,a.transforms)};if(h.gens===null)continue;xe(h),y.set(r,h)}const s=y.get(r),u=Array.from(s.words.values());if(Ue(u,s.dimensions,s.transforms)){let h=ke(o,s,t,a,e,f),z={new:i,...s,quotient:h,facet:u,children:[]};s.dimensions>0&&(z=oe(e,t,n,o,g,f,z,y)),a.children.push(z)}}if(a.children.length===0&&e-l.length>1){console.info("No leaf found, digging deeper",l);for(let c=0;c<e;c++){if(l.includes(c))continue;const f=[...l,c],r=f.sort().join("-");let s={new:!1,...y.get(r),quotient:"",facet:[""],children:[]};s=oe(e,t,n,o,g,f,s,y),a.children.push(s)}}if(w&&o.some(c=>N(c))){let c=[];for(let f=1;f<e;f++){const r=[...l,...E(e-f).map(()=>"0s")],i=e-r.length;if(f===1){const s=[],u=b=>{b.children.forEach(u),b.dimensions===1&&b.new&&s.push(b)};u(a);const h=Object.entries(a.transforms).filter(([b,m])=>m.every(A=>o[A])).map(([b])=>b);for(let b=0;b<s.length;b++){const m=s[b];h.includes(m.gens)&&h.splice(h.indexOf(m.gens),1)}const z=c;c=[];const p=U(i).map((b,m)=>b.map((A,d)=>m===d?1:m===d+1||m===d-1?4:2)),V=U(i).map(b=>b.map(()=>1)),j=E(i).map(()=>"s");for(let b=0;b<h.length;b++){const m=h[b];r[r.length-1]=b+"s";const A={key:r.join("-"),dimensions:i,coxeter:p,stellation:V,mirrors:j,skips:r,...T(i,p,V,j,g,r,a.transforms)};A.gens=m;const d={new:!0,key:r.join("-"),dimensions:i,coxeter:p,stellation:V,mirrors:j,skips:r,...A,quotient:ke(o,A,t,a,e,r),facet:["",m],children:b===0?z:[]};c.push(d)}}else if(f===2){const s=U(i).map((j,b)=>j.map((m,A)=>b===A?1:b===A+1||b===A-1?3:2)),u=U(i).map(j=>j.map(()=>1)),h=E(i).map(()=>"s"),z=[];let p=0;for(let j=0;j<e;j++)for(let b=j+1;b<e;b++){const m=x(p);for(let A=0;A<b;A++){const d=[j,b].map(v=>Object.entries(a.transforms).find(([W,C])=>C[0]===A&&C[1]===v)).filter(v=>v);d.length===2&&z.push(["",d[1][0],m])}p++}const V=c;c=[];for(let j=0;j<z.length;j++){r[r.length-1]=j+"s";const b={new:!0,key:r.join("-"),dimensions:i,coxeter:s,stellation:u,mirrors:h,skips:r,...T(i,s,u,h,g,r,a.transforms),quotient:"",facet:z[j],children:j===0?V:[]};c.push(b)}}else{const s=U(i).map((V,j)=>V.map((b,m)=>j===m?1:2)),u=U(i).map(V=>V.map(()=>1)),h=E(i).map(()=>"s"),z=c;c=[];const p={new:!0,key:r.join("-"),dimensions:i,coxeter:s,stellation:u,mirrors:h,skips:r,...T(i,s,u,h,g,r,a.transforms),facet:[""],quotient:"",children:z};c.push(p)}}a.children.push(...c)}return a},He=(e,t,n)=>{const o=[],g=[],l=[];for(const[a,y]of e.currentWords){let w;if(y===""){const c=Se(n.rootVertices);e.fundamentalVertices=new Map,w=E(t.dimensions).map(f=>Me(c[f],n.metric)),e.hashes={vertex:new Set,edge:new Set,face:new Set},e.fundamentalVertices.set("",w)}else{w=[...e.fundamentalVertices.get(y.slice(1))];const c=e.gens.indexOf(y[0]);for(let f=0;f<w.length;f++)w[f]=ce(w[f],n.rootNormals[c],n.metric)}for(let c=0;c<w.length;c++){const f=te(w[c]);e.hashes.vertex.has(f)||(o.push({word:y,cosetId:a,vertices:[w[c]]}),e.hashes.vertex.add(f));for(let r=c+1;r<w.length;r++){const i=[w[c],w[r]].sort((s,u)=>{for(let h=0;h<s.length;h++){if(s[h]<u[h])return-1;if(s[h]>u[h])return 1}return 0}).map(s=>te(s)).join("-");e.hashes.edge.has(i)||(g.push({word:y,cosetId:a,vertices:[w[c],w[r]]}),e.hashes.edge.add(i));for(let s=r+1;s<w.length;s++){const u=[w[c],w[r],w[s]].sort((h,z)=>{for(let p=0;p<h.length;p++){if(h[p]<z[p])return-1;if(h[p]>z[p])return 1}return 0}).map(h=>te(h)).join("-");e.hashes.face.has(u)||(l.push({word:y,cosetId:a,vertices:[w[c],w[r],w[s]]}),e.hashes.face.add(u))}}e.fundamentalVertices.set(y,w)}e.currentWords.delete(a)}return[o,g,l]},Te=(e,t,n=!1,o=!1)=>{if(n){if(o)return e;const g=e>0?1-e%2:0;return e>=t/2+g?2*(t-e)-1+g:2*e-g}return e>=t/2?2*(t-e)-1:2*e},De=(e,t,n)=>{const o=[],g=[];if(e.subdimensions===0)for(const[l,a]of e.currentWords)o.push({word:a,vertices:[e.vertices.get(l)]}),e.currentWords.delete(l);else if(e.subdimensions===1)for(const[l,a]of e.currentWords){const y={word:a,vertices:[]};for(let w=0;w<e.facet.length;w++){const c=je(n,a+e.facet[w]);c&&n.vertices.has(c)&&y.vertices.push(n.vertices.get(c))}y.vertices.length<2||(o.push(y),e.currentWords.delete(l))}else if(e.subdimensions===2)for(const[l,a]of e.currentWords){const y=e.mirrors.every(s=>!!s),w=e.mirrors.some(s=>N(s)),c=a.length%2?0:1,f=[];for(let s=0;s<e.facet.length;s++){const u=Te(s,e.facet.length,y,w),h=je(n,a+e.facet[u]);h&&n.vertices.has(h)&&f.push(n.vertices.get(h))}if(f.length<3)continue;const r=f.length<e.facet.length;if(f.length===3){c&&([f[2],f[1]]=[f[1],f[2]]);const s={word:a,vertices:f,faceIndex:0,faceSize:3,partial:r};r?g.push(s):(o.push(s),e.currentWords.delete(l));continue}const i=new Array(t.dimensions).fill(0);for(let s=0;s<f.length;s++){const u=f[s];for(let h=0;h<u.length;h++)i[h]+=u[h]}for(let s=0;s<t.dimensions;s++)i[s]/=f.length;for(let s=0;s<f.length;s++){const u={word:a,vertices:[f[(s+c)%f.length],f[(s+(1-c))%f.length],i],faceIndex:s,faceSize:f.length,partial:r};r?g.push(u):(o.push(u),e.currentWords.delete(l))}}return{objects:o,partials:g}};let F,D,S;onmessage=({data:{first:e,space:t,dimensions:n,coxeter:o,stellation:g,mirrors:l,ambiance:a,draw:y,batch:w,hidden:c}})=>{var f,r;try{let i=!0;e&&(F=new Map,D=[0,0,0],S=oe(n,o,g,l,t));const s=E(S.dimensions).join("-"),u=[],h=l.every(d=>!d),z={0:!0,1:y.edge&&!h,2:y.face&&!h},p=d=>{d.children.forEach(p);const v=z[d.dimensions],W=K[d.dimensions];if(d!=null&&d.new){u[d.dimensions]||(u[d.dimensions]={dimensions:d.dimensions,processing:y[W]?0:void 0,count:0,detail:[],aggregated:[],done:!0});const C=t.eigens.values;if(F.has(d.key))F.get(d.key).keys.push(d.key);else{let O=v?w:5;W==="edge"&&t.curvature<=0&&(O*=1.5);const P={...S,keys:[d.key],subgens:d.quotient,facet:d.facet,subdimensions:d.dimensions,mirrors:d.mirrors,limit:O,...d.dimensions===0&&!h?{rootVertex:t.rootVertex,rootNormals:t.rootNormals,metric:t.metric}:{}};F.set(d.key,P)}const k=F.get(d.key);k.done||(v?(xe(k),C.some(O=>O<=0)?k.count=1/0:k.count=k.cosets.size):C.some(O=>O<=0)?(k.count=1/0,k.done=!0):k.count=Pe(k)),u[d.dimensions].detail.push({key:d.key,coxeter:d.coxeter,stellation:d.stellation,mirrors:d.mirrors,count:k.count,done:k.done});const q=u[d.dimensions].aggregated.find(({coxeter:O,stellation:P,mirrors:B})=>L(O,d.coxeter)&&L(P,d.stellation)&&L(B,d.mirrors));q?(q.done=q.done&&k.done,q.count+=k.count,q.key+=","+d.key):u[d.dimensions].aggregated.push({key:d.key,coxeter:d.coxeter,stellation:d.stellation,mirrors:d.mirrors,count:k.count,done:k.done}),y[W]&&k.words&&(u[d.dimensions].processing+=k.words.size),u[d.dimensions].count+=k.count,u[d.dimensions].done=u[d.dimensions].done&&k.done,i=i&&k.done}};S.children.forEach(p);const V=F.get(s);if(S.dimensions===2&&(S.currentWords=new Map([[1,""]]),S.facet=Array.from(V.words.values()),S.done=!0,F.set("",{...S,subgens:S.subgens,facet:S.facet,subdimensions:S.dimensions,mirrors:S.mirrors}),u[2]={dimensions:2,processing:1,count:0,detail:[{key:"",coxeter:S.coxeter,stellation:S.stellation,mirrors:S.mirrors,count:1,done:!0}],aggregated:[],done:!0}),u[0].done&&(!y.edge||(f=u[1])!=null&&f.done)&&(!y.face||(r=u[2])!=null&&r.done))for(let d of F.values())d.limit=200;const j=[];if(h){const d=He(V,S,t);for(let v=0;v<d.length;v++)y[K[v]]?(j.push({start:D[v],size:d[v].length,objects:[d[v]],partials:[]}),D[v]+=d[v].length):j.push(null)}else for(let d=0;d<3;d++){if(!y[K[d]]||!u[d]){j.push(null);continue}const v={start:D[d],size:0,objects:[],partials:[]};for(let W=0;W<u[d].detail.length;W++){const C=u[d].detail[W];if(c.includes(C.key))continue;const k=F.get(C.key);if(k.currentWords.size){const{objects:q,partials:O}=De(k,S,V);v.objects.push(q),v.size+=q.length+O.length,D[d]+=q.length,v.partials.push(O)}}j.push(v)}const b=[],m=[],A=S.dimensions>4?9:S.dimensions;for(let d=0;d<j.length;d++){const v=j[d];if(!v){b.push(null),m.push(null);continue}const W=[new Float32Array(v.size*3)];for(let q=0;q<d+1;q++)W.push(new Float32Array(v.size*A));let C=0;const k=v.objects.concat(v.partials);for(let q=0;q<k.length;q++){const O=k[q];for(let P=0;P<O.length;P++){const B=O[P];for(let Y=0;Y<B.vertices.length;Y++){const ze=B.vertices[Y];for(let Z=0;Z<ze.length;Z++)W[Y+1][C*A+Z]=ze[Z]}const se=Ne[a].color({word:B.word,key:B.key,subShape:q%v.objects.length,faceIndex:B.faceIndex,faceSize:B.faceSize,dimensions:S.dimensions,draw:y,idx:C,size:v.size,type:K[d]});W[0][C*3+0]=se[0],W[0][C*3+1]=se[1],W[0][C*3+2]=se[2],C++}}b.push(W),m.push({start:v.start,size:v.size})}u.size=h?V.words.size:V.vertices.size,u.done=i,postMessage({polytope:u,infos:m,data:b},{options:{transfer:[b.flat(1)]}})}catch(i){postMessage({error:i.message})}}})();
