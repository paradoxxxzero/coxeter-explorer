(function(){"use strict";const F=e=>e!==""&&e!=="x",je=e=>e==="m"||e==="b"||e==="c"||e==="d",xe=e=>e==="c"||e==="d",O=e=>e==="s"||e==="b"||e==="d",m=(e,t=null,n=1,s=!1)=>{if(t===null&&(t=e,e=0),n===0)throw new Error("Step cannot be zero.");if(t<e&&n>0||t>e&&n<0){if(s)return[];n=-n}return new Array(Math.ceil((t-e)/n)).fill().map((f,h)=>e+h*n)},T=(e,t)=>e.length!==t.length?!1:e.every((n,s)=>Array.isArray(n)?T(n,t[s]):n===t[s]),R=(e,t)=>{let n=0;for(let s=0;s<e.length;s++)n+=e[s]*t[s];return n},D=(e,t)=>{const n=[];for(let s=0;s<e.length;s++)n[s]=e[s]+t[s];return n},ye=(e,t)=>{const n=[];for(let s=0;s<e.length;s++)n[s]=e[s]-t[s];return n},q=(e,t)=>{const n=[];for(let s=0;s<e.length;s++)n[s]=e[s]*t;return n},ke=e=>{const t=[];for(let n=0;n<e[0].length;n++){t.push([]);for(let s=0;s<e.length;s++)t[n].push(e[s][n])}return t},H=(e,t)=>{const n=new Array(e.length);for(let s=0;s<e.length;s++){let f=0;for(let h=0;h<e[0].length;h++)f+=e[s][h]*t[h];n[s]=f}return n},ze=e=>{const t=new Array(e.length);for(let n=0;n<e.length;n++)t[n]=new Array(e.length).fill(0),t[n][n]=e[n];return t},I=e=>{const t=new Array(e).fill(1);return ze(t)},X=(e,t)=>e.filter((n,s)=>!t.includes(s)),se=(e,t)=>X(e,t).map(n=>X(n,t)),oe=(e,t,n)=>ye(e,q(H(Ve(n),t),2*R(H(Se(n),e),t))),re=(e,t)=>t.some((n,s)=>n.some((f,h)=>s===h&&f===0))?q(e,1/e[e.length-1]):q(e,-1/Ae(ie(R(H(t,e),e)))),Se=e=>e.map((t,n)=>t.map((s,f)=>n===f&&s===0?1:s)),Ve=e=>e.map(t=>t.map(n=>ie(n))),L=(e,t,n,s)=>{const f=Q/e,h=Q/t,d=Q/n;return ce(Q/Ce(-N(f)*N(d)+$(f)*$(d)*((N(h)-N(s*f)*N(d))/($(s*f)*$(d)))))},{abs:ie,cos:N,sin:$,tan:Qe,cosh:Ge,sinh:Je,acos:Ce,acosh:Ke,atan:Xe,atan2:Ye,min:Ze,max:pe,round:ce,sqrt:Ae,cbrt:et,sign:tt,ceil:nt,floor:st,log:ot,exp:rt,hypot:it,pow:Me,PI:Q}=Math,We=(...e)=>e.reduce((t,n)=>t+n,0)/e.length,le=new ArrayBuffer(8),Oe=new Float64Array(le),fe=new Int32Array(le);function qe(e){return~~e===e?~~e:(Oe[0]=e,fe[0]^fe[1])}const ue=10**4,Y=e=>{let t="";for(let n=0;n<e.length;n++)t+=qe(ce(e[n]*ue)/ue).toString(),n<e.length-1&&(t+="|");return t},C=e=>String.fromCharCode(97+e),ge=e=>e.charCodeAt(0)-97,Z=(e,t="",n=[])=>{const s=[];for(let f=0;f<e.length;f++){const[h,d]=e[f],a=e.filter((l,w)=>w!==f);if(n.length){const l=n[n.length-1];if(d.some(w=>w===l)){const w=d[1]===l,i=w?h.toUpperCase():h,c=w?[...d].reverse():d;if(c[1]===n[0])return[t+i];a.length&&s.push(...Z(a,t+i,n.concat(c.slice(1))))}}else s.push(...Z(a,h,d))}return s},U=(e,t,n,s,f,h=[])=>{let d="";const a=s.map((r,o)=>h.includes(o)||r?"":C(o)).join(""),l={},w=[];for(let r=0;r<e;r++)if(!h.includes(r)){if(!O(s[r])){const o=C(r);d+=o,l[o]=[r],w.push(o.repeat(2))}for(let o=r+1;o<e;o++){if(h.includes(o))continue;const g=t[r][o];if(O(s[r])&&O(s[o])){const u=C((r+1)*e+o);d+=u,l[u]=[r,o],w.push(u.repeat(g))}else if(O(s[r])&&!O(s[o])){const u=C((r+1)*e+o);d+=u,l[u]=[r,o,r],w.push(u.repeat(2)),w.push((u+C(o)).repeat(g%2===0?g/2:g))}else if(!O(s[r])&&O(s[o])){const u=C((r+1)*e+o);d+=u,l[u]=[o,r,o],w.push(u.repeat(2)),w.push((u+C(r)).repeat(g%2===0?g/2:g))}else g>1&&w.push((C(r)+C(o)).repeat(g))}}const i=Object.entries(l).filter(([r,o])=>o.length===3),c=Object.entries(l).filter(([r,o])=>o.length===2);if(c.length>1){const r=Z(c);w.push(...r.map(o=>o.split("").reverse().join("")))}if(i.length>1)for(let r=0;r<i.length;r++){const[o,g]=i[r];for(let u=r+1;u<i.length;u++){const[v,j]=i[u];if(g[1]===j[1]){const z=c.find(([k,y])=>y[0]===g[0]&&y[1]===j[0]);if(z){const k=z[0];w.push(o.toUpperCase()+k.toUpperCase()+v+k)}}else if(g[0]===j[0]){const z=t[g[1]][j[1]];z>1&&w.push((o+v).repeat(z))}}}if(!s.some(r=>O(r))&&!n.every(r=>r.every(o=>o===1))&&f.curvature>0){if(e===4&&n[0][1]>1!=n[2][3]>1&&t[0][1]>3&&t[2][3]>3)[0,1,2,3].some(r=>h.includes(r))||(n[0][1]>1&&w.push("abcdcb".repeat(L(t[0][1],t[1][2],t[0][2],n[0][1]))),n[2][3]>1&&w.push("abcdcb".repeat(L(t[2][3],t[1][2],t[1][3],n[2][3]))));else for(let r=1;r<e;r++)for(let o=0;o<r;o++)if(n[o][r]>1){if(o+2<e){const g=L(t[o+1][r+1],t[o][r],t[o][r+1],n[o][r]);g&&!h.includes(o)&&!h.includes(r)&&!h.includes(o+2)&&w.push((C(o)+C(r)+C(o+2)+C(r)).repeat(g))}if(o-1>=0){const g=L(t[o-1][r-1],t[o][r],t[o-1][r],n[o][r]);g&&!h.includes(o)&&!h.includes(r)&&!h.includes(o-1)&&w.push((C(o)+C(r)+C(o)+C(o-1)).repeat(g))}}}return{gens:d,subgens:a,rels:w,transforms:l}},Ee=e=>{const t=e.toUpperCase();return e===t?e.toLowerCase():t},W=(e,t)=>{let n=t,s=0;for(;e.quotientMap[n];)s++,n=e.quotientMap[n];return s>1&&(e.quotientMap[t]=n),n},de=(e,t,n)=>{const s=t,f=[[t,n]];for(;f.length>0;)if([t,n]=f.pop(),t>n&&([t,n]=[n,t]),t=W(e,t),n=W(e,n),t!==n){e.quotientMap[n]=t,e.seen.has(n)&&!e.seen.has(t)&&e.seen.add(t);const h=e.cosets.get(t),d=e.cosets.get(n);e.cosets.delete(n);for(const[a,l]of d)h.has(a)?f.push([h.get(a),l]):h.set(a,l)}return W(e,s)},he=(e,t,n,s)=>{t=W(e,t);const f=e.cosets.get(t);f.has(n)?de(e,f.get(n),s):f.set(n,s)},G=(e,t,n,s)=>{t=W(e,t);let f;const h=e.cosets.get(t);return h.has(n)?(f=W(e,h.get(n)),s!==void 0&&f!==s&&de(e,s,f)):(s?f=s:(f=e.nextVertex++,e.cosets.set(f,new Map),e.unvisited.push(f)),he(e,t,n,f),he(e,f,Ee(n),t)),f},ae=function(e,t,n){let s=n;for(let f=t.length-1;f>0;f--)s=G(e,s,t[f]);G(e,s,t[0],n)},me=function(e){if(!e.words){const t=W(e,1);e.words=new Map,e.words.set(t,""),e.currentWords=new Map,e.currentWords.set(t,""),e.lastCoset=t,e.remaining=[t],e.rootVertex&&e.rootNormals&&e.metric&&(e.vertices=new Map,e.vertices.set(t,e.rootVertex))}for(;e.remaining.length>0;){const t=e.remaining[0],n=W(e,t),s=e.cosets.get(n),f=e.words.get(n);if(s.size<e.gens.length*2)return;const h=[];for(let d=0;d<e.gens.length;d++){const a=e.gens[d],l=W(e,s.get(a));if(!e.words.has(l)){if(e.cosets.get(l).size<e.gens.length*2)return;h.push([a,l])}}e.remaining.shift();for(let d=0;d<h.length;d++){const[a,l]=h[d],w=a+f;if(e.words.set(l,w),e.currentWords.set(l,w),e.lastCoset=l,e.remaining.push(l),e.vertices){let i=e.vertices.get(n);for(let c=0;c<e.transforms[a].length;c++){const r=e.transforms[a][c];i=oe(i,e.rootNormals[r],e.metric)}e.vertices.set(l,i)}}}},_=(e,t)=>{let n=W(e,1);for(let s=t.length-1;s>=0;s--){const f=e.cosets.get(n);if(f.size<e.gens.length*2||(n=W(e,f.get(t[s])),e.cosets.get(n).size<e.gens.length*2))return}return n},ve=e=>{if(!e.cosets){e.unvisited=[1],e.cosets=new Map([[1,new Map]]),e.nextVertex=2,e.seen=new Set,e.quotientMap={};for(let t=0;t<e.subgens.length;t++)ae(e,e.subgens[t],1)}e.limit=e.limit||1e3,e.done=!1;for(let t=0;t<e.limit;t++){let n=null;for(;e.unvisited.length>0;){const s=W(e,e.unvisited.shift());if(!e.seen.has(s)){e.seen.add(s),n=s;break}}if(n===null){e.done=!0;break}for(let s=0;s<e.gens.length;s++)G(e,n,e.gens[s].toUpperCase()),G(e,n,e.gens[s]);for(let s=0;s<e.rels.length;s++)ae(e,e.rels[s],n)}},Ie=e=>(ve(e),e.cosets.size),we=e=>(ve(e),me(e),e),_e=(e,t,n)=>{if(t===0)return!0;if(e.length<=t)return!1;const s=new Set;for(let f=0;f<e.length;f++){const h=e[f];if(h)for(let d=0;d<h.length;d++){const a=h[d];for(let l=0;l<n[a].length;l++){const w=C(n[a][l]);s.has(w)||s.add(w)}if(s.size>=t)return!0}}return!1},p=(e,t,n,s,f)=>{const h=m(n.length).filter(i=>!f.includes(i));let d="";const a=Object.entries(s),l=a.filter(([i,c])=>c.length===1),w=a.filter(([i,c])=>c.length===3);for(let i=0;i<a.length;i++){const[c,r]=a[i];if(r.length===1){const o=r[0];if(!f.includes(o)&&!w.some(([g,u])=>u[1]===o)){d+=c;continue}if(!F(e[o]))continue;!e[o]&&!h.some(g=>n[g][o]!==2)&&(d+=c)}else if(r.length===2){const o=r[0],g=r[1],u=n[o][g];if(t.gens.includes(c)&&(t.dimensions===1?u===2:u>2)){d+=c;continue}if(!F(e[o])||!F(e[g]))continue}else if(r.length===3&&f.length&&typeof f[f.length-1]=="string"&&f[f.length-1].includes("s")){const o=r[0],g=r[1],u=n[o][g],v=f[f.length-1].split("s").filter(j=>j);for(let j=0;j<v.length;j++){const z=v[j],k=s[Object.keys(s)[z]];if(k.length===3&&r[1]===k[1]){const y=n[k[0]][k[1]];if((t.dimensions===1?![2,4].includes(u)||[2,4].includes(y):u!==2)&&(d+=c),l.find(([x,S])=>k.every(V=>V!==S[0]))){const x=l.find(([S,V])=>V[0]===k[1]);x&&(d+=x[0])}}}}}return d},ee=(e,t,n,s,f,h=null,d=null,a=null,l=new Map)=>{const w=!d;s.every(i=>!i)&&(s=s.map(()=>1)),h=h||s.map((i,c)=>F(i)?null:c).filter(i=>i!==null),d=d||{new:!0,key:"",dimensions:e,coxeter:t,stellation:n,mirrors:s,skips:h,...U(e,t,n,s,f,h),quotient:"",facet:[""],children:[]},a=a||d.transforms;for(let i=0;i<e;i++){if(h.includes(i)||h.includes("s"))continue;const c=[...h,i],r=c.sort().join("-");let o=!1;if(!l.has(r)){o=!0;const v={key:r,dimensions:e-c.length,coxeter:se(t,c),stellation:se(n,c),mirrors:X(s,c),skips:c,...U(e,t,n,s,f,c)};if(v.gens===null)continue;we(v),l.set(r,v)}const g=l.get(r),u=Array.from(g.words.values());if(_e(u,g.dimensions,g.transforms)){let v=p(s,g,t,a,c),j={new:o,...g,quotient:v,facet:u,children:[]};g.dimensions>0&&(j=ee(e,t,n,s,f,c,j,a,l)),d.children.push(j)}}if(d.children.length===0&&e-h.length>1){console.debug("No leaf found, digging deeper",h);for(let i=0;i<e;i++){if(h.includes(i))continue;const c=[...h,i],r=c.sort().join("-");let g={new:!1,...l.get(r),quotient:"",facet:[""],children:[]};g=ee(e,t,n,s,f,c,g,a,l),d.children.push(g)}}if(w&&s.some(i=>O(i))){let i=[];for(let c=1;c<e;c++){const r=[...h,...m(e-c).map(()=>"s")],o=e-r.length;if(c===1){const g=[],u=b=>{b.children.forEach(u),b.dimensions===1&&b.new&&g.push(b)};u(d);const v=Object.entries(d.transforms).filter(([b,x])=>x.length!==1||s[x[0]]).filter(([b,x])=>x.length!==3||t[x[0]][x[1]]!==2).map(([b])=>b);for(let b=0;b<g.length;b++){const x=g[b];v.includes(x.gens)&&v.splice(v.indexOf(x.gens),1)}const j=i;i=[];const z=I(o).map((b,x)=>b.map((S,V)=>x===V?1:x===V+1||x===V-1?4:2)),k=I(o).map(b=>b.map(()=>1)),y=m(o).map(()=>"s");for(let b=0;b<v.length;b++){const x=v[b];r[r.length-1]=d.gens.indexOf(x)+"s";const S={key:r.join("-"),dimensions:o,coxeter:z,stellation:k,mirrors:y,skips:r,...U(o,z,k,y,f,r)};S.gens=x;const V={new:!0,...S,quotient:p(s,S,t,a,r),facet:["",x],children:b===0?j:[]};i.push(V)}}else if(c===2){const g=I(o).map((b,x)=>b.map((S,V)=>x===V?1:x===V+1||x===V-1?3:2)),u=I(o).map(b=>b.map(()=>1)),v=m(o).map(()=>"s"),j=[],z=Object.entries(d.transforms).filter(([b,x])=>x.length>=2).filter(([b,x])=>x.length!==3||t[x[0]][x[1]]!==2),k=Object.entries(d.transforms).filter(([b,x])=>x.length===1);for(let b=0;b<z.length;b++){const[x,S]=z[b];for(let V=b+1;V<z.length;V++){const[K,E]=z[V];S[S.length-1]===E[E.length-1]&&j.push(["",x,K]),S.length!==E.length&&(S.length===2&&S[0]===E[2]||S.length===3&&S[2]===E[0])&&j.push(["",x.toUpperCase(),K.toUpperCase()])}if(S.length===3)for(let V=0;V<k.length;V++){const[K,E]=k[V];S.every(Le=>Le!==E[0])&&j.push(["",x,K+x])}}const y=i;i=[],j.length||j.push([""]);for(let b=0;b<j.length;b++){const x=j[b];r[r.length-1]=x.length===1?"s":d.gens.indexOf(x[1].toLowerCase())+"s"+d.gens.indexOf(x[2].replace(x[1],"").toLowerCase());const S={key:r.join("-"),dimensions:o,coxeter:g,stellation:u,mirrors:v,skips:r,...U(o,g,u,v,f,r)},V={new:!0,...S,quotient:p(s,S,t,a,r),facet:x,children:b===0?y:[]};i.push(V)}}else{const g=I(o).map((k,y)=>k.map((b,x)=>y===x?1:2)),u=I(o).map(k=>k.map(()=>1)),v=m(o).map(()=>"s"),j=i;i=[];const z={new:!0,key:r.join("-"),dimensions:o,coxeter:g,stellation:u,mirrors:v,skips:r,...U(o,g,u,v,f,r),facet:[""],quotient:"",children:j};i.push(z)}}d.children.push(...i)}return d},B=["vertex","edge","face"],te=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+(t-e)*6*n:n<1/2?t:n<2/3?e+(t-e)*(2/3-n)*6:e),A=(e,t,n)=>{let s,f,h;if(t===0)s=f=h=n;else{const d=n<.5?n*(1+t):n+t-n*t,a=2*n-d;s=te(a,d,e+1/3),f=te(a,d,e),h=te(a,d,e-1/3)}return[s,f,h]},J=[[10/360,.56,.91],[0/360,.59,.88],[316/360,.72,.86],[267/360,.84,.81],[343/360,.81,.75],[350/360,.65,.77],[23/360,.92,.75],[41/360,.86,.83],[115/360,.54,.76],[170/360,.57,.73],[189/360,.71,.73],[199/360,.76,.69],[217/360,.92,.76],[232/360,.97,.85]],Pe={background:[0,0,0,1],glow:!1,shading:"ads",diffuse:"lambert",specular:!1,shininess:32,opacity:1,ambient:.2,roughness:.85,gouraud:!1,transparency:"oit",color:({word:e})=>A(e.length*.03%1,.75,.7)},Ne=Object.fromEntries(Object.entries({neon:{background:[0,0,0,1],glow:{exposure:1.75,strength:2,offset:{up:2,down:2},steps:3,pow:2},shading:!1,face:{opacity:.025},transparency:"blend",color:({word:e})=>A(e.length*.17%1,.5,.6)},disco:{background:[0,0,0,1],glow:{exposure:1.5,strength:2,offset:{up:2,down:2},steps:4,pow:2},face:{gouraud:!0,diffuse:"fresnel",opacity:.025},transparency:"blend",color:({word:e})=>A(...J[e.length%J.length])},cathedral:{background:[.6,.6,.6,1],glow:{exposure:1.5,strength:2,offset:{up:2,down:2},steps:4,pow:2},face:{gouraud:!0,opacity:.9},transparency:"oit",color:({word:e,type:t})=>t==="face"?A(e.length*.3%1,1,.6):[0,0,0]},synthwave:{background:[...A(.77,.6,.04),1],glow:{exposure:1.5,strength:3,offset:{up:3,down:3},steps:3,pow:2},shading:!1,face:{opacity:.015},afterImage:.7,transparency:"blend",color:({word:e})=>A((.5-e.length*.05%.5+.65)%1,.4,.6)},colorful:{background:[1,1,1,1],diffuse:"oren-nayar",specular:"cook-torrance",shininess:32,opacity:1,ambient:.2,gouraud:!1,face:{gouraud:!0,opacity:.1,diffuse:"fresnel",specular:!1},transparency:"oit",color:({word:e,dual:t})=>A(e.length*.03%1-(t?.25:0),1,.8)},shiny:{background:[0,0,0,1],diffuse:"lambert",specular:"blinn-phong",shininess:32,opacity:1,ambient:.2,gouraud:!1,face:{gouraud:!0,opacity:.1,diffuse:"fresnel",specular:!1},transparency:"oit",color:({word:e})=>A(-(e.length*.07)%1,1,.8)},shape:{background:[1,1,1,1],transparency:"oit",face:{gouraud:!0,opacity:.2,diffuse:"fresnel"},color:({faceSize:e,type:t,idx:n,size:s})=>t==="face"?A((e-2)*.21%1,1,.8):A(n/s,.75,.5)},subShape:{background:[1,1,1,1],transparency:"oit",face:{gouraud:!0,opacity:.2,diffuse:"fresnel"},color:({subShape:e,type:t})=>t!=="vertex"?A(e*.21%1,1,.8):[1,1,1]},reflection:{background:[1,1,1,1],diffuse:"cel",face:{opacity:.6,gouraud:!1},transparency:"blend",color:({word:e,type:t,dimensions:n,draw:s})=>{const f=e.length?ge(e[e.length-1])/n:0;return A(f%1,1,t==="face"?.6:s.face?0:.8)}},harlequin:{background:[...A(240/360,.23,.09),1],face:{opacity:.6},transparency:"oit",color:({word:e,idx:t,type:n})=>{const s=e.split("").map(h=>ge(h)).reduce((h,d)=>h+d,0),f=[...J[s%J.length]];return t%2&&(f[2]*=.5),A(...f)}},pure:{background:[0,0,0,1],color:({word:e})=>A(e.length*.03%1,.75,.7)},facets:{background:[0,0,0,1],color:({faceIndex:e,faceSize:t})=>A(e/t,.75,.7)},monochrome:{background:[.12,.12,.12,1],diffuse:"reverse",ambient:0,face:{opacity:.1},transparency:"oit",color:()=>[1,1,1]},plain:{extended:!0,background:[1,1,1,1],glow:!1,shading:!1,color:({word:e,type:t,draw:n})=>A(e.length*.06%1,1,t==="face"?.6:n.face?.05:.5)},plainblack:{extended:!0,background:[1,1,1,1],shading:!1,color:({word:e,type:t})=>t==="face"?new Array(3).fill(1-Me(.9,e.length+1)):[0,0,0]},normals:{extended:!0,background:[1,1,1,1],shading:"normal",color:()=>[0,0,0]},uvs:{extended:!0,background:[1,1,1,1],shading:"uv",color:()=>[0,0,0]}}).map(([e,t])=>[e,{...Pe,...t,transparent:{}}])),Ue=(e,t,n,s)=>{const f=[],h=[],d=e>4?9:e;for(let a=0;a<t.length;a++){const l=t[a];if(!l){f.push(null),h.push(null);continue}const w=[new Float32Array(l.size*3)];for(let r=0;r<a+1;r++)w.push(new Float32Array(l.size*d));let i=0;const c=l.objects.concat(l.partials);for(let r=0;r<c.length;r++){const o=c[r];if(o)for(let g=0;g<o.length;g++){const u=o[g];for(let j=0;j<u.vertices.length;j++){const z=u.vertices[j];for(let k=0;k<z.length;k++)w[j+1][i*d+k]=z[k]}const v=Ne[n].color({word:u.word,key:u.key,subShape:r%l.objects.length,faceIndex:u.faceIndex,faceSize:u.faceSize,dimensions:e,draw:s,idx:i,size:l.size,type:B[a],dual:!!u.dual});w[0][i*3+0]=v[0],w[0][i*3+1]=v[1],w[0][i*3+2]=v[2],i++}}f.push(w),h.push({start:l.start,size:l.size})}return{infos:h,data:f}},Be=(e,t,n=!1,s=!1)=>{if(n){if(s)return e;const f=e>0?1-e%2:0;return e>=t/2+f?2*(t-e)-1+f:2*e-f}return e>=t/2?2*(t-e)-1:2*e},Fe=(e,t,n,s)=>{const f=[],h=[];if(e===0)for(const[d,a]of t.currentWords)f.push({word:a,vertices:[t.vertices.get(d)]}),t.currentWords.delete(d);else if(e===1)for(const[d,a]of t.currentWords){const l={word:a,vertices:[]};for(let w=0;w<t.facet.length;w++){const i=_(s.root,a+t.facet[w]);i&&s.root.vertices.has(i)&&l.vertices.push(s.root.vertices.get(i))}l.vertices.length<e+1||(f.push(l),t.currentWords.delete(d))}else if(e===2)for(const[d,a]of t.currentWords){const l=t.mirrors.every(g=>!!g),w=t.mirrors.every(g=>O(g)),i=a.length%2?0:1,c=[];for(let g=0;g<t.facet.length;g++){const u=Be(g,t.facet.length,l,w),v=_(s.root,a+t.facet[u]);v&&s.root.vertices.has(v)&&c.push(s.root.vertices.get(v))}if(c.length<e+1)continue;const r=c.length<t.facet.length;if(c.length===3){i&&([c[2],c[1]]=[c[1],c[2]]);const g={word:a,vertices:c,faceIndex:0,faceSize:3,partial:r};r?h.push(g):(f.push(g),t.currentWords.delete(d));continue}let o=new Array(n.dimensions).fill(0);for(let g=0;g<c.length;g++){const u=c[g];o=D(o,u)}o=q(o,1/c.length);for(let g=0;g<c.length;g++){const u={word:a,vertices:[c[(g+i)%c.length],c[(g+(1-i))%c.length],o],faceIndex:g,faceSize:c.length,partial:r};r?h.push(u):(f.push(u),t.currentWords.delete(d))}}return{objects:f,partials:h}},ne=(e,t=null)=>{if(!e.length)return t||[];if(!t)return t=e[0],ne(e.slice(1),t);const n=t[t.length-1],s=e.find(h=>h[0]===n||h[1]===n);if(!s)return t;const f=e.indexOf(s);return e.splice(f,1),s[0]===n?t.push(s[1]):t.push(s[0]),ne(e,t)},Te=(e,t,n,s)=>{const f=[],h=t.children.find(l=>l.key===n.replace("d","")),d=[],a=l=>{l.dimensions===e&&d.push(l.facet),l.children.forEach(a)};a(h),t.children.filter(l=>l.key.includes("s")).forEach(a);for(let l=0;l<d.length;l++){const w=d[l];if(w.length<2)continue;const i=[];for(let r=0;r<w.length;r++){const o=_(s,w[r]);o&&s.vertices.has(o)&&i.push(s.vertices.get(o))}let c=new Array(i[0].length).fill(0);for(let r=0;r<i.length;r++){const o=i[r];c=D(c,o)}c=q(c,1/i.length),f.push(R(c,c))}return We(...f)},Re=(e,t,n,s,f,h)=>{const{space:d}=s.root,a=[],l=[];if(e===0){s.root.dualVertices=s.root.dualVertices||new Map;for(const[w,i]of t.currentWords){const c=[];for(let u=0;u<t.facet.length;u++){const v=_(s.root,i+t.facet[u]);v&&s.root.vertices.has(v)&&c.push(v)}const r=c.length<t.facet.length;let o=new Array(n.dimensions).fill(0);for(let u=0;u<c.length;u++){const v=s.root.vertices.get(c[u]);o=D(o,v)}if(o=re(o,d.metric),d.curvature){let u=0;if(f>=0){let v=1;f>0&&f<n.dimensions-1&&(t.midradius||(t.midradius=Te(f,n,h,s.root)),v=t.midradius);const j=H(d.metric,o);for(let z=0;z<c.length;z++){const k=s.root.vertices.get(c[z]);u+=R(j,k)}u/=v*c.length,f===n.dimensions-1&&(u=1/u)}else u=1;o=q(o,d.curvature/u)}const g={word:i,vertices:[o],dual:!0,partial:r};s.root.dualVertices.set(`${h}#${i}`,{vertex:o,facet:c,partial:r}),r?l.push(g):(a.push(g),t.currentWords.delete(w))}}else if(e===1){if(!s.root.dualVertices)return{objects:a,partials:l};s.root.dualEdges=s.root.dualEdges||[];for(const[w,i]of t.currentWords){const c=[];for(let u=0;u<t.facet.length;u++){const v=_(s.root,i+t.facet[u]);v&&s.root.vertices.has(v)&&c.push(v)}let r=c.length<t.facet.length;const o=[],g=[];for(const[u,{vertex:v,facet:j,partial:z}]of s.root.dualVertices.entries())if(c.every(k=>j.includes(k))&&(o.push(v),g.push(u)),r=r||z,o.length===2)break;if(o.length===2){const u={word:i,vertices:o,dual:!0,partial:r};r?l.push(u):(a.push(u),s.root.dualEdges.push(g),t.currentWords.delete(w))}}}else if(e===2){if(!s.root.dualVertices||!s.root.dualEdges)return{objects:a,partials:l};for(const[w,i]of t.currentWords){const c=[];for(let y=0;y<t.facet.length;y++){const b=_(s.root,i+t.facet[y]);b&&s.root.vertices.has(b)&&c.push(b)}if(c.length<t.facet.length)continue;const r={};for(const[y,{vertex:b,facet:x}]of s.root.dualVertices.entries())c.every(S=>x.includes(S))&&(r[y]=b);const o=Object.keys(r);if(o.length<3)continue;const g=[];for(let y=0;y<s.root.dualEdges.length;y++){const[b,x]=s.root.dualEdges[y];o.includes(b)&&o.includes(x)&&g.push([b,x])}const u=[],v=ne(g);if(v.length<4)continue;let j=!0;v[0]===v[v.length-1]&&(v.pop(),j=!1);for(let y=0;y<v.length;y++){const b=v[y];u.push(r[b])}if(u.length===3){const y={word:i,vertices:u,dual:!0};a.push(y),t.currentWords.delete(w);continue}const z=i.length%2?0:1;let k=new Array(n.dimensions).fill(0);for(let y=0;y<u.length;y++){const b=u[y];k=D(k,b)}k=q(k,1/u.length);for(let y=0;y<u.length;y++){const b={word:i,vertices:[u[(y+z)%u.length],u[(y+(1-z))%u.length],k],dual:!0,faceIndex:y,faceSize:u.length,partial:j};j?l.push(b):(a.push(b),t.currentWords.delete(w))}}}return{objects:a,partials:l}},De=(e,t,n)=>{const s=[],f=[],h=[];for(const[d,a]of e.currentWords){let l;if(a===""){const w=ke(n.rootVertices);e.fundamentalVertices=new Map,l=m(t.dimensions).map(i=>re(w[i],n.metric)),e.hashes={vertex:new Set,edge:new Set,face:new Set},e.fundamentalVertices.set("",l)}else{l=[...e.fundamentalVertices.get(a.slice(1))];const w=e.gens.indexOf(a[0]);for(let i=0;i<l.length;i++)l[i]=oe(l[i],n.rootNormals[w],n.metric)}for(let w=0;w<l.length;w++){const i=Y(l[w]);e.hashes.vertex.has(i)||(s.push({word:a,cosetId:d,vertices:[l[w]]}),e.hashes.vertex.add(i));for(let c=w+1;c<l.length;c++){const r=[l[w],l[c]].sort((o,g)=>{for(let u=0;u<o.length;u++){if(o[u]<g[u])return-1;if(o[u]>g[u])return 1}return 0}).map(o=>Y(o)).join("-");e.hashes.edge.has(r)||(f.push({word:a,cosetId:d,vertices:[l[w],l[c]]}),e.hashes.edge.add(r));for(let o=c+1;o<l.length;o++){const g=[l[w],l[c],l[o]].sort((u,v)=>{for(let j=0;j<u.length;j++){if(u[j]<v[j])return-1;if(u[j]>v[j])return 1}return 0}).map(u=>Y(u)).join("-");e.hashes.face.has(g)||(h.push({word:a,cosetId:d,vertices:[l[w],l[c],l[o]]}),e.hashes.face.add(g))}}e.fundamentalVertices.set(a,l)}e.currentWords.delete(d)}return[s,f,h]},He=(e,t,n,s,f,h,d,a,l)=>{d.root.lasts||(d.root.lasts=new Array(3).fill(0));const w=[];if(f){const i=De(d.root,e,n);for(let c=0;c<i.length;c++)s[B[c]]?(w.push({start:d.root.lasts[c],size:i[c].length,objects:[i[c]],partials:[]}),d.root.lasts[c]+=i[c].length):w.push(null)}else for(let i=0;i<3;i++){if(!d[i]||!h&&!s[B[i]]){w.push(null);continue}const c={start:d.root.lasts[i],size:0,objects:[],partials:[]};for(let r=0;r<d[i].detail.length;r++){const o=d[i].detail[r];if(!o.dual&&a.includes(o.key)){c.objects.push(null),c.partials.push(null);continue}const g=t.get(o.key);if(g.currentWords.size){const{objects:u,partials:v}=o.dual?Re(i,g,e,d,l,o.key):Fe(i,g,e,d);if(!s[B[i]]||a.includes(o.key))continue;c.objects.push(u),c.size+=u.length+v.length,d.root.lasts[i]+=u.length,c.partials.push(v)}}w.push(c)}return w},be=(e,t,n,s,f,h,d,a,l=[])=>{l.done=!0;const w=i=>{const c=d?t.dimensions-i.dimensions-1:i.dimensions;i.children.forEach(w);const r=a[c],o=B[c],g=d?`d${i.key}`:i.key;if(i!=null&&i.new){l[c]||(l[c]={dimensions:c,processing:f[o]?0:void 0,count:0,detail:[],aggregated:[],done:!0});const u=s.eigens.values;if(n.has(g))n.get(g).keys.push(g);else{let z=r?e:5;o==="edge"&&s.curvature<=0&&(z*=1.5);const k={...t,keys:[g],subgens:i.quotient,facet:i.facet,subdimensions:c,mirrors:i.mirrors,limit:z,space:s,...i.dimensions===0&&!h?{rootVertex:s.rootVertex,rootNormals:s.rootNormals,metric:s.metric}:{}};n.set(g,k)}const v=n.get(g);i.dimensions===0&&(l.root=v),v.done||(r?(we(v),u.some(z=>z<=0)?v.count=1/0:v.count=v.cosets.size):u.some(z=>z<=0)?(v.count=1/0,v.done=!0):v.count=Ie(v)),l[c].detail.push({key:g,coxeter:i.coxeter,stellation:i.stellation,mirrors:i.mirrors,dual:d,count:v.count,done:v.done});const j=l[c].aggregated.find(({coxeter:z,stellation:k,mirrors:y})=>T(z,i.coxeter)&&T(k,i.stellation)&&T(y,i.mirrors));j?(j.done=j.done&&v.done,j.count+=v.count,j.key+=","+g):l[c].aggregated.push({key:g,coxeter:i.coxeter,stellation:i.stellation,mirrors:i.mirrors,count:v.count,done:v.done}),f[o]&&v.words&&(l[c].processing+=v.words.size),l[c].count+=v.count,l[c].done=l[c].done&&v.done,l[c].dual=d,l.done=l.done&&v.done}};return t.children.forEach(w),l.size=h?l.root.words.size:l.root.vertices.size,l};let P,M;onmessage=({data:{first:e,space:t,dimensions:n,coxeter:s,stellation:f,mirrors:h,ambiance:d,draw:a,batch:l,hidden:w,reciprocation:i}})=>{var c,r;try{e&&(P=new Map,M=ee(n,s,f,h,t));const o=h.every(b=>!b),g=h.some(b=>je(b)),u=h.some(b=>xe(b)),v={[n-1]:g,0:!0,1:g||a.edge&&!o,2:g||a.face&&!o},j=be(l,M,P,t,a,o,g&&!u,v);if(u&&be(l,M,P,t,a,o,g,v,j),M.dimensions===2&&(M.currentWords=new Map([[1,""]]),M.facet=Array.from(j.root.words.values()),M.done=!0,P.set("",{...M,subgens:M.subgens,facet:M.facet,subdimensions:M.dimensions,mirrors:M.mirrors}),j[2]={dimensions:2,processing:1,count:0,detail:[{key:"",coxeter:M.coxeter,stellation:M.stellation,mirrors:M.mirrors,count:1,done:!0}],aggregated:[],done:!0}),j[0].done&&(!a.edge||(c=j[1])!=null&&c.done)&&(!a.face||(r=j[2])!=null&&r.done))for(let b of P.values())b.limit=200;const z=He(M,P,t,a,o,g,j,w,i),{infos:k,data:y}=Ue(M.dimensions,z,d,a);postMessage({polytope:j,infos:k,data:y},{options:{transfer:[y.flat(1)]}})}catch(o){postMessage({error:o.message})}}})();
