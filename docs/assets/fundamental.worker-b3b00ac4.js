(function(){"use strict";const x=(e,n=null,l=1,t=!1)=>{if(n===null&&(n=e,e=0),l===0)throw new Error("Step cannot be zero.");if(n<e&&l>0||n>e&&l<0){if(t)return[];l=-l}return new Array(Math.ceil((n-e)/l)).fill().map((s,o)=>e+o*l)},z=(e,n)=>{let l=0;for(let t=0;t<e.length;t++)l+=e[t]*n[t];return l},oe=(e,n)=>{const l=[];for(let t=0;t<e.length;t++)l[t]=e[t]-n[t];return l},E=(e,n)=>{const l=[];for(let t=0;t<e.length;t++)l[t]=e[t]*n;return l},ce=e=>{const n=[];for(let l=0;l<e[0].length;l++){n.push([]);for(let t=0;t<e.length;t++)n[l].push(e[t][l])}return n},N=(e,n)=>{const l=new Array(e.length);for(let t=0;t<e.length;t++){let s=0;for(let o=0;o<e[0].length;o++)s+=e[t][o]*n[o];l[t]=s}return l},_=(e,n)=>e.filter((l,t)=>!n.includes(t)),L=(e,n)=>_(e,n).map(l=>_(l,n)),ie=(e,n,l)=>oe(e,E(N(re(l),n),2*z(N(fe(l),e),n))),ue=(e,n)=>n.some((l,t)=>l.some((s,o)=>t===o&&s===0))?E(e,1/e[e.length-1]):E(e,-1/ge(R(z(N(n,e),e)))),fe=e=>e.map((n,l)=>n.map((t,s)=>l===s&&t===0?1:t)),re=e=>e.map(n=>n.map(l=>R(l))),B=(e,n,l,t)=>{const s=D/e,o=D/n,c=D/l;return J(D/he(-v(s)*v(c)+T(s)*T(c)*((v(o)-v(t*s)*v(c))/(T(t*s)*T(c)))))},{abs:R,cos:v,sin:T,tan:Se,cosh:ve,sinh:He,acos:he,acosh:Pe,atan:_e,atan2:Be,min:Te,max:De,round:J,sqrt:ge,cbrt:Oe,sign:$e,ceil:Ee,floor:Ne,log:Ue,exp:We,hypot:Fe,pow:Ge,PI:D}=Math,K=new ArrayBuffer(8),we=new Float64Array(K),Q=new Int32Array(K);function de(e){return~~e===e?~~e:(we[0]=e,Q[0]^Q[1])}const X=10**4,be=e=>{let n="";for(let l=0;l<e.length;l++)n+=de(J(e[l]*X)/X).toString(),l<e.length-1&&(n+="|");return n};function*ye(e,n){if(n<0||e.length<n)return;const l=Array.from(Array(n).keys());for(;;){yield l.map(s=>e[s]);let t=n-1;for(;t>=0&&l[t]>=e.length-n+t;)t--;if(t<0)return;for(let s=l[t]+1;t<n;t++,s++)l[t]=s}}const Y=(e,n=2)=>Array.from(ye(e,n)),f=e=>String.fromCharCode(97+e),Z=(e,n,l,t=[])=>{const s=[];for(let o=0;o<e;o++)t.includes(o)||s.push(f(o).repeat(2));for(let o=1;o<e;o++)for(let c=0;c<o;c++)!t.includes(o)&&!t.includes(c)&&n[o][c]>1&&s.push((f(c)+f(o)).repeat(n[o][c]));if(!t.length&&l&&!l.every(o=>o.every(c=>c===1))){if(e===4&&l[0][1]>1!=l[2][3]>1&&n[0][1]>3&&n[2][3]>3)l[0][1]>1&&s.push("abcdcb".repeat(B(n[0][1],n[1][2],n[0][2],l[0][1]))),l[2][3]>1&&s.push("abcdcb".repeat(B(n[2][3],n[1][2],n[1][3],l[2][3])));else for(let o=1;o<e;o++)for(let c=0;c<o;c++)if(l[c][o]>1){if(c+2<e){const u=B(n[c+1][o+1],n[c][o],n[c][o+1],l[c][o]);s.push((f(c)+f(o)+f(c+2)+f(o)).repeat(u))}if(c-1>=0){const u=B(n[c-1][o-1],n[c][o],n[c-1][o],l[c][o]);s.push((f(c)+f(o)+f(c)+f(c-1)).repeat(u))}}}return s},k=e=>e!==""&&e!=="x",p=e=>e==="s"||e==="b",Ae=e=>{const n=e.toUpperCase();return e===n?e.toLowerCase():n},y=(e,n)=>{let l=n;for(;e.quotientMap[l];)l=e.quotientMap[l];return l},I=(e,n,l)=>{const t=n,s=[[n,l]];for(;s.length>0;)if([n,l]=s.pop(),n=y(e,n),l=y(e,l),n!==l){e.quotientMap[l]=n,e.seen.has(l)&&!e.seen.has(n)&&e.seen.add(n);const o=e.cosets.get(n),c=e.cosets.get(l);e.cosets.delete(l);for(const[u,i]of c)o.has(u)?s.push([o.get(u),i]):o.set(u,i)}return y(e,t)},m=(e,n,l,t)=>{n=y(e,n);const s=e.cosets.get(n);s.has(l)?I(e,s.get(l),t):s.set(l,t)},O=(e,n,l,t)=>{n=y(e,n);let s;const o=e.cosets.get(n);return o.has(l)?(s=y(e,o.get(l)),t!==void 0&&s!==t&&I(e,t,s)):(t?s=t:(s=e.nextVertex++,e.cosets.set(s,new Map),e.unvisited.push(s)),m(e,n,l,s),m(e,s,Ae(l),n)),s},ee=function(e,n,l){let t=l;for(let s=n.length-1;s>0;s--)t=O(e,t,n[s]);O(e,t,n[0],l)},Me=function(e,n){const l=y(e,1),t=new Map;t.set(l,"");const s=[l];for(;s.length>0;){const o=s.shift(),c=y(e,o);for(let u=0;u<n.length;u++){const i=n[u],j=e.cosets.get(c);if(j.size<e.gens.length*2)return t;const w=y(e,j.get(i));if(!t.has(w)){if(e.cosets.get(w).size<e.gens.length*2)return t;t.set(w,i+t.get(c)),s.push(w)}}}return t},ae=e=>{if(!e.cosets){e.unvisited=[1],e.cosets=new Map([[1,new Map]]),e.nextVertex=2,e.seen=new Set,e.quotientMap={};for(let n=0;n<e.subgens.length;n++)ee(e,e.subgens[n],1)}e.limit=e.limit||1e3,e.done=!1;for(let n=0;n<e.limit;n++){let l=null;for(;e.unvisited.length>0;){const t=y(e,e.unvisited.shift());if(!e.seen.has(t)){e.seen.add(t),l=t;break}}if(l===null){e.done=!0;break}for(let t=0;t<e.gens.length;t++)O(e,l,e.gens[t].toUpperCase()),O(e,l,e.gens[t]);for(let t=0;t<e.rels.length;t++)ee(e,e.rels[t],l)}},ne=e=>(ae(e),e.verticesWords=Me(e,e.gens),e.words=Array.from(e.verticesWords.values()),e),te=(e,n=[])=>e.map((l,t)=>n.includes(t)?"":f(t)).join(""),le=(e,n=[])=>e.map((l,t)=>n.includes(t)||l?"":f(t)).join(""),je=(e,n)=>{if(n===0)return!0;let l=e[e.length-1];const t=new Set;for(let s=0;s<l.length;s++){const o=l[s];if(!(!o||t.has(o))&&(t.add(o),t.size===n))return!0}return!1},U=(e,n,l,t,s=null,o=null,c=new Map)=>{s=s||t.map((u,i)=>k(u)?null:i).filter(u=>u!==null),o=o||{new:!0,dimensions:e,coxeter:n,stellation:l,mirrors:t,skips:s,gens:te(t,s),subgens:le(t,s),rels:Z(e,n,l,s),quotient:"",space:[""],snub:t.some(p),children:[]};for(let u=0;u<e;u++){if(s.includes(u))continue;const i=[...s,u],j=x(e).filter(h=>!i.includes(h)),w=i.sort().join("-");let d=!1;if(!c.has(w)){d=!0;const h={key:w,dimensions:e-i.length,coxeter:L(n,i),stellation:L(l,i),mirrors:_(t,i),skips:i,gens:te(t,i),subgens:le(t,i),rels:Z(e,n,l,i),snub:_(t,i).some(p)};ne(h),c.set(w,h)}const r=c.get(w),C=r.words;if(je(C,r.dimensions)){let h="";if(r.snub&&C.length<=r.dimensions)console.warn("TODO"),C.push(...i.map(f));else for(let g=0;g<e;g++)(!i.includes(g)||k(t[g])&&!t[g]&&!j.some(V=>n[V][g]!==2))&&(h+=f(g));let A={new:d,...r,quotient:h,space:C,children:[]};r.dimensions>0&&(A=U(e,n,l,t,i,A,c)),o.children.push(A)}}if(o.children.length===0){console.info("No leaf found, digging deeper",s);for(let u=0;u<e;u++){if(s.includes(u))continue;const i=[...s,u];o.children.push(U(e,n,l,t,i,{children:[]},c))}}return o};let H=null,P=null,$=null,W=null,F=null,G=0;const Ce=(e,n,l,t,s)=>{const o=ce(t);P=x(e).map(i=>ue(o[i],s)),H=null;const c=U(e,n,l,new Array(e).fill(1)),u=i=>{i.new&&i.dimensions===0&&(H={shape:c,subShape:i,params:{...c,subgens:i.quotient},lastDrawn:0}),i.children&&i.children.forEach(u)};u(c),$=new Map,W=new Set,F=new Set,G=0},Ve=(e,n)=>{const{rootVertex:l,rootNormals:t,metric:s}=e;let o=l;for(let c=0;c<n.length;c++)o=ie(o,t[n.charCodeAt(c)-97],s);return o};onmessage=({data:{order:e,metric:n,rootNormals:l,coxeter:t,stellation:s,rootVertices:o,dimensions:c,uuid:u}})=>{e===0&&Ce(c,t,s,o,n);const i=e===0?1:(e+1)*100,j=Y(new Array(P.length).fill().map((d,r)=>r)),w=Y(new Array(P.length).fill().map((d,r)=>r),3);try{let d=[],r=[],C=[];const h=H.params;if(!h.done){h.limit=i,ne(h);for(let A=H.lastDrawn;A<h.words.length;A++){const g=h.words[A];if(g===void 0)continue;const V=[];for(let b=0;b<P.length;b++){const q=P[b],a=Ve({rootVertex:q,rootNormals:l,metric:n},g),M=be(a);if($.has(M))V.push($.get(M));else{d.push({vertex:a,word:g,i:A});const S=G+d.length-1;$.set(M,S),V.push(S)}}H.lastDrawn=A+1;for(let b=0;b<j.length;b++){const[q,a]=j[b],[M,S]=[V[q],V[a]],se=q<a?`${M}-${S}`:`${S}-${M}`;W.has(se)||(r.push({start:M,end:S,word:g}),W.add(se))}for(let b=0;b<w.length;b++){const q=w[b].map(M=>V[M]),a=q.sort().join("-");F.has(a)||(C.push({vertices:q,word:g}),F.add(a))}}}G+=d.length,postMessage({vertices:d,edges:r,faces:C,order:e,uuid:u})}catch(d){postMessage({error:d.message,uuid:u})}}})();
