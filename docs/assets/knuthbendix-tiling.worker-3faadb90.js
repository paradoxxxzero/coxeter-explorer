(function(){"use strict";const Q=(e,n)=>{const t=new Array(e.length);for(let r=0;r<e.length;r++){let s=0;for(let c=0;c<e[0].length;c++)s+=e[r][c]*n[c];t[r]=s}return t},$=(e,n,t)=>{let r=0;for(let s=0;s<e.length;s++)r+=e[s]*n[s]*(s===e.length-1&&t||1);return r},U=(e,n)=>$(e,e,n),X=(e,n,t)=>{e=e.slice();const r=2*$(e,n,t);for(let s=0;s<e.length;s++)e[s]-=r*(t||s!==e.length-1?n[s]:0);return e},Y=(e,n)=>{if(e=e.slice(),n===0){for(let r=0;r<e.length;r++)e[r]/=e[e.length-1];return e}const t=(n===-1&&ne(e[e.length-1])||1)/te(ee(1e-32,Z(U(e,n))));for(let r=0;r<e.length;r++)e[r]*=t;return e},M=(e,n,t,r)=>{const s=S/e,c=S/n,i=S/t;return O(S/v(-y(s)*y(i)+C(s)*C(i)*((y(c)-y(r*s)*y(i))/(C(r*s)*C(i)))))},{abs:Z,cos:y,sin:C,tan:je,cosh:ke,sinh:Be,acos:v,acosh:Te,atan:Ae,atan2:Re,min:ze,max:ee,round:O,sqrt:te,sign:ne,ceil:Ee,floor:We,log:Ve,exp:_,hypot:$e,pow:Oe,PI:S}=Math,I=new ArrayBuffer(8),re=new Float64Array(I),F=new Int32Array(I);function se(e){return~~e===e?~~e:(re[0]=e,F[0]^F[1])}const H=10**4,oe=e=>{let n="";for(let t=0;t<e.length;t++)n+=se(O(e[t]*H)/H).toString(),t<e.length-1&&(n+="|");return n},u=e=>String.fromCharCode(97+e),le=(e,n,t,r,s,c=[])=>{const i=[];for(let o=0;o<e;o++)c.includes(o)||i.push(u(o).repeat(2));for(let o=1;o<e;o++)for(let l=0;l<o;l++)!c.includes(o)&&!c.includes(l)&&n[o][l]>1&&i.push((u(l)+u(o)).repeat(n[o][l]));if(!c.length&&t&&!t.every(o=>o.every(l=>l===1))&&s>0){if(e===4&&t[0][1]>1!=t[2][3]>1&&n[0][1]>3&&n[2][3]>3)t[0][1]>1&&i.push("abcdcb".repeat(M(n[0][1],n[1][2],n[0][2],t[0][1]))),t[2][3]>1&&i.push("abcdcb".repeat(M(n[2][3],n[1][2],n[1][3],t[2][3])));else for(let o=1;o<e;o++)for(let l=0;l<o;l++)if(t[l][o]>1){if(l+2<e){const f=M(n[l+1][o+1],n[l][o],n[l][o+1],t[l][o]);i.push((u(l)+u(o)+u(l+2)+u(o)).repeat(f))}if(l-1>=0){const f=M(n[l-1][o-1],n[l][o],n[l-1][o],t[l][o]);i.push((u(l)+u(o)+u(l)+u(l-1)).repeat(f))}}}return i},ce=(e,n,t,r,s)=>Object.fromEntries(le(e,n,null,r,s).map(c=>[c,""])),N=(e,n)=>{const t=e.length-n.length;return t!==0?Math.sign(t):e<=n?-1:1},P=e=>e.split("").reverse().join(""),ie=(e,n)=>{const t=e.length-n.length;return t!==0?Math.sign(t):N(P(e),P(n))},fe=(e,n)=>{const t=new Map,r=Object.keys(e).sort(n);for(let s=0;s<r.length;s++){const c=r[s],[i,o]=[c,e[c]].sort(n);t.has(o)?t.set(o,[i,t.get(o)].sort()[0]):t.set(o,i)}return t},x=(e,n)=>{if(n.length===0||e.size===0)return n;const t=e._re_cache||new RegExp([...e.keys()].join("|"),"g");let r=n;do n=r,r=n.replace(t,s=>e.get(s));while(r!==n);return n},he=(e,n)=>{const t=new Map(e);for(e=[...e.entries()];e.length>0;){K();const[r,s]=e.pop();t.delete(r);const c=x(t,r),i=x(t,s);let o=!0;if(c===i)o=!1;else{const[l,f]=[c,i].sort(n);f!==r&&l!==s&&(t.set(f,l),e.push([f,l]),o=!1)}o&&t.set(r,s)}return t},ue=function(e,n){if(n.length===0)return null;const t=Math.max(0,e.length-n.length);for(let r=t;r<e.length;r++)if(e[r]===n[0]&&e.slice(r+1)===n.slice(1,e.length-r))return{prefix:e.slice(0,r),suffix:n.slice(e.length-r)}},ae=function(e,n){if(n.length===0)return null;for(let t=0;t<e.length-n.length+1;t++)if(e.slice(t,t+n.length)===n)return{prefix:e.slice(0,t),suffix:e.slice(t+n.length)}},ge=(e,n,t,r)=>{const s=ue(e,t);if(s)return{s1:s.prefix+r,s2:n+s.suffix};const c=ae(e,t);if(c)return{s1:n,s2:c.prefix+r+c.suffix}},pe=(e,n)=>{const t=new Map(e),r=[...e.entries()];for(let s=0;s<r.length;s++){K();const[c,i]=r[s];for(let o=0;o<r.length;o++){if(s===o)continue;const[l,f]=r[o],h=ge(c,i,l,f);if(h){const a=x(e,h.s1),p=x(e,h.s2);if(a!==p){const[R,z]=[a,p].sort(n);t.set(z,R)}}}}return t},we=(e,n)=>pe(he(e,n),n),de=(e,n)=>{if(e.size!==n.size)return!1;const t=e.keys();for(;;){const{done:r,value:s}=t.next();if(r)return!0;if(e.get(s)!==n.get(s))return!1}},me=(e,n)=>{for(e=fe(e,n);;){const t=we(e,n);if(de(t,e))return t._re_cache=new RegExp([...t.keys()].join("|"),"g"),t;e=t}};let q,L;const K=()=>{if(performance.now()-q>L)throw new Error("Timeout")},be=(e,n)=>{const t=[50,100,_(n)*4,_(n)*10].map(r=>[r,r]).flat();for(let r=0;r<t.length;r++){L=t[r];try{return q=performance.now(),me(e,r%2?N:ie)}catch(s){if(s.message!=="Timeout")throw s}}throw new Error("Timeout")},j=(e,n)=>x(e,n),ye=e=>e==="s"||e==="b",xe=e=>isNaN(e)?1:+e;let k=new Map,E=new Set,w=[],B=[],W=[],V=0,d=new Map,m=[],T=null,b=!1,g=null;const D=(e,n,t)=>{V=0,w=[],B=[],W=[],k.clear(),E.clear(),d.clear(),d.set("",G("",e)),m=[""],T=t,g=n;const r=T.map((s,c)=>ye(s)?u(c):"").join("");b=r.length>0?new RegExp(`[^${r}]`,"g"):null},Me=(e,n)=>{const{rootVertex:t,rootNormals:r,curvature:s}=e;let c=t;for(let i=n.length-1;i>=0;i--)c=X(c,r[n.charCodeAt(i)-97],s);return c};function G(e,n){const t=oe(n);if(k.has(t))return k.get(t);{const r=V+w.length;return k.set(t,r),w.push({vertex:n,word:e}),r}}function J(e,n){const t=d.get(e),r=d.get(n);if(t===r)return;const s=t>r?`${r}-${t}`:`${t}-${r}`;if(!E.has(s))return E.add(s),B.push({start:t,end:r,word:e,newWord:n}),!0}const A=(e,n,t)=>{if(n===t)return;if(d.has(t)){J(n,t);return}const r=Me(e,t),s=G(t,r);return d.set(t,s),J(n,t),t},Ce=e=>{const{dimensions:n}=e;let t;t=[];for(let r=0;r<m.length;r++){const s=m[r];for(let c=0;c<n;c++){const i=u(c),o=j(g,s+i);if(b&&o.replace(b,"").length%2)for(let l=0;l<T.length;l++){const f=u(l),h=j(g,o+f);if(h.replace(b,"").length%2)for(let a=0;a<T.length;a++){const p=u(a),R=j(g,h+p);if(R.replace(b,"").length%2)continue;const z=A(e,s,R);z&&t.push(z)}else{const a=A(e,s,h);a&&t.push(a)}}else{const l=A(e,s,o);l&&t.push(l)}}}return t},Se=e=>{const{dimensions:n}=e;let t=[""],r;const s=1e4;let c=m;do{r=[];for(let i=0;i<c.length;i++){const o=c[i];for(let l=0;l<n-1;l++){const f=u(l),h=j(g,o+f),a=A(e,o,h);a&&r.push(a)}}t=t.concat(r),c=r}while(r.length&&t.length<=s);if(t.length>s)throw new Error("Could not tile fundamental chamber");return t};onmessage=({data:{order:e,curvature:n,coxeter:t,stellation:r,mirrors:s,rootNormals:c,rootVertices:i,dimensions:o,uuid:l}})=>{const f=Y(Q(i,s.map(h=>xe(h))),n);try{let h=!1;if(e===0){const a=ce(o,t,r,s,n);try{g=be(a,o)}catch(p){console.warn(p),g=new Map(Object.entries(a))}if(D(f,g,s),b||g.size<=o)h=!0;else try{m=Se({curvature:n,rootNormals:c,rootVertex:f,dimensions:o})}catch(p){h=!0,D(f,g,s),console.warn(p)}}(e>0||h)&&(m=Ce({curvature:n,rootNormals:c,rootVertex:f,dimensions:o})),postMessage({vertices:w,edges:B,faces:W,order:e,uuid:l}),V+=w.length,w=[],B=[],W=[]}catch(h){postMessage({error:h.message,uuid:l})}}})();
