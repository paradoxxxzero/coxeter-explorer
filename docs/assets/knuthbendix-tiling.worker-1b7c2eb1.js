(function(){"use strict";const E=e=>e!==""&&e!=="x",Q=(e,n,t)=>{let s=0;for(let r=0;r<e.length;r++)s+=e[r]*n[r]*(r===e.length-1&&t||1);return s},U=(e,n,t)=>{e=e.slice();const s=2*Q(e,n,t);for(let r=0;r<e.length;r++)e[r]-=s*(t||r!==e.length-1?n[r]:0);return e},M=(e,n,t,s)=>{const r=x/e,l=x/n,i=x/t;return _(x/V(-b(r)*b(i)+C(r)*C(i)*((b(l)-b(s*r)*b(i))/(C(s*r)*C(i)))))},{abs:de,cos:b,sin:C,tan:me,cosh:be,sinh:ye,acos:V,acosh:Me,atan:Ce,atan2:xe,min:Se,max:je,round:_,sqrt:ke,sign:ve,ceil:Be,floor:Te,log:Re,exp:$,hypot:Ae,pow:Ee,PI:x}=Math,I=new ArrayBuffer(8),X=new Float64Array(I),F=new Int32Array(I);function Y(e){return~~e===e?~~e:(X[0]=e,F[0]^F[1])}const H=10**4,Z=e=>{let n="";for(let t=0;t<e.length;t++)n+=Y(_(e[t]*H)/H).toString(),t<e.length-1&&(n+="|");return n},h=e=>String.fromCharCode(97+e),ee=(e,n,t,s,r,l=[])=>{const i=[];for(let o=0;o<e;o++)E(s[o])&&!l.includes(o)&&i.push(h(o).repeat(2));for(let o=1;o<e;o++)for(let c=0;c<o;c++)!l.includes(o)&&!l.includes(c)&&n[o][c]>1&&E(s[o])&&E(s[c])&&i.push((h(c)+h(o)).repeat(n[o][c]));if(t&&!t.every(o=>o.every(c=>c===1))&&r>0){if(e===4&&(t[0][1]>1||t[2][3]>1)&&n[0][1]>3&&n[2][3]>3)t[0][1]>1&&i.push("abcdcb".repeat(M(n[0][1],n[1][2],n[0][2],t[0][1]))),t[2][3]>1&&i.push("abcdcb".repeat(M(n[2][3],n[1][2],n[1][3],t[2][3])));else for(let o=1;o<e;o++)for(let c=0;c<o;c++)if(t[c][o]>1){if(c+2<e){const f=M(n[c+1][o+1],n[c][o],n[c][o+1],t[c][o]);i.push((h(c)+h(o)+h(c+2)+h(o)).repeat(f))}if(c-1>=0){const f=M(n[c-1][o-1],n[c][o],n[c-1][o],t[c][o]);i.push((h(c)+h(o)+h(c)+h(c-1)).repeat(f))}}}return i},te=(e,n,t,s,r)=>Object.fromEntries(ee(e,n,null,s,r).map(l=>[l,""])),P=(e,n)=>{const t=e.length-n.length;return t!==0?Math.sign(t):e<=n?-1:1},q=e=>e.split("").reverse().join(""),ne=(e,n)=>{const t=e.length-n.length;return t!==0?Math.sign(t):P(q(e),q(n))},se=(e,n)=>{const t=new Map,s=Object.keys(e).sort(n);for(let r=0;r<s.length;r++){const l=s[r],[i,o]=[l,e[l]].sort(n);t.has(o)?t.set(o,[i,t.get(o)].sort()[0]):t.set(o,i)}return t},y=(e,n)=>{if(n.length===0||e.size===0)return n;const t=e._re_cache||new RegExp([...e.keys()].join("|"),"g");let s=n;do n=s,s=n.replace(t,r=>e.get(r));while(s!==n);return n},re=(e,n)=>{const t=new Map(e);for(e=[...e.entries()];e.length>0;){N();const[s,r]=e.pop();t.delete(s);const l=y(t,s),i=y(t,r);let o=!0;if(l===i)o=!1;else{const[c,f]=[l,i].sort(n);f!==s&&c!==r&&(t.set(f,c),e.push([f,c]),o=!1)}o&&t.set(s,r)}return t},oe=function(e,n){if(n.length===0)return null;const t=Math.max(0,e.length-n.length);for(let s=t;s<e.length;s++)if(e[s]===n[0]&&e.slice(s+1)===n.slice(1,e.length-s))return{prefix:e.slice(0,s),suffix:n.slice(e.length-s)}},ce=function(e,n){if(n.length===0)return null;for(let t=0;t<e.length-n.length+1;t++)if(e.slice(t,t+n.length)===n)return{prefix:e.slice(0,t),suffix:e.slice(t+n.length)}},le=(e,n,t,s)=>{const r=oe(e,t);if(r)return{s1:r.prefix+s,s2:n+r.suffix};const l=ce(e,t);if(l)return{s1:n,s2:l.prefix+s+l.suffix}},ie=(e,n)=>{const t=new Map(e),s=[...e.entries()];for(let r=0;r<s.length;r++){N();const[l,i]=s[r];for(let o=0;o<s.length;o++){if(r===o)continue;const[c,f]=s[o],a=le(l,i,c,f);if(a){const u=y(e,a.s1),T=y(e,a.s2);if(u!==T){const[R,A]=[u,T].sort(n);t.set(A,R)}}}}return t},fe=(e,n)=>ie(re(e,n),n),he=(e,n)=>{if(e.size!==n.size)return!1;const t=e.keys();for(;;){const{done:s,value:r}=t.next();if(s)return!0;if(e.get(r)!==n.get(r))return!1}},ue=(e,n)=>{for(e=se(e,n);;){const t=fe(e,n);if(he(t,e))return t._re_cache=new RegExp([...t.keys()].join("|"),"g"),t;e=t}};let L,K;const N=()=>{if(performance.now()-L>K)throw new Error("Timeout")},ae=(e,n)=>{const t=[50,100,$(n)*4,$(n)*10].map(s=>[s,s]).flat();for(let s=0;s<t.length;s++){K=t[s];try{return L=performance.now(),ue(e,s%2?P:ne)}catch(r){if(r.message!=="Timeout")throw r}}throw new Error("Timeout")},S=(e,n)=>y(e,n);let j=new Map,W=new Set,p=[],k=[],z=[],O=0,w=new Map,d=[],v=null,m=!1,g=null;const D=(e,n,t)=>{O=0,p=[],k=[],z=[],j.clear(),W.clear(),w.clear(),w.set("",G("",e)),d=[""],v=t,g=n;const s=v.map((r,l)=>"sb".includes(r)?h(l):"").join("");m=s.length>0?new RegExp(`[^${s}]`,"g"):null},ge=(e,n)=>{const{rootVertex:t,mirrorsPlanes:s,curvature:r}=e;let l=t;for(let i=n.length-1;i>=0;i--)l=U(l,s[n.charCodeAt(i)-97],r);return l};function G(e,n){const t=Z(n);if(j.has(t))return j.get(t);{const s=O+p.length;return j.set(t,s),p.push({vertex:n,word:e}),s}}function J(e,n){const t=w.get(e),s=w.get(n);if(t===s)return;const r=t>s?`${s}-${t}`:`${t}-${s}`;if(!W.has(r))return W.add(r),k.push({start:t,end:s,word:e,newWord:n}),!0}const B=(e,n,t)=>{if(n===t)return;if(w.has(t)){J(n,t);return}const s=ge(e,t),r=G(t,s);return w.set(t,r),J(n,t),t},pe=e=>{const{dimensions:n}=e;let t;t=[];for(let s=0;s<d.length;s++){const r=d[s];for(let l=0;l<n;l++){const i=h(l),o=S(g,r+i);if(m&&o.replace(m,"").length%2)for(let c=0;c<v.length;c++){const f=h(c),a=S(g,o+f);if(a.replace(m,"").length%2)for(let u=0;u<v.length;u++){const T=h(u),R=S(g,a+T);if(R.replace(m,"").length%2)continue;const A=B(e,r,R);A&&t.push(A)}else{const u=B(e,r,a);u&&t.push(u)}}else{const c=B(e,r,o);c&&t.push(c)}}}return t},we=e=>{const{dimensions:n}=e;let t=[""],s;const r=1e4;let l=d;do{s=[];for(let i=0;i<l.length;i++){const o=l[i];for(let c=0;c<n-1;c++){const f=h(c),a=S(g,o+f),u=B(e,o,a);u&&s.push(u)}}t=t.concat(s),l=s}while(s.length&&t.length<=r);if(t.length>r)throw new Error("Could not tile fundamental chamber");return t};onmessage=({data:{order:e,curvature:n,coxeter:t,stellation:s,mirrors:r,mirrorsPlanes:l,rootVertex:i,dimensions:o,uuid:c}})=>{try{let f=!1;if(e===0){const a=te(o,t,s,r,n);try{g=ae(a,o)}catch(u){console.warn(u),g=new Map(Object.entries(a))}if(D(i,g,r),m||g.size<=o)f=!0;else try{d=we({curvature:n,mirrorsPlanes:l,rootVertex:i,dimensions:o})}catch(u){f=!0,D(i,g,r),console.warn(u)}}(e>0||f)&&(d=pe({curvature:n,mirrorsPlanes:l,rootVertex:i,dimensions:o})),postMessage({vertices:p,edges:k,faces:z,order:e,uuid:c}),O+=p.length,p=[],k=[],z=[]}catch(f){postMessage({error:f.message,uuid:c})}}})();
