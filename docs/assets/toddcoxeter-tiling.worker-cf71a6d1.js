(function(){"use strict";const ue=(e,t=null,n=1,s=!1)=>{if(t===null&&(t=e,e=0),n===0)throw new Error("Step cannot be zero.");if(t<e&&n>0||t>e&&n<0){if(s)return[];n=-n}return new Array(Math.ceil((t-e)/n)).fill().map((l,o)=>e+o*n)},_=(e,t)=>e.length!==t.length?!1:e.every((n,s)=>Array.isArray(n)?_(n,t[s]):n===t[s]),{abs:$,cos:R,sin:G,tan:Ve,cosh:We,sinh:Ae,acos:re,acosh:Se,atan:Ee,atan2:Pe,min:Re,max:Ne,round:fe,sqrt:ge,cbrt:Oe,sign:Te,ceil:_e,floor:Ge,log:Ue,exp:Be,hypot:Fe,pow:Le,PI:U}=Math,d=e=>String.fromCharCode(97+e),x=(e,t,n,s=[])=>{const l=[];for(let o=0;o<e;o++)s.includes(o)||l.push(d(o).repeat(2));for(let o=1;o<e;o++)for(let c=0;c<o;c++)!s.includes(o)&&!s.includes(c)&&t[o][c]>1&&l.push((d(c)+d(o)).repeat(t[o][c]));if(!s.length&&n&&!n.every(o=>o.every(c=>c===1))){if(e===4&&n[0][1]>1!=n[2][3]>1&&t[0][1]>3&&t[2][3]>3)n[0][1]>1&&l.push("abcdcb".repeat(L(t[0][1],t[1][2],t[0][2],n[0][1]))),n[2][3]>1&&l.push("abcdcb".repeat(L(t[2][3],t[1][2],t[1][3],n[2][3])));else for(let o=1;o<e;o++)for(let c=0;c<o;c++)if(n[c][o]>1){if(c+2<e){const i=L(t[c+1][o+1],t[c][o],t[c][o+1],n[c][o]);l.push((d(c)+d(o)+d(c+2)+d(o)).repeat(i))}if(c-1>=0){const i=L(t[c-1][o-1],t[c][o],t[c-1][o],n[c][o]);l.push((d(c)+d(o)+d(c)+d(c-1)).repeat(i))}}}return l},k=(e,t)=>{let n=0;for(let s=0;s<e.length;s++)n+=e[s]*t[s];return n},he=(e,t)=>{const n=[];for(let s=0;s<e.length;s++)n[s]=e[s]-t[s];return n},X=(e,t)=>{const n=[];for(let s=0;s<e.length;s++)n[s]=e[s]*t;return n},B=(e,t)=>{const n=new Array(e.length);for(let s=0;s<e.length;s++){let l=0;for(let o=0;o<e[0].length;o++)l+=e[s][o]*t[o];n[s]=l}return n},F=(e,t)=>e.filter((n,s)=>!t.includes(s)),I=(e,t)=>F(e,t).map(n=>F(n,t)),de=(e,t,n)=>he(e,X(B(ye(n),t),2*k(B(be(n),e),t))),we=(e,t)=>t.some((n,s)=>n.some((l,o)=>s===o&&l===0))?X(e,1/e[e.length-1]):X(e,-1/ge($(k(B(t,e),e)))),ae=1,be=e=>e.map((t,n)=>t.map((s,l)=>n===l&&s===0?ae:s)),ye=e=>e.map(t=>t.map(n=>$(n))),L=(e,t,n,s)=>{const l=U/e,o=U/t,c=U/n;return fe(U/re(-R(l)*R(c)+G(l)*G(c)*((R(o)-R(s*l)*R(c))/(G(s*l)*G(c)))))},m=e=>e!==""&&e!=="x",ee=e=>e==="s"||e==="b",Me=e=>isNaN(e)?1:+e,ve=e=>{const t=e.toUpperCase();return e===t?e.toLowerCase():t},a=(e,t)=>{let n=t;for(;e.quotientMap[n];)n=e.quotientMap[n];return n},te=(e,t,n)=>{const s=t,l=[[t,n]];for(;l.length>0;)if([t,n]=l.pop(),t=a(e,t),n=a(e,n),t!==n){e.quotientMap[n]=t,e.seen.has(n)&&!e.seen.has(t)&&e.seen.add(t);const o=e.cosets.get(t),c=e.cosets.get(n);e.cosets.delete(n);for(const[i,u]of c)o.has(i)?l.push([o.get(i),u]):o.set(i,u)}return a(e,s)},ne=(e,t,n,s)=>{t=a(e,t);const l=e.cosets.get(t);l.has(n)?te(e,l.get(n),s):l.set(n,s)},H=(e,t,n,s)=>{t=a(e,t);let l;const o=e.cosets.get(t);return o.has(n)?(l=a(e,o.get(n)),s!==void 0&&l!==s&&te(e,s,l)):(s?l=s:(l=e.nextVertex++,e.cosets.set(l,new Map),e.unvisited.push(l)),ne(e,t,n,l),ne(e,l,ve(n),t)),l},se=function(e,t,n){let s=n;for(let l=t.length-1;l>0;l--)s=H(e,s,t[l]);H(e,s,t[0],n)},pe=function(e,t){const n=a(e,1),s=new Map;s.set(n,"");const l=[n];for(;l.length>0;){const o=l.shift(),c=a(e,o);for(let i=0;i<t.length;i++){const u=t[i],j=e.cosets.get(c);if(j.size<e.gens.length*2)return s;const b=a(e,j.get(u));if(!s.has(b)){if(e.cosets.get(b).size<e.gens.length*2)return s;s.set(b,u+s.get(c)),l.push(b)}}}return s},Ce=(e,t)=>{let n=1;for(let s=t.length-1;s>=0;s--){n=a(e,n);const l=e.cosets.get(n);if(l.size<e.gens.length*2||(n=a(e,l.get(t[s])),e.cosets.get(n).size<e.gens.length*2))return}return n},qe=e=>{if(!e.cosets){e.unvisited=[1],e.cosets=new Map([[1,new Map]]),e.nextVertex=2,e.seen=new Set,e.quotientMap={};for(let t=0;t<e.subgens.length;t++)se(e,e.subgens[t],1)}e.limit=e.limit||1e3,e.done=!1;for(let t=0;t<e.limit;t++){let n=null;for(;e.unvisited.length>0;){const s=a(e,e.unvisited.shift());if(!e.seen.has(s)){e.seen.add(s),n=s;break}}if(n===null){e.done=!0;break}for(let s=0;s<e.gens.length;s++)H(e,n,e.gens[s].toUpperCase()),H(e,n,e.gens[s]);for(let s=0;s<e.rels.length;s++)se(e,e.rels[s],n)}},J=e=>(qe(e),e.verticesWords=pe(e,e.gens),e.words=Array.from(e.verticesWords.values()),e),le=(e,t=[])=>e.map((n,s)=>t.includes(s)?"":d(s)).join(""),oe=(e,t=[])=>e.map((n,s)=>t.includes(s)||n?"":d(s)).join(""),je=(e,t)=>{if(t===0)return!0;let n=e[e.length-1];const s=new Set;for(let l=0;l<n.length;l++){const o=n[l];if(!(!o||s.has(o))&&(s.add(o),s.size===t))return!0}return!1},Y=(e,t,n,s,l=null,o=null,c=new Map)=>{l=l||s.map((i,u)=>m(i)?null:u).filter(i=>i!==null),o=o||{new:!0,dimensions:e,coxeter:t,stellation:n,mirrors:s,skips:l,gens:le(s,l),subgens:oe(s,l),rels:x(e,t,n,l),quotient:"",space:[""],snub:s.some(ee),children:[]};for(let i=0;i<e;i++){if(l.includes(i))continue;const u=[...l,i],j=ue(e).filter(v=>!u.includes(v)),b=u.sort().join("-");let D=!1;if(!c.has(b)){D=!0;const v={key:b,dimensions:e-u.length,coxeter:I(t,u),stellation:I(n,u),mirrors:F(s,u),skips:u,gens:le(s,u),subgens:oe(s,u),rels:x(e,t,n,u),snub:F(s,u).some(ee)};J(v),c.set(b,v)}const w=c.get(b),z=w.words;if(je(z,w.dimensions)){let v="";if(w.snub&&z.length<=w.dimensions)console.warn("TODO"),z.push(...u.map(d));else for(let y=0;y<e;y++)(!u.includes(y)||m(s[y])&&!s[y]&&!j.some(P=>t[P][y]!==2))&&(v+=d(y));let V={new:D,...w,quotient:v,space:z,children:[]};w.dimensions>0&&(V=Y(e,t,n,s,u,V,c)),o.children.push(V)}}if(o.children.length===0){console.info("No leaf found, digging deeper",l);for(let i=0;i<e;i++){if(l.includes(i))continue;const u=[...l,i];o.children.push(Y(e,t,n,s,u,{children:[]},c))}}return o};let A=null,S=null,N=null,O=null,E=null;const De=(e,t,n,s)=>{if(E&&e===E.dimensions&&_(t,E.coxeter)&&_(n,E.stellation)&&_(s,E.mirrors)){S.params.done=!1,N.forEach(c=>{c.lastDrawn=0,c.params.done=!1}),O.forEach(c=>{c.lastDrawn=0,c.params.done=!1}),A=new Map;return}E={dimensions:e,coxeter:t,stellation:n,mirrors:s},A=new Map;const l=Y(e,t,n,s);S=null,N=[],O=[];const o=c=>{c.new&&(c.dimensions===2?O.push({shape:l,subShape:c,params:{...l,subgens:c.quotient},lastDrawn:0,toRetry:new Set}):c.dimensions===1?N.push({shape:l,subShape:c,params:{...l,subgens:c.quotient},lastDrawn:0}):c.dimensions===0&&(S={shape:l,subShape:c,params:{...l,subgens:c.quotient},lastDrawn:0})),c.children&&c.children.forEach(o)};o(l)},ze=(e,t)=>{const{rootVertex:n,rootNormals:s,metric:l}=e;let o=n;for(let c=t.length-1;c>=0;c--)o=de(o,s[t.charCodeAt(c)-97],l);return o};onmessage=({data:{order:e,curvature:t,metric:n,coxeter:s,stellation:l,mirrors:o,rootVertices:c,rootNormals:i,dimensions:u,uuid:j}})=>{e===0&&De(u,s,l,o);let b=we(B(c,o.map(w=>Me(w))),n);const D=(e+1)*(t>0?200:100);try{let w=[],z=[],v=[],V=[];const y=S.params;if(!y.done){y.limit=D,J(y);for(const[h,g]of y.verticesWords){if(A.has(h))continue;let r;g===""?r=b:r=ze({rootVertex:b,rootNormals:i,metric:n},g),w.push({vertex:r,word:g}),A.set(h,A.size)}}const P=h=>A.get(Ce(S.params,h));for(let h=0;h<N.length;h++){const g=N[h],r=g.params,K=g.subShape;r.done||(r.limit=D,J(r));for(let f=g.lastDrawn;f<r.words.length;f++){const W=r.words[f];if(W===void 0)continue;const M=W+K.space[0],q=P(M),p=W+K.space[1],C=P(p);if(q===void 0||C===void 0){g.lastDrawn=f;break}z.push({start:q,end:C,word:W,subShape:h}),g.lastDrawn=f+1}}for(let h=0;h<O.length;h++){const g=O[h],r=g.params,K=g.shape,f=g.subShape,W=f.mirrors.every(M=>!!M);K.dimensions===2&&(r.words=r.space,f.space=S.params.words,r.done=!0),r.done||(r.limit=D,J(r));for(const M of g.toRetry){const q=r.words[M],p=[];for(let C=0;C<f.space.length;C++){const T=ce(C,f.space.length,W),Z=q+f.space[T],Q=P(Z);Q!==void 0&&p.push(Q)}p.length===f.space.length?(v.push({vertices:p,word:q,len:f.space.length,subShape:h}),g.toRetry.delete(M)):V.push({vertices:p,word:q,len:f.space.length,subShape:h})}for(let M=g.lastDrawn;M<r.words.length;M++){let q=!1;const p=r.words[M],C=[];for(let T=0;T<f.space.length;T++){const Z=ce(T,f.space.length,W),Q=p+f.space[Z],ie=P(Q);if(ie===void 0){q=!0;continue}C.push(ie)}q?(V.push({vertices:C,word:p,len:f.space.length}),g.toRetry.add(M)):v.push({vertices:C,word:p,len:f.space.length,subShape:h}),g.lastDrawn=M+1}}postMessage({vertices:w,edges:z,faces:v,partials:V,order:e,uuid:j})}catch(w){postMessage({error:w.message,uuid:j})}};const ce=(e,t,n=!1)=>{if(n){const s=e>0?1-e%2:0;return e>=t/2+s?2*(t-e)-1+s:2*e-s}return e>=t/2?2*(t-e)-1:2*e}})();
