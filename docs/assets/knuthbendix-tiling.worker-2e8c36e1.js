(function(){"use strict";const J=(e,n,t)=>{let s=0;for(let r=0;r<e.length;r++)s+=e[r]*n[r]*(r===e.length-1&&t||1);return s},Q=(e,n,t)=>{e=e.slice();const s=2*J(e,n,t);for(let r=0;r<e.length;r++)e[r]-=s*(t||r!==e.length-1?n[r]:0);return e},M=(e,n,t,s)=>{const r=S/e,l=S/n,i=S/t;return O(S/U(-b(r)*b(i)+C(r)*C(i)*((b(l)-b(s*r)*b(i))/(C(s*r)*C(i)))))},{abs:de,cos:b,sin:C,tan:me,cosh:be,sinh:ye,acos:U,acosh:Me,atan:Ce,atan2:Se,min:je,max:ke,round:O,sqrt:xe,sign:ve,ceil:Be,floor:Te,log:Re,exp:_,hypot:Ae,pow:Ee,PI:S}=Math,$=new ArrayBuffer(8),V=new Float64Array($),I=new Int32Array($);function X(e){return~~e===e?~~e:(V[0]=e,I[0]^I[1])}const F=10**4,Y=e=>{let n="";for(let t=0;t<e.length;t++)n+=X(O(e[t]*F)/F).toString(),t<e.length-1&&(n+="|");return n},h=e=>String.fromCharCode(97+e),Z=(e,n,t,s,r,l=[])=>{const i=[];for(let o=0;o<e;o++)l.includes(o)||i.push(h(o).repeat(2));for(let o=1;o<e;o++)for(let c=0;c<o;c++)!l.includes(o)&&!l.includes(c)&&n[o][c]>1&&i.push((h(c)+h(o)).repeat(n[o][c]));if(t&&!t.every(o=>o.every(c=>c===1))&&r>0){if(e===4&&(t[0][1]>1||t[2][3]>1)&&n[0][1]>3&&n[2][3]>3)t[0][1]>1&&i.push("abcdcb".repeat(M(n[0][1],n[1][2],n[0][2],t[0][1]))),t[2][3]>1&&i.push("abcdcb".repeat(M(n[2][3],n[1][2],n[1][3],t[2][3])));else for(let o=1;o<e;o++)for(let c=0;c<o;c++)if(t[c][o]>1){if(c+2<e){const f=M(n[c+1][o+1],n[c][o],n[c][o+1],t[c][o]);i.push((h(c)+h(o)+h(c+2)+h(o)).repeat(f))}if(c-1>=0){const f=M(n[c-1][o-1],n[c][o],n[c-1][o],t[c][o]);i.push((h(c)+h(o)+h(c)+h(c-1)).repeat(f))}}}return i},ee=(e,n,t,s,r)=>Object.fromEntries(Z(e,n,null,s,r).map(l=>[l,""])),H=(e,n)=>{const t=e.length-n.length;return t!==0?Math.sign(t):e<=n?-1:1},P=e=>e.split("").reverse().join(""),te=(e,n)=>{const t=e.length-n.length;return t!==0?Math.sign(t):H(P(e),P(n))},ne=(e,n)=>{const t=new Map,s=Object.keys(e).sort(n);for(let r=0;r<s.length;r++){const l=s[r],[i,o]=[l,e[l]].sort(n);t.has(o)?t.set(o,[i,t.get(o)].sort()[0]):t.set(o,i)}return t},y=(e,n)=>{if(n.length===0||e.size===0)return n;const t=e._re_cache||new RegExp([...e.keys()].join("|"),"g");let s=n;do n=s,s=n.replace(t,r=>e.get(r));while(s!==n);return n},se=(e,n)=>{const t=new Map(e);for(e=[...e.entries()];e.length>0;){K();const[s,r]=e.pop();t.delete(s);const l=y(t,s),i=y(t,r);let o=!0;if(l===i)o=!1;else{const[c,f]=[l,i].sort(n);f!==s&&c!==r&&(t.set(f,c),e.push([f,c]),o=!1)}o&&t.set(s,r)}return t},re=function(e,n){if(n.length===0)return null;const t=Math.max(0,e.length-n.length);for(let s=t;s<e.length;s++)if(e[s]===n[0]&&e.slice(s+1)===n.slice(1,e.length-s))return{prefix:e.slice(0,s),suffix:n.slice(e.length-s)}},oe=function(e,n){if(n.length===0)return null;for(let t=0;t<e.length-n.length+1;t++)if(e.slice(t,t+n.length)===n)return{prefix:e.slice(0,t),suffix:e.slice(t+n.length)}},ce=(e,n,t,s)=>{const r=re(e,t);if(r)return{s1:r.prefix+s,s2:n+r.suffix};const l=oe(e,t);if(l)return{s1:n,s2:l.prefix+s+l.suffix}},le=(e,n)=>{const t=new Map(e),s=[...e.entries()];for(let r=0;r<s.length;r++){K();const[l,i]=s[r];for(let o=0;o<s.length;o++){if(r===o)continue;const[c,f]=s[o],a=ce(l,i,c,f);if(a){const u=y(e,a.s1),T=y(e,a.s2);if(u!==T){const[R,A]=[u,T].sort(n);t.set(A,R)}}}}return t},ie=(e,n)=>le(se(e,n),n),fe=(e,n)=>{if(e.size!==n.size)return!1;const t=e.keys();for(;;){const{done:s,value:r}=t.next();if(s)return!0;if(e.get(r)!==n.get(r))return!1}},he=(e,n)=>{for(e=ne(e,n);;){const t=ie(e,n);if(fe(t,e))return t._re_cache=new RegExp([...t.keys()].join("|"),"g"),t;e=t}};let q,L;const K=()=>{if(performance.now()-q>L)throw new Error("Timeout")},ue=(e,n)=>{const t=[50,100,_(n)*4,_(n)*10].map(s=>[s,s]).flat();for(let s=0;s<t.length;s++){L=t[s];try{return q=performance.now(),he(e,s%2?H:te)}catch(r){if(r.message!=="Timeout")throw r}}throw new Error("Timeout")},j=(e,n)=>y(e,n),ae=e=>e==="s"||e==="b";let k=new Map,E=new Set,p=[],x=[],W=[],z=0,w=new Map,d=[],v=null,m=!1,g=null;const N=(e,n,t)=>{z=0,p=[],x=[],W=[],k.clear(),E.clear(),w.clear(),w.set("",D("",e)),d=[""],v=t,g=n;const s=v.map((r,l)=>ae(r)?h(l):"").join("");m=s.length>0?new RegExp(`[^${s}]`,"g"):null},ge=(e,n)=>{const{rootVertex:t,mirrorsPlanes:s,curvature:r}=e;let l=t;for(let i=n.length-1;i>=0;i--)l=Q(l,s[n.charCodeAt(i)-97],r);return l};function D(e,n){const t=Y(n);if(k.has(t))return k.get(t);{const s=z+p.length;return k.set(t,s),p.push({vertex:n,word:e}),s}}function G(e,n){const t=w.get(e),s=w.get(n);if(t===s)return;const r=t>s?`${s}-${t}`:`${t}-${s}`;if(!E.has(r))return E.add(r),x.push({start:t,end:s,word:e,newWord:n}),!0}const B=(e,n,t)=>{if(n===t)return;if(w.has(t)){G(n,t);return}const s=ge(e,t),r=D(t,s);return w.set(t,r),G(n,t),t},pe=e=>{const{dimensions:n}=e;let t;t=[];for(let s=0;s<d.length;s++){const r=d[s];for(let l=0;l<n;l++){const i=h(l),o=j(g,r+i);if(m&&o.replace(m,"").length%2)for(let c=0;c<v.length;c++){const f=h(c),a=j(g,o+f);if(a.replace(m,"").length%2)for(let u=0;u<v.length;u++){const T=h(u),R=j(g,a+T);if(R.replace(m,"").length%2)continue;const A=B(e,r,R);A&&t.push(A)}else{const u=B(e,r,a);u&&t.push(u)}}else{const c=B(e,r,o);c&&t.push(c)}}}return t},we=e=>{const{dimensions:n}=e;let t=[""],s;const r=1e4;let l=d;do{s=[];for(let i=0;i<l.length;i++){const o=l[i];for(let c=0;c<n-1;c++){const f=h(c),a=j(g,o+f),u=B(e,o,a);u&&s.push(u)}}t=t.concat(s),l=s}while(s.length&&t.length<=r);if(t.length>r)throw new Error("Could not tile fundamental chamber");return t};onmessage=({data:{order:e,curvature:n,coxeter:t,stellation:s,mirrors:r,mirrorsPlanes:l,rootVertex:i,dimensions:o,uuid:c}})=>{try{let f=!1;if(e===0){const a=ee(o,t,s,r,n);try{g=ue(a,o)}catch(u){console.warn(u),g=new Map(Object.entries(a))}if(N(i,g,r),m||g.size<=o)f=!0;else try{d=we({curvature:n,mirrorsPlanes:l,rootVertex:i,dimensions:o})}catch(u){f=!0,N(i,g,r),console.warn(u)}}(e>0||f)&&(d=pe({curvature:n,mirrorsPlanes:l,rootVertex:i,dimensions:o})),postMessage({vertices:p,edges:x,faces:W,order:e,uuid:c}),z+=p.length,p=[],x=[],W=[]}catch(f){postMessage({error:f.message,uuid:c})}}})();
