(function(){"use strict";const{abs:S,cos:P,sin:R,cosh:D,sinh:G,acos:J,acosh:K,tan:L,min:O,max:Q,round:$,sqrt:U,sign:X,floor:Y,log:Z,exp:V,PI:v}=Math,B=(e,t)=>{if(t.length===0||e.size===0)return t;const n=e._re_cache||new RegExp([...e.keys()].join("|"),"g");let s=t;do t=s,s=t.replace(n,r=>e.get(r));while(s!==t);return t},M=(e,t)=>B(e,t),j=(e,t,n)=>{let s=0;for(let r=0;r<e.length;r++)s+=e[r]*t[r]*(r===e.length-1&&n||1);return s},F=(e,t,n)=>{e=e.slice();const s=2*j(e,t,n);for(let r=0;r<e.length;r++)e[r]-=s*(n||r!==e.length-1?t[r]:0);return e};let g=new Set,d=new Set,h=[],f=[],a=new Map,i=[],w=null;const x=(e,t)=>{g.clear(),d.clear(),a.clear(),a.set("",e),h=[],f=[],i=[""],w=t},I=(e,t)=>{for(let n=0;n<e.length;n++)if(S(e[n]-t[n])>1e-8)return!1;return!0},C=new ArrayBuffer(8),z=new Float64Array(C),k=new Int32Array(C);function E(e){return~~e===e?~~e:(z[0]=e,k[0]^k[1])}const b=10**4,m=e=>{let t="";for(let n=0;n<e.length;n++)t+=E($(e[n]*b)/b).toString(),n<e.length-1&&(t+="|");return t},T=(e,t)=>{const{rootVertex:n,mirrorsPlanes:s,curvature:r}=e;let o=n;for(let c=t.length-1;c>=0;c--)o=F(o,s[t.charCodeAt(c)-97],r);return o};function y(e,t){const n=m(e);if(!g.has(n))return g.add(n),h.push({vertex:e,word:t}),!0}function A(e,t,n){const s=m(t),r=m(n);if(s===r)return;const o=s>r?`${r}/${s}`:`${s}/${r}`;if(!d.has(o)&&(d.add(o),!I(t,n))){const c=t.slice(),l=n.slice();return f.push({start:c,end:l,word:e}),!0}}const H=(e,t,n,s)=>{const r=String.fromCharCode(97+n);if(t.slice(-1)===r)return;let o=t+r;if(o=M(w,o),a.has(o)){const l=a.get(o);A(t,s,l);return}const c=T(e,o);return a.set(o,c),y(c,o)&&A(t,s,c),o},_=e=>{const{rootVertex:t}=e;let n=[""],s;const r=1e4,o=t.length;y(t,"");let c=i;do{s=[];for(let l=0;l<c.length;l++){const u=c[l],N=a.get(u);for(let p=0;p<o-1;p++){const W=H(e,u,p,N);W&&s.push(W)}}n=n.concat(s),c=s}while(s.length&&n.length<=r);if(n.length>r)throw new Error("Could not tile fundamental chamber");return n},q=e=>{let t;t=[];for(let n=0;n<i.length;n++){const s=i[n],r=a.get(s);for(let o=0;o<r.length;o++){const c=H(e,s,o,r);c&&t.push(c)}}return t};onmessage=({data:{first:e,curvature:t,rules:n,mirrorsPlanes:s,rootVertex:r,dimensions:o,uuid:c}})=>{try{let l=!1;if(e){x(r,n);try{i=_({first:e,curvature:t,mirrorsPlanes:s,rootVertex:r,dimensions:o})}catch(u){l=!0,x(r,n),console.warn(u)}}(!e||l)&&(i=q({first:e,curvature:t,mirrorsPlanes:s,rootVertex:r,dimensions:o})),postMessage({vertices:h,edges:f,uuid:c}),h=[],f=[]}catch(l){postMessage({error:l.message,uuid:c})}}})();
