(function(){"use strict";const{abs:g,cos:z,sin:ae,cosh:he,sinh:ue,acos:ge,acosh:de,min:we,max:pe,round:E,sqrt:p,sign:m,floor:me,log:xe,exp:x,PI:F}=Math,c={coxeter:null,vertices:[],edges:[],words:new Map,rules:new Set,edgeHashes:new Set,vertexHashes:new Set,wordsToConsider:[],rootVertices:null,rootVertex:null,gram:null,mirrors:null},b=e=>{Object.assign(c,e)},I=(e,n)=>{const t=e.length-n.length;return t!==0?Math.sign(t):e<=n?-1:1},O=(e,n)=>{const t=e.length-n.length;return t!==0?Math.sign(t):e<=n?1:-1},q=(e,n)=>{const t=new Map,r=Object.keys(e).sort(n);for(let o=0;o<r.length;o++){const s=r[o],[l,i]=[s,e[s]].sort(n);t.has(i)?t.set(i,[l,t.get(i)].sort()[0]):t.set(i,l)}return t},h=(e,n)=>{if(n.length===0||e.size===0)return n;const t=e._re_cache||new RegExp([...e.keys()].join("|"),"g");let r=n;do n=r,r=n.replace(t,o=>e.get(o));while(r!==n);return n},L=(e,n)=>{const t=new Map(e);for(e=[...e.entries()];e.length>0;){k();const[r,o]=e.pop();t.delete(r);const s=h(t,r),l=h(t,o);let i=!0;if(s===l)i=!1;else{const[f,a]=[s,l].sort(n);a!==r&&f!==o&&(t.set(a,f),e.push([a,f]),i=!1)}i&&t.set(r,o)}return t},$=function(e,n){if(n.length===0)return null;const t=Math.max(0,e.length-n.length);for(let r=t;r<e.length;r++)if(e[r]===n[0]&&e.slice(r+1)===n.slice(1,e.length-r))return{prefix:e.slice(0,r),suffix:n.slice(e.length-r)}},K=function(e,n){if(n.length===0)return null;for(let t=0;t<e.length-n.length+1;t++)if(e.slice(t,t+n.length)===n)return{prefix:e.slice(0,t),suffix:e.slice(t+n.length)}},N=(e,n,t,r)=>{const o=$(e,t);if(o)return{s1:o.prefix+r,s2:n+o.suffix};const s=K(e,t);if(s)return{s1:n,s2:s.prefix+r+s.suffix}},P=(e,n)=>{const t=new Map(e),r=[...e.entries()];for(let o=0;o<r.length;o++){k();const[s,l]=r[o];for(let i=0;i<r.length;i++){if(o===i)continue;const[f,a]=r[i],u=N(s,l,f,a);if(u){const _=h(e,u.s1),R=h(e,u.s2);if(_!==R){const[ce,fe]=[_,R].sort(n);t.set(fe,ce)}}}}return t},G=(e,n)=>P(L(e,n),n),J=(e,n)=>{if(e.size!==n.size)return!1;const t=e.keys();for(;;){const{done:r,value:o}=t.next();if(r)return!0;if(e.get(o)!==n.get(o))return!1}},Q=(e,n)=>{for(e=q(e,n);;){const t=G(e,n);if(J(t,e))return t._re_cache=new RegExp([...t.keys()].join("|"),"g"),t;e=t}};let C,y;const k=()=>{if(performance.now()-C>y)throw new Error("Timeout")},U=(e,n)=>{const t=[50,100,250,x(n)*100,x(n)*200].map(r=>[r,r]).flat();for(let r=0;r<t.length;r++){y=t[r];try{return C=performance.now(),Q(e,r%2?I:O)}catch(o){if(o.message!=="Timeout")throw o}}throw new Error("Timeout")},d=e=>String.fromCharCode(97+e),X=(e,n)=>{const t={};for(let r=0;r<e;r++)t[d(r).repeat(2)]="";for(let r=1;r<e;r++)for(let o=0;o<r;o++)t[(d(o)+d(r)).repeat(n[r][o])]="";return U(t,e)},Y=e=>h(c.rules,e),T=e=>{if(e.length===1)return e[0][0];let n=0;for(let t=0;t<e.length;t++){const r=new Array(e.length-1).fill().map(()=>new Array(e.length-1).fill(0));for(let s=1;s<e.length;s++)for(let l=0;l<e.length;l++)l<t?r[s-1][l]=e[s][l]:l>t&&(r[s-1][l-1]=e[s][l]);const o=t%2===0?1:-1;n+=e[0][t]*o*T(r)}return n},Z=e=>{const n=T(e);return g(n)<1e-8?0:m(n)},j=(e,n,t)=>{let r=0;for(let o=0;o<e.length;o++)r+=e[o]*n[o]*(o===e.length-1&&t||1);return r},D=(e,n,t)=>{e=e.slice();const r=2*j(e,n,t);for(let o=0;o<e.length;o++)e[o]-=r*(t||o!==e.length-1?n[o]:0);return e},ee=(e,n)=>{if(e=e.slice(),n===0){for(let r=0;r<e.length;r++)e[r]/=e[e.length-1];return e}const t=(n===-1&&m(e[e.length-1])||1)/p(g(j(e,e,n)));for(let r=0;r<e.length;r++)e[r]*=t;return e},te=(e,n)=>{const t=e[0].length,r=new Array(t).fill().map(()=>new Array(t).fill(0));r[0][0]=1;for(let o=1;o<t;o++){for(let s=0;s<o;s++){let l=0;for(let i=0;i<s;i++)l+=r[o][i]*r[s][i];r[o][s]=(e[o][s]-l)/r[s][s]}r[o][o]=p(g(1-r[o].slice(0,o).reduce((s,l)=>s+l*l,0)))}return r[r.length-1][r.length-1]=n?r[r.length-1][r.length-1]*n:1,r},M=(e,n,t)=>{const r=n.length,o=new Array(r);for(let s=0;s<r;s++){let l=0;for(let i=0;i<s;i++)l+=e[s][i]*o[i];o[s]=(n[s]-l)/e[s][s]}return o[o.length-1]*=t||1,ee(o,t)},ne=(e,n)=>{for(let t=0;t<e.length;t++)if(g(e[t]-n[t])>1e-8)return!1;return!0},re=e=>{let n=c.rootVertex;for(let t=e.length-1;t>=0;t--)n=D(n,c.mirrors[e.charCodeAt(t)-97],c.curvature);return n},A=new ArrayBuffer(8),oe=new Float64Array(A),H=new Int32Array(A);function se(e){return~~e===e?~~e:(oe[0]=e,H[0]^H[1])}const S=10**4,w=e=>{let n="";for(let t=0;t<e.length;t++)n+=se(E(e[t]*S)/S).toString(),t<e.length-1&&(n+="|");return n},V=(e,n,t,r,o)=>{const s=X(e,t);if(n)for(let i=0;i<e;i++)for(let f=0;f<e;f++)t[i][f]/=r[i][f];const l={coxeter:t,vertices:[],edges:[],words:new Map,edgeHashes:new Set,vertexHashes:new Set,wordsToConsider:[""],rootVertices:null,rootVertex:null,rules:s};l.gram=l.coxeter.map(i=>i.map(f=>-z(F/f))),l.curvature=Z(l.gram),l.mirrors=te(l.gram,l.curvature),l.rootVertices=l.mirrors.map((i,f)=>M(l.mirrors,new Array(e).fill(0).map((a,u)=>f===u?l.curvature||1:0),l.curvature)),l.rootVertex=M(l.mirrors,o,l.curvature),l.words.set("",l.rootVertex),b(l)},W=(e,n,t)=>{const r=String.fromCharCode(97+n);if(e.slice(-1)===r)return;const o=Y(e+r);if(c.words.has(o)){const l=c.words.get(o);v(e,o,t,l);return}const s=re(o);return c.words.set(o,s),B(s,e),v(e,o,t,s),o},le=()=>{let e=[""],n,t=25;const r=c.rootVertex.length;B(c.rootVertex,"");do{n=[];for(let o=0;o<c.wordsToConsider.length;o++){const s=c.wordsToConsider[o],l=c.words.get(s);for(let i=0;i<r-1;i++){const f=W(s,i,l);f&&n.push(f)}}e.push(...n),c.wordsToConsider=n}while(n.length&&t--);if(t<0)throw new Error("Could not tile fundamental chamber");c.wordsToConsider=e},ie=()=>{let e;e=[];for(let n=0;n<c.wordsToConsider.length;n++){const t=c.wordsToConsider[n],r=c.words.get(t);for(let o=0;o<r.length;o++){const s=W(t,o,r);s&&e.push(s)}}c.wordsToConsider=e};function B(e,n){const t=w(e);c.vertexHashes.has(t)||(c.vertexHashes.add(t),c.vertices.push({vertex:e,word:n}))}function v(e,n,t,r){const o=w(t),s=w(r);if(o===s)return;const l=[o,s].sort().join("/");if(!c.edgeHashes.has(l)&&(c.edgeHashes.add(l),!ne(t,r))){const i=t.slice(),f=r.slice();return c.edges.push({start:i,end:f,word:e}),!0}}onmessage=({data:{dimensions:e,coxeter:n,coxeterDiv:t,stellation:r,mirrors:o,currentOrder:s,uuid:l}})=>{try{if(s===0){V(e,r,n,t,o);try{le()}catch(i){i.message==="Could not tile fundamental chamber"&&V(e,r,n,t,o)}}else c.vertices=[],c.edges=[],ie();postMessage({curvature:c.curvature,vertices:c.vertices,edges:c.edges,currentOrder:s+1,uuid:l})}catch(i){postMessage({error:i.message,uuid:l})}}})();
