(function(){"use strict";const u={...{p:5,q:2,r:2,s:3,t:2,u:4,pDiv:1,qDiv:1,rDiv:1,sDiv:1,tDiv:1,uDiv:1,x:1,y:0,z:0,w:0,dimensions:4,order:10,segments:32,curve:!0,vertices:!1,edges:!0,stellation:!1,light:1.5,thickness:1,projection:"stereographic",controls:"orbit",ambiance:"neon"}},F=(e,t=!1)=>{Object.assign(u,e),t&&window.history.pushState(null,null,"#"+btoa(JSON.stringify(u)))},{abs:w,cos:L,sin:pe,cosh:we,sinh:xe,acos:ve,acosh:ye,min:be,max:Te,round:ke,sqrt:T,sign:H,floor:Ce,log:De,PI:I}=Math,i={coxeter:null,vertices:[],edges:[],words:new Map,rules:new Set,edgeHashes:new Set,vertexHashes:new Set,wordsToConsider:[],rootVertices:null,rootVertex:null,gram:null,mirrors:null},J=e=>{Object.assign(i,e)},K=(e,t)=>{const n=e.length-t.length;return n!==0?Math.sign(n):e<=t?-1:1},N=(e,t)=>{const n=e.length-t.length;return n!==0?Math.sign(n):e<=t?1:-1},P=(e,t)=>{const n=new Map,s=Object.keys(e).sort(t);for(let r=0;r<s.length;r++){const o=s[r],[c,l]=[o,e[o]].sort(t);n.has(l)?n.set(l,[c,n.get(l)].sort()[0]):n.set(l,c)}return n},x=(e,t)=>{if(t.length===0||e.size===0)return t;const n=e._re_cache||new RegExp([...e.keys()].join("|"),"g");let s=t;do t=s,s=t.replace(n,r=>e.get(r));while(s!==t);return t},$=(e,t)=>{const n=new Map(e);for(e=[...e.entries()];e.length>0;){z();const[s,r]=e.pop();n.delete(s);const o=x(n,s),c=x(n,r);let l=!0;if(o===c)l=!1;else{const[f,g]=[o,c].sort(t);g!==s&&f!==r&&(n.set(g,f),e.push([g,f]),l=!1)}l&&n.set(s,r)}return n},G=function(e,t){if(t.length===0)return null;const n=Math.max(0,e.length-t.length);for(let s=n;s<e.length;s++)if(e[s]===t[0]&&e.slice(s+1)===t.slice(1,e.length-s))return{prefix:e.slice(0,s),suffix:t.slice(e.length-s)}},Q=function(e,t){if(t.length===0)return null;for(let n=0;n<e.length-t.length+1;n++)if(e.slice(n,n+t.length)===t)return{prefix:e.slice(0,n),suffix:e.slice(n+t.length)}},U=(e,t,n,s)=>{const r=G(e,n);if(r)return{s1:r.prefix+s,s2:t+r.suffix};const o=Q(e,n);if(o)return{s1:t,s2:o.prefix+s+o.suffix}},X=(e,t)=>{const n=new Map(e),s=[...e.entries()];for(let r=0;r<s.length;r++){z();const[o,c]=s[r];for(let l=0;l<s.length;l++){if(r===l)continue;const[f,g]=s[l],y=U(o,c,f,g);if(y){const k=x(e,y.s1),C=x(e,y.s2);if(k!==C){const[d,p]=[k,C].sort(t);n.set(p,d)}}}}return n},Y=(e,t)=>X($(e,t),t),Z=(e,t)=>{if(e.size!==t.size)return!1;const n=e.keys();for(;;){const{done:s,value:r}=n.next();if(s)return!0;if(e.get(r)!==t.get(r))return!1}},m=(e,t)=>{for(e=P(e,t);;){const n=Y(e,t);if(Z(n,e))return n._re_cache=new RegExp([...n.keys()].join("|"),"g"),n;e=n}};let V,R;const z=()=>{if(performance.now()-V>R)throw new Error("Timeout")},ee=e=>{const t=[50,100,250].map(n=>[n,n]).flat();for(let n=0;n<t.length;n++){R=t[n];try{return V=performance.now(),m(e,n%2?K:N)}catch(s){if(s.message!=="Timeout")throw s}}throw new Error("Timeout")},te=(e,t,n,s,r,o,c)=>ee(e===3?{aa:"",bb:"",cc:"",["ab".repeat(t)]:"",["ac".repeat(n)]:"",["bc".repeat(s)]:""}:{aa:"",bb:"",cc:"",dd:"",["ab".repeat(t)]:"",["ac".repeat(n)]:"",["ad".repeat(s)]:"",["bc".repeat(r)]:"",["bd".repeat(o)]:"",["cd".repeat(c)]:""}),ne=e=>x(i.rules,e),h={curvature:0,edges:[],vertices:[],ranges:[]},se=e=>{Object.assign(h,e)},re=e=>{if(e.length===3)return e[0][0]*e[1][1]*e[2][2]+e[0][1]*e[1][2]*e[2][0]+e[0][2]*e[1][0]*e[2][1]-e[0][2]*e[1][1]*e[2][0]-e[0][1]*e[1][0]*e[2][2]-e[0][0]*e[1][2]*e[2][1];if(e.length===4)return e[0][0]*(e[1][1]*e[2][2]*e[3][3]+e[1][2]*e[2][3]*e[3][1]+e[1][3]*e[2][1]*e[3][2]-e[1][3]*e[2][2]*e[3][1]-e[1][2]*e[2][1]*e[3][3]-e[1][1]*e[2][3]*e[3][2])+e[0][1]*(e[1][0]*e[2][3]*e[3][2]+e[1][2]*e[2][0]*e[3][3]+e[1][3]*e[2][2]*e[3][0]-e[1][3]*e[2][0]*e[3][2]-e[1][2]*e[2][3]*e[3][0]-e[1][0]*e[2][2]*e[3][3])+e[0][2]*(e[1][0]*e[2][1]*e[3][3]+e[1][1]*e[2][3]*e[3][0]+e[1][3]*e[2][0]*e[3][1]-e[1][3]*e[2][1]*e[3][0]-e[1][1]*e[2][0]*e[3][3]-e[1][0]*e[2][3]*e[3][1])+e[0][3]*(e[1][0]*e[2][2]*e[3][1]+e[1][1]*e[2][0]*e[3][2]+e[1][2]*e[2][1]*e[3][0]-e[1][2]*e[2][0]*e[3][1]-e[1][1]*e[2][2]*e[3][0]-e[1][0]*e[2][1]*e[3][2])},oe=e=>{const t=re(e);return w(t)<1e-8?0:H(t)},_=(e,t,n=null)=>{const s=n===null?h.curvature:n;let r=0;for(let o=0;o<e.length;o++)r+=e[o]*t[o]*(o===e.length-1&&s||1);return r},ie=(e,t)=>{e=e.slice();const n=2*_(e,t);for(let s=0;s<e.length;s++)e[s]-=n*(h.curvature||s!==e.length-1?t[s]:0);return e},ce=e=>{if(e=e.slice(),h.curvature===0){for(let n=0;n<e.length;n++)e[n]/=e[e.length-1];return e}const t=(h.curvature===-1&&H(e[e.length-1])||1)/T(w(_(e,e)));for(let n=0;n<e.length;n++)e[n]*=t;return e},le=e=>{const t=new Array(u.dimensions).fill().map(()=>new Array(u.dimensions).fill(0));return t[0][0]=1,t[1][0]=e[1][0],t[1][1]=T(1-t[1][0]*t[1][0]),t[2][0]=e[2][0],t[2][1]=(e[2][1]-t[2][0]*t[1][0])/t[1][1],t[2][2]=T(w(1-t[2][0]*t[2][0]-t[2][1]*t[2][1])),u.dimensions===4&&(t[3][0]=e[3][0],t[3][1]=(e[3][1]-t[3][0]*t[1][0])/t[1][1],t[3][2]=(e[3][2]-t[3][0]*t[2][0]-t[3][1]*t[2][1])/t[2][2],t[3][3]=T(w(1-t[3][0]*t[3][0]-t[3][1]*t[3][1]-t[3][2]*t[3][2]))),t[t.length-1][t.length-1]=h.curvature?t[t.length-1][t.length-1]*h.curvature:1,t},q=(e,[t,n,s,r])=>{const o=new Array(u.dimensions);return o[0]=t,o[1]=(n-e[1][0]*o[0])/e[1][1],o[2]=(s-e[2][0]*o[0]-e[2][1]*o[1])/e[2][2],u.dimensions===4&&(o[3]=(r-e[3][0]*o[0]-e[3][1]*o[1]-e[3][2]*o[2])/e[3][3]),o[o.length-1]*=h.curvature||1,ce(o)},ae=(e,t)=>{for(let n=0;n<e.length;n++)if(w(e[n]-t[n])>1e-8)return!1;return!0},ue=e=>{let t=i.rootVertex;for(let n=e.length-1;n>=0;n--)t=ie(t,i.mirrors[e.charCodeAt(n)-97]);return t},v=e=>{let t="";for(let n=0;n<e.length;n++)t+=e[n].toString().slice(0,6),n<e.length-1&&(t+="|");return t},O=e=>{const{dimensions:t,stellation:n,pDiv:s,qDiv:r,rDiv:o,sDiv:c,tDiv:l,uDiv:f,x:g,y,z:k,w:C}=e;let{p:d,q:p,r:b,s:D,t:M,u:S}=e;n&&(d/=s,p/=r,b/=o,D/=c,M/=l,S/=f);const a={coxeter:t===3?[[-1,d,p],[d,-1,b],[p,b,-1]]:t===4?[[-1,d,p,b],[d,-1,D,M],[p,D,-1,S],[b,M,S,-1]]:null,vertices:[],edges:[],words:new Map,edgeHashes:new Set,vertexHashes:new Set,wordsToConsider:[""],rootVertices:null,rootVertex:null};a.gram=a.coxeter.map(B=>B.map(j=>-L(I/j))),se({curvature:oe(a.gram)}),a.mirrors=le(a.gram),a.rootVertices=a.mirrors.map((B,j)=>q(a.mirrors,new Array(t).fill(0).map((Me,ge)=>j===ge?a.curvature||1:0))),a.rootVertex=q(a.mirrors,[g?1:0,y?1:0,k?1:0,C?1:0]),a.words.set("",a.rootVertex),a.rules=te(t,e.p,e.q,e.r,e.s,e.t,e.u),J(a)},A=(e,t,n)=>{const s=String.fromCharCode(97+t);if(e.slice(-1)===s)return;const r=ne(e+s);if(i.words.has(r)){const c=i.words.get(r);W(e,r,n,c);return}const o=ue(r);return i.words.set(r,o),E(o,e),W(e,r,n,o),r},he=()=>{let e=[""],t,n=25;E(i.rootVertex,"");do{t=[];for(let s=0;s<i.wordsToConsider.length;s++){const r=i.wordsToConsider[s],o=i.words.get(r);for(let c=0;c<u.dimensions-1;c++){const l=A(r,c,o);l&&t.push(l)}}e.push(...t),i.wordsToConsider=t}while(t.length&&n--);if(n<0)throw new Error("Could not tile fundamental chamber");i.wordsToConsider=e},fe=()=>{let e;e=[];for(let t=0;t<i.wordsToConsider.length;t++){const n=i.wordsToConsider[t],s=i.words.get(n);for(let r=0;r<u.dimensions;r++){const o=A(n,r,s);o&&e.push(o)}}i.wordsToConsider=e};function E(e,t){const n=v(e);i.vertexHashes.has(n)||(i.vertexHashes.add(n),i.vertices.push({vertex:e,word:t}))}function W(e,t,n,s){const r=e.length<t.length||e.length===t.length&&e<t?v(n)+"/"+v(s):v(s)+"/"+v(n);if(!i.edgeHashes.has(r)&&(i.edgeHashes.add(r),!ae(n,s))){const o=n.slice(),c=s.slice();return i.edges.push({start:o,end:c,word:e,newWord:t}),!0}}onmessage=({data:{C:e,order:t,uuid:n}})=>{try{if(F(e),t===0){O(e);try{he()}catch(s){s.message==="Could not tile fundamental chamber"&&O(e)}}else i.vertices=[],i.edges=[],fe();postMessage({R:h,vertices:i.vertices,edges:i.edges,uuid:n})}catch(s){throw s.uuid=n,s}}})();
