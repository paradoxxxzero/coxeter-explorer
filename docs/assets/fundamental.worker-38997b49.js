(function(){"use strict";const U=(t,e)=>{const n=[];for(let r=0;r<e.length;r++){let l=0;for(let o=0;o<e[0].length;o++)l+=e[r][o]*t[o];n.push(l)}return n},W=t=>new Array(t).fill().map((e,n)=>new Array(t).fill().map((r,l)=>n===l?1:0)),E=t=>{const e=t.length,n=[];for(let r=0;r<e;r++)n.push([...t[r],...W(e)[r]]);for(let r=0;r<e;r++){const l=n[r][r];for(let o=r+1;o<e;o++){const s=n[o][r]/l;for(let a=r;a<2*e;a++)n[o][a]-=s*n[r][a]}}for(let r=e-1;r>=0;r--){const l=n[r][r];for(let o=r-1;o>=0;o--){const s=n[o][r]/l;for(let a=0;a<2*e;a++)n[o][a]-=s*n[r][a]}for(let o=e;o<2*e;o++)n[r][o]/=l}return n.map(r=>r.slice(e))},D=(t,e,n)=>{let r=0;for(let l=0;l<t.length;l++)r+=t[l]*e[l]*(l===t.length-1&&n||1);return r},G=(t,e)=>D(t,t,e),J=(t,e,n)=>{t=t.slice();const r=2*D(t,e,n);for(let l=0;l<t.length;l++)t[l]-=r*(n||l!==t.length-1?e[l]:0);return t},K=(t,e)=>{if(t=t.slice(),e===0){for(let r=0;r<t.length;r++)t[r]/=t[t.length-1];return t}const n=(e===-1&&Z(t[t.length-1])||1)/Y(F(G(t,e)));for(let r=0;r<t.length;r++)t[r]*=n;return t},Q=(t,e,n)=>{const r=t.map(o=>isNaN(o)?1:+o),l=U(r,E(e));return l[l.length-1]*=n||1,K(l,n)},C=(t,e,n,r)=>{const l=S/t,o=S/e,s=S/n;return N(S/X(-V(l)*V(s)+H(l)*H(s)*((V(o)-V(r*l)*V(s))/(H(r*l)*H(s)))))},{abs:F,cos:V,sin:H,tan:fe,cosh:ce,sinh:he,acos:X,acosh:ge,atan:ue,min:pe,max:de,round:N,sqrt:Y,sign:Z,ceil:me,floor:ye,log:Ae,exp:be,PI:S}=Math,O=new ArrayBuffer(8),z=new Float64Array(O),R=new Int32Array(O);function v(t){return~~t===t?~~t:(z[0]=t,R[0]^R[1])}const q=10**4,ee=t=>{let e="";for(let n=0;n<t.length;n++)e+=v(N(t[n]*q)/q).toString(),n<t.length-1&&(e+="|");return e};function*te(t,e){if(e<0||t.length<e)return;const n=Array.from(Array(e).keys());for(;;){yield n.map(l=>t[l]);let r=e-1;for(;r>=0&&n[r]>=t.length-e+r;)r--;if(r<0)return;for(let l=n[r]+1;r<e;r++,l++)n[r]=l}}const L=(t,e=2)=>Array.from(te(t,e)),u=t=>String.fromCharCode(97+t),ne=(t,e,n,r,l)=>{const o=[];for(let s=0;s<t;s++)o.push(u(s).repeat(2));for(let s=1;s<t;s++)for(let a=0;a<s;a++)e[s][a]<1/0&&o.push((u(a)+u(s)).repeat(e[s][a]));if(n&&!n.every(s=>s.every(a=>a===1))&&l>0){if(t===4&&(n[0][1]>1||n[2][3]>1)&&e[0][1]>3&&e[2][3]>3)n[0][1]>1&&o.push("abcdcb".repeat(C(e[0][1],e[1][2],e[0][2],n[0][1]))),n[2][3]>1&&o.push("abcdcb".repeat(C(e[2][3],e[1][2],e[1][3],n[2][3])));else for(let s=1;s<t;s++)for(let a=0;a<s;a++)if(n[a][s]>1){if(a+2<t){const c=C(e[a][s],e[a+1][s+1],e[a][s+1],n[a][s]);o.push((u(a)+u(s)+u(a+2)+u(s)).repeat(c))}if(a-1>=0){const c=C(e[a][s],e[a-1][s-1],e[a-1][s],n[a][s]);o.push((u(a)+u(s)+u(a)+u(a-1)).repeat(c))}}}return o},re=(t,e,n,r,l)=>{const o=ne(t,e,n,r,l),s=[...Array(t).keys()].map(c=>u(c)).join(""),a=r.map((c,j)=>c?"":u(F(j))).join("");return{gens:s,subgens:a,rels:o}},le=(t,e)=>{if(e.left===e.right)return!1;for(;e.left!==e.right;){const n=t.normal[e.left_coset][e.rel[e.left]];if(n===void 0)break;e.left++,e.left_coset=n}for(;e.left!==e.right;){const n=t.reverse[e.right_target][e.rel[e.right]];if(n===void 0)break;e.right--,e.right_target=n}return e.left===e.right?(t.normal[e.left_coset][e.rel[e.right]]=e.right_target,t.reverse[e.right_target][e.rel[e.right]]=e.left_coset,!0):!1},se=t=>{const{gens:e,subgens:n,rels:r,cosets:l,rows:o,words:s,limit:a}=t,c=e.length,j=r.map(i=>[...i].map(m=>e.indexOf(m))),_=n.split("").map(i=>e.indexOf(i));if(l.normal.length===0){l.normal.push(new Array(c).fill()),l.reverse.push(new Array(c).fill());for(let i=0;i<_.length;i++)l.normal[0][_[i]]=0,l.reverse[0][_[i]]=0}for(o.length===0&&o.push(...j.map(i=>({rel:i,left:0,right:i.length-1,left_coset:0,right_target:0})));o.length&&l.normal.length<a;){for(;;){let f=!1;for(let h=o.length-1;h>=0;h--)le(l,o[h])&&(f=!0,o.splice(h,1));if(!f)break}const i=l.normal.length;let m=!1;for(let f=0;f<l.normal.length;f++){const h=l.normal[f];for(let d=0;d<h.length;d++){let g=h[d];if(g===void 0){g=l.normal.length,l.normal.push(new Array(c).fill()),l.reverse.push(new Array(c).fill()),l.normal[f][d]=g,l.reverse[g][d]=f,o.push(...j.map(y=>({rel:y,left:0,right:y.length-1,left_coset:i,right_target:i}))),m=!0;break}}if(m)break}}o.length||(t.done=!0),s.length===0&&(s[0]="");let w=!0,p=l.normal.length;for(;oe(l.normal.length,s)&&w&&--p;){w=!1;for(let i=0;i<s.length;i++){if(s[i]===void 0)continue;const m=l.normal[i];for(let f=0;f<m.length;f++){const h=m[f];h===void 0||s[h]!==void 0||(s[h]=s[i]+u(f),w=!0)}}}return w||console.warn("Hole in the cosets"),p===0&&console.warn("Max iterations reached"),{cosets:l,rows:o,words:s}},oe=(t,e)=>{for(let n=0;n<t;n++)if(e[n]===void 0)return!0;return!1};let b=null,x=null,P=null,B=null,M=null,$=0;const ae=(t,e,n,r,l,o)=>{const s=()=>({cosets:{normal:[],reverse:[]},rows:[],words:[],done:!1,lastDrawn:0});x=new Array(t).fill().map((a,c)=>Q(new Array(t).fill().map((j,_)=>_===c?1:0),l,o)),b={...re(t,e,n,new Array(t).fill(1),o),...s()},P=new Map,B=new Set,M=new Set,$=0},ie=(t,e)=>{const{rootVertex:n,mirrorsPlanes:r,curvature:l}=t;let o=n;for(let s=0;s<e.length;s++)o=J(o,r[e.charCodeAt(s)-97],l);return o};onmessage=({data:{order:t,curvature:e,mirrorsPlanes:n,coxeter:r,stellation:l,mirrors:o,rootVertex:s,dimensions:a,uuid:c}})=>{t===0&&ae(a,r,l,o,n,e);const j=t===0?1:(t+1)*10,_=L(new Array(x.length).fill().map((p,i)=>i)),w=L(new Array(x.length).fill().map((p,i)=>i),3);try{let p=[],i=[],m=[];if(!b.done){b.limit=j,se(b);for(let f=b.lastDrawn;f<b.words.length;f++){const h=b.words[f];if(h===void 0)continue;const d=[];for(let g=0;g<x.length;g++){const y=x[g],k=ie({rootVertex:y,mirrorsPlanes:n,curvature:e},h),A=ee(k);if(P.has(A))d.push(P.get(A));else{p.push({vertex:k,word:h,i:f});const I=$+p.length-1;P.set(A,I),d.push(I)}}b.lastDrawn=f+1;for(let g=0;g<_.length;g++){const[y,k]=_[g],[A,I]=[d[y],d[k]],T=y<k?`${A}-${I}`:`${I}-${A}`;B.has(T)||(i.push({start:A,end:I,word:h}),B.add(T))}for(let g=0;g<w.length;g++){const y=w[g].map(A=>d[A]),k=y.sort().join("-");M.has(k)||(m.push({vertices:y,word:h}),M.add(k))}}}$+=p.length,postMessage({vertices:p,edges:i,faces:m,order:t,uuid:c})}catch(p){postMessage({error:p.message,uuid:c})}}})();
