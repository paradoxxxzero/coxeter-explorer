(function(){"use strict";const $=(e,n)=>{let t=0;for(let r=0;r<e.length;r++)t+=e[r]*n[r];return t},X=(e,n)=>{const t=[];for(let r=0;r<e.length;r++)t[r]=e[r]-n[r];return t},V=(e,n)=>{const t=[];for(let r=0;r<e.length;r++)t[r]=e[r]*n;return t},M=(e,n)=>{const t=new Array(e.length);for(let r=0;r<e.length;r++){let s=0;for(let o=0;o<e[0].length;o++)s+=e[r][o]*n[o];t[r]=s}return t},Y=(e,n,t)=>X(e,V(M(te(t),n),2*$(M(ee(t),e),n))),Z=(e,n)=>n.some((t,r)=>t.some((s,o)=>r===o&&s===0))?V(e,1/e[e.length-1]):V(e,-1/re(O($(M(n,e),e)))),ee=e=>e.map((n,t)=>n.map((r,s)=>t===s&&r===0?1:r)),te=e=>e.map(n=>n.map(t=>O(t))),C=(e,n,t,r)=>{const s=j/e,o=j/n,c=j/t;return I(j/ne(-y(s)*y(c)+S(s)*S(c)*((y(o)-y(r*s)*y(c))/(S(r*s)*S(c)))))},{abs:O,cos:y,sin:S,tan:ve,cosh:Be,sinh:Te,acos:ne,acosh:Ae,atan:Re,atan2:ze,min:Ve,max:Ee,round:I,sqrt:re,sign:We,ceil:_e,floor:$e,log:Oe,exp:F,hypot:Ie,pow:Fe,PI:j}=Math,H=new ArrayBuffer(8),se=new Float64Array(H),N=new Int32Array(H);function oe(e){return~~e===e?~~e:(se[0]=e,N[0]^N[1])}const P=10**4,ce=e=>{let n="";for(let t=0;t<e.length;t++)n+=oe(I(e[t]*P)/P).toString(),t<e.length-1&&(n+="|");return n},f=e=>String.fromCharCode(97+e),le=(e,n,t,r=[])=>{const s=[];for(let o=0;o<e;o++)r.includes(o)||s.push(f(o).repeat(2));for(let o=1;o<e;o++)for(let c=0;c<o;c++)!r.includes(o)&&!r.includes(c)&&n[o][c]>1&&s.push((f(c)+f(o)).repeat(n[o][c]));if(!r.length&&t&&!t.every(o=>o.every(c=>c===1))){if(e===4&&t[0][1]>1!=t[2][3]>1&&n[0][1]>3&&n[2][3]>3)t[0][1]>1&&s.push("abcdcb".repeat(C(n[0][1],n[1][2],n[0][2],t[0][1]))),t[2][3]>1&&s.push("abcdcb".repeat(C(n[2][3],n[1][2],n[1][3],t[2][3])));else for(let o=1;o<e;o++)for(let c=0;c<o;c++)if(t[c][o]>1){if(c+2<e){const l=C(n[c+1][o+1],n[c][o],n[c][o+1],t[c][o]);s.push((f(c)+f(o)+f(c+2)+f(o)).repeat(l))}if(c-1>=0){const l=C(n[c-1][o-1],n[c][o],n[c-1][o],t[c][o]);s.push((f(c)+f(o)+f(c)+f(c-1)).repeat(l))}}}return s},ie=(e,n,t,r)=>Object.fromEntries(le(e,n,null).map(s=>[s,""])),q=(e,n)=>{const t=e.length-n.length;return t!==0?Math.sign(t):e<=n?-1:1},L=e=>e.split("").reverse().join(""),ue=(e,n)=>{const t=e.length-n.length;return t!==0?Math.sign(t):q(L(e),L(n))},fe=(e,n)=>{const t=new Map,r=Object.keys(e).sort(n);for(let s=0;s<r.length;s++){const o=r[s],[c,l]=[o,e[o]].sort(n);t.has(l)?t.set(l,[c,t.get(l)].sort()[0]):t.set(l,c)}return t},x=(e,n)=>{if(n.length===0||e.size===0)return n;const t=e._re_cache||new RegExp([...e.keys()].join("|"),"g");let r=n;do n=r,r=n.replace(t,s=>e.get(s));while(r!==n);return n},ae=(e,n)=>{const t=new Map(e);for(e=[...e.entries()];e.length>0;){G();const[r,s]=e.pop();t.delete(r);const o=x(t,r),c=x(t,s);let l=!0;if(o===c)l=!1;else{const[i,h]=[o,c].sort(n);h!==r&&i!==s&&(t.set(h,i),e.push([h,i]),l=!1)}l&&t.set(r,s)}return t},he=function(e,n){if(n.length===0)return null;const t=Math.max(0,e.length-n.length);for(let r=t;r<e.length;r++)if(e[r]===n[0]&&e.slice(r+1)===n.slice(1,e.length-r))return{prefix:e.slice(0,r),suffix:n.slice(e.length-r)}},ge=function(e,n){if(n.length===0)return null;for(let t=0;t<e.length-n.length+1;t++)if(e.slice(t,t+n.length)===n)return{prefix:e.slice(0,t),suffix:e.slice(t+n.length)}},pe=(e,n,t,r)=>{const s=he(e,t);if(s)return{s1:s.prefix+r,s2:n+s.suffix};const o=ge(e,t);if(o)return{s1:n,s2:o.prefix+r+o.suffix}},we=(e,n)=>{const t=new Map(e),r=[...e.entries()];for(let s=0;s<r.length;s++){G();const[o,c]=r[s];for(let l=0;l<r.length;l++){if(s===l)continue;const[i,h]=r[l],u=pe(o,c,i,h);if(u){const a=x(e,u.s1),p=x(e,u.s2);if(a!==p){const[R,z]=[a,p].sort(n);t.set(z,R)}}}}return t},de=(e,n)=>we(ae(e,n),n),me=(e,n)=>{if(e.size!==n.size)return!1;const t=e.keys();for(;;){const{done:r,value:s}=t.next();if(r)return!0;if(e.get(s)!==n.get(s))return!1}},be=(e,n)=>{for(e=fe(e,n);;){const t=de(e,n);if(me(t,e))return t._re_cache=new RegExp([...t.keys()].join("|"),"g"),t;e=t}};let K,D;const G=()=>{if(performance.now()-K>D)throw new Error("Timeout")},ye=(e,n)=>{const t=[50,100,F(n)*4,F(n)*10].map(r=>[r,r]).flat();for(let r=0;r<t.length;r++){D=t[r];try{return K=performance.now(),be(e,r%2?q:ue)}catch(s){if(s.message!=="Timeout")throw s}}throw new Error("Timeout")},k=(e,n)=>x(e,n),xe=e=>e==="s"||e==="b",Me=e=>isNaN(e)?1:+e;let v=new Map,E=new Set,w=[],B=[],W=[],_=0,d=new Map,m=[],T=null,b=!1,g=null;const J=(e,n,t)=>{_=0,w=[],B=[],W=[],v.clear(),E.clear(),d.clear(),d.set("",Q("",e)),m=[""],T=t,g=n;const r=T.map((s,o)=>xe(s)?f(o):"").join("");b=r.length>0?new RegExp(`[^${r}]`,"g"):null},Ce=(e,n)=>{const{rootVertex:t,rootNormals:r,metric:s}=e;let o=t;for(let c=n.length-1;c>=0;c--)o=Y(o,r[n.charCodeAt(c)-97],s);return o};function Q(e,n){const t=ce(n);if(v.has(t))return v.get(t);{const r=_+w.length;return v.set(t,r),w.push({vertex:n,word:e}),r}}function U(e,n){const t=d.get(e),r=d.get(n);if(t===r)return;const s=t>r?`${r}-${t}`:`${t}-${r}`;if(!E.has(s))return E.add(s),B.push({start:t,end:r,word:e,newWord:n}),!0}const A=(e,n,t)=>{if(n===t)return;if(d.has(t)){U(n,t);return}const r=Ce(e,t),s=Q(t,r);return d.set(t,s),U(n,t),t},Se=e=>{const{dimensions:n}=e;let t;t=[];for(let r=0;r<m.length;r++){const s=m[r];for(let o=0;o<n;o++){const c=f(o),l=k(g,s+c);if(b&&l.replace(b,"").length%2)for(let i=0;i<T.length;i++){const h=f(i),u=k(g,l+h);if(u.replace(b,"").length%2)for(let a=0;a<T.length;a++){const p=f(a),R=k(g,u+p);if(R.replace(b,"").length%2)continue;const z=A(e,s,R);z&&t.push(z)}else{const a=A(e,s,u);a&&t.push(a)}}else{const i=A(e,s,l);i&&t.push(i)}}}return t},je=e=>{const{dimensions:n}=e;let t=[""],r;const s=1e4;let o=m;do{r=[];for(let c=0;c<o.length;c++){const l=o[c];for(let i=0;i<n-1;i++){const h=f(i),u=k(g,l+h),a=A(e,l,u);a&&r.push(a)}}t=t.concat(r),o=r}while(r.length&&t.length<=s);if(t.length>s)throw new Error("Could not tile fundamental chamber");return t};onmessage=({data:{order:e,metric:n,coxeter:t,stellation:r,mirrors:s,rootNormals:o,rootVertices:c,dimensions:l,uuid:i}})=>{const h=Z(M(c,s.map(u=>Me(u))),n);try{let u=!1;if(e===0){const a=ie(l,t,r,s,n);try{g=ye(a,l)}catch(p){console.warn(p),g=new Map(Object.entries(a))}if(J(h,g,s),b||g.size<=l)u=!0;else try{m=je({metric:n,rootNormals:o,rootVertex:h,dimensions:l})}catch(p){u=!0,J(h,g,s),console.warn(p)}}(e>0||u)&&(m=Se({metric:n,rootNormals:o,rootVertex:h,dimensions:l})),postMessage({vertices:w,edges:B,faces:W,order:e,uuid:i}),_+=w.length,w=[],B=[],W=[]}catch(u){postMessage({error:u.message,uuid:i})}}})();
